<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DB Pro Master v24.21 (Ultimate Final)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; 
            --primary-dark: #1e40af; 
            --bg-light: #f1f5f9; 
            --border: #e2e8f0; 
            --text: #334155; 
            --danger: #ef4444; 
            --success: #10b981; 
            --prospect: #8b5cf6;
            --warning: #f59e0b;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; margin: 0; background: var(--bg-light); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: #fecaca; }
        .btn-dark { background: #1e293b; color: white; }
        .btn-dark:hover { background: #334155; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #64748b; }
        .btn-secondary:hover { background: #f8fafc; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-prospect { background: var(--prospect); color: white; }
        .btn-prospect:hover { background: #7c3aed; }

        input, select, textarea { font-family: inherit; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="date"] { cursor: pointer; position: relative; }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .login-box h1 { margin: 0 0 8px 0; font-size: 28px; color: #1e293b; }
        .login-box p { margin: 0 0 30px 0; color: #64748b; font-size: 14px; }
        .login-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 12px; font-size: 15px; transition: all 0.2s; }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .login-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        #login-loading { display: none; margin-bottom: 15px; }

        .sidebar { width: 260px; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { margin: 0; font-size: 20px; font-weight: 700; }
        .sidebar-header small { color: #94a3b8; font-size: 12px; }
        .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; color: #94a3b8; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 20px; text-align: center; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 16px 0; }
        .sidebar-footer { padding: 16px 12px; border-top: 1px solid rgba(255,255,255,0.1); }
        .btn-new-db { width: 100%; background: var(--success); margin-bottom: 8px; }
        .btn-team-manage { width: 100%; background: var(--prospect); margin-bottom: 8px; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-top: 12px; }
        .user-avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .user-details { flex: 1; }
        .user-details .name { font-weight: 600; font-size: 14px; }
        .user-details .role { font-size: 12px; color: #94a3b8; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { background: white; padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 10px 16px 10px 40px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; transition: all 0.2s; }
        .search-box input:focus { border-color: var(--primary); }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .filter-group { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .filter-group select { padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; cursor: pointer; background: white; }
        .filter-group select:focus { border-color: var(--primary); }

        .content-area { flex: 1; padding: 24px; overflow-y: auto; }
        .dynamic-section { display: none; }
        .dynamic-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .db-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .db-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border-left: 4px solid var(--primary); }
        .db-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .db-card.status-계약 { border-left-color: var(--success); }
        .db-card.status-가망 { border-left-color: var(--prospect); }
        .db-card.status-철회 { border-left-color: var(--danger); }
        .db-card.status-진행중 { border-left-color: var(--warning); }
        .db-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .db-card-title { font-weight: 700; font-size: 16px; color: #1e293b; }
        .db-card-status { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-badge-계약 { background: #d1fae5; color: #059669; }
        .status-badge-가망 { background: #ede9fe; color: #7c3aed; }
        .status-badge-철회 { background: #fee2e2; color: #dc2626; }
        .status-badge-진행중 { background: #fef3c7; color: #d97706; }
        .db-card-info { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .db-card-info i { width: 16px; margin-right: 6px; }
        .db-card-amount { font-size: 18px; font-weight: 700; color: var(--primary); }
        .db-card-memo { margin-top: 10px; padding: 8px 10px; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b; border-left: 3px solid var(--warning); }
        .db-card-meeting { margin-top: 8px; padding: 6px 10px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e; display: flex; align-items: center; gap: 6px; }
        .db-card-meeting.urgent { background: #fee2e2; color: #dc2626; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .modal-close:hover { background: #f1f5f9; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; display: flex; gap: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .panel-left { flex: 1; }
        .panel-right { width: 320px; background: #f8fafc; border-radius: 12px; padding: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #475569; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

        .share-section { margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 10px; }
        .share-section h4 { margin: 0 0 12px 0; font-size: 14px; color: #0369a1; }
        .share-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .share-row select { flex: 2; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; }
        .share-row input[type="text"] { width: 70px; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; font-size: 13px; }
        .share-val { min-width: 90px; text-align: right; font-weight: 600; font-size: 13px; color: #0369a1; }
        .share-row .btn { padding: 8px 12px; font-size: 12px; }

        .activity-section { margin-top: 20px; }
        .activity-section h4 { margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .activity-input { display: flex; gap: 8px; margin-bottom: 12px; }
        .activity-input input { flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 13px; }
        .activity-list { max-height: 200px; overflow-y: auto; }
        .activity-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .activity-item.new-log { background: #fef3c7; border-left: 3px solid var(--warning); }
        .activity-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
        .activity-content { flex: 1; }
        .activity-time { font-size: 11px; color: #94a3b8; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card.primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .stat-card.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; }
        .stat-card.warning { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); color: white; }
        .stat-card.prospect { background: linear-gradient(135deg, var(--prospect) 0%, #7c3aed 100%); color: white; }
        .stat-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 12px; }
        .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 13px; opacity: 0.9; }

        .chart-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-title { font-weight: 700; font-size: 16px; }

        .ranking-list { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ranking-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-num { width: 28px; height: 28px; background: var(--bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; }
        .ranking-item:nth-child(1) .ranking-num { background: #fef3c7; color: #d97706; }
        .ranking-item:nth-child(2) .ranking-num { background: #e2e8f0; color: #64748b; }
        .ranking-item:nth-child(3) .ranking-num { background: #fed7aa; color: #c2410c; }
        .ranking-name { flex: 1; font-weight: 600; }
        .ranking-value { font-weight: 700; color: var(--primary); }

        .progress-bar-bg { height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.3s ease; }

        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .analysis-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .analysis-card h4 { margin: 0 0 16px 0; font-size: 15px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .yoy-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .yoy-item:last-child { border-bottom: none; }
        .yoy-change { font-weight: 700; }
        .yoy-change.positive { color: var(--success); }
        .yoy-change.negative { color: var(--danger); }

        .roadmap-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .roadmap-popup.active { display: flex; }
        .roadmap-container { background: white; border-radius: 16px; width: 100%; max-width: 1100px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .roadmap-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; }
        .roadmap-header h3 { margin: 0; }
        .roadmap-body { padding: 24px; overflow-y: auto; flex: 1; }
        .roadmap-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; gap: 12px; }

        .rm-timeline { position: relative; padding-left: 30px; }
        .rm-item { position: relative; padding: 16px 20px; background: #f8fafc; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid var(--primary); cursor: move; transition: all 0.2s; }
        .rm-item:hover { background: #f1f5f9; }
        .rm-item.dragging { opacity: 0.5; transform: scale(1.02); }
        .rm-item::before { content: ''; position: absolute; left: -22px; top: 24px; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px var(--primary); }
        .rm-item.done { border-left-color: var(--success); }
        .rm-item.done::before { background: var(--success); box-shadow: 0 0 0 2px var(--success); }
        .rm-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .rm-item-title { font-weight: 700; font-size: 15px; }
        .rm-item-date { font-size: 12px; color: #64748b; }
        .rm-item-content { font-size: 14px; color: #475569; }
        .rm-item-actions { display: flex; gap: 8px; margin-top: 12px; }
        .rm-progress { margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; }
        .rm-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .rm-progress-text { font-weight: 700; color: #0369a1; }
        .rm-add-form { margin-top: 20px; padding: 20px; background: #fffbeb; border-radius: 10px; border: 2px dashed #fbbf24; }
        .rm-add-form h4 { margin: 0 0 16px 0; color: #92400e; }

        .rm-bar-container { margin-top: 16px; }
        .rm-bar-item { margin-bottom: 12px; }
        .rm-bar-label { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .rm-bar-outer { background: #e2e8f0; border-radius: 20px; height: 24px; overflow: hidden; position: relative; }
        .rm-bar-inner { height: 100%; border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; font-size: 11px; font-weight: 700; color: white; transition: width 0.5s ease; }
        .rm-bar-inner.done { background: linear-gradient(90deg, var(--success), #34d399); }
        .rm-bar-inner.progress { background: linear-gradient(90deg, var(--primary), #60a5fa); }
        .rm-bar-inner.pending { background: linear-gradient(90deg, #94a3b8, #cbd5e1); }
        .rm-bar-outer-text { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; color: #64748b; }

        /* 팀 관리 모달 스타일 */
        .team-modal { max-width: 700px; }
        .team-list { max-height: 400px; overflow-y: auto; }
        .team-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; }
        .team-item:hover { background: #f1f5f9; }
        .team-avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .team-info { flex: 1; }
        .team-name { font-weight: 600; font-size: 14px; }
        .team-role { font-size: 12px; color: #64748b; }
        .team-actions { display: flex; gap: 8px; }
        .team-add-form { margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 10px; border: 2px dashed var(--success); }
        .team-add-form h4 { margin: 0 0 16px 0; color: #166534; display: flex; align-items: center; gap: 8px; }

        /* 로드맵 인쇄 스타일 */
        .print-preview-modal { max-width: 900px; }
        .print-preview-content { padding: 40px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; }
        .print-preview-content h2 { text-align: center; margin-bottom: 30px; color: #1e293b; }
        .print-item { padding: 16px; margin-bottom: 16px; border-left: 4px solid var(--primary); background: #f8fafc; border-radius: 0 8px 8px 0; }
        .print-item.done { border-left-color: var(--success); background: #f0fdf4; }
        .print-item-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
        .print-item-date { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .print-item-content { font-size: 14px; color: #475569; }

        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .no-print { display: none !important; }
        }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; gap: 16px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: #1e293b; color: white; border-radius: 10px; font-weight: 600; z-index: 10000; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .meeting-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #fee2e2; color: #dc2626; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-state i { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { margin: 0 0 8px 0; color: #64748b; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; z-index: 100; transition: left 0.3s; height: 100%; }
            .sidebar.open { left: 0; }
            .mobile-toggle { display: flex !important; }
            .modal-body { flex-direction: column; }
            .panel-right { width: 100%; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .filter-group { flex-wrap: wrap; }
        }
        .mobile-toggle { display: none; position: fixed; top: 16px; left: 16px; z-index: 101; width: 44px; height: 44px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; align-items: center; justify-content: center; }
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
        .mobile-overlay.active { display: block; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1>DB Pro Master</h1>
            <p>v24.21 Ultimate Final Edition</p>
            <div id="login-loading"><div class="spinner" style="margin:0 auto;"></div></div>
            <input type="text" id="login-id" class="login-input" placeholder="아이디">
            <input type="password" id="login-pw" class="login-input" placeholder="비밀번호">
            <button class="login-btn" onclick="doLogin()">로그인</button>
        </div>
    </div>

    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>DB Pro Master</h2>
            <small>v24.21 Ultimate Final</small>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="switchView('list')"><i class="fas fa-database"></i> 내 DB 목록</div>
            <div class="nav-item" onclick="switchView('analysis')"><i class="fas fa-chart-line"></i> 실적 분석</div>
            <div class="nav-item" onclick="switchView('roadmap')"><i class="fas fa-road"></i> 로드맵 관리</div>
            <div class="nav-divider"></div>
            <div class="nav-item" onclick="switchView('dashboard')" id="nav-dashboard" style="display:none;"><i class="fas fa-tachometer-alt"></i> 관리자 대시보드<span id="meeting-alert-badge" class="meeting-badge" style="display:none;"><i class="fas fa-bell"></i> <span id="meeting-alert-count">0</span></span></div>
            <div class="nav-item" onclick="switchView('admin-analysis')" id="nav-admin-analysis" style="display:none;"><i class="fas fa-chart-pie"></i> 전체 실적 분석</div>
        </nav>
        <div class="sidebar-footer">
            <button class="btn btn-new-db" onclick="openModal()"><i class="fas fa-plus"></i> 새 DB 등록</button>
            <button class="btn btn-team-manage" onclick="openTeamModal()" id="btn-team" style="display:none;"><i class="fas fa-users-cog"></i> 팀원 관리</button>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="name" id="user-name">사용자</div>
                    <div class="role" id="user-role">팀원</div>
                </div>
                <button class="btn btn-secondary" onclick="doLogout()" style="padding:8px;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <button class="btn btn-secondary" onclick="openPwModal()" style="width:100%; margin-top:8px;"><i class="fas fa-key"></i> 비밀번호 변경</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="업체명, 상품, 메모 검색..." oninput="renderList()">
            </div>
            <div class="filter-group">
                <select id="filter-year" onchange="renderList()"></select>
                <select id="filter-month" onchange="renderList()">
                    <option value="">전체 월</option>
                    <option value="1">1월</option><option value="2">2월</option><option value="3">3월</option>
                    <option value="4">4월</option><option value="5">5월</option><option value="6">6월</option>
                    <option value="7">7월</option><option value="8">8월</option><option value="9">9월</option>
                    <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
                </select>
                <select id="filter-status" onchange="renderList()">
                    <option value="">전체 상태</option>
                    <option value="계약">계약</option><option value="가망">가망</option>
                    <option value="진행중">진행중</option><option value="철회">철회</option>
                </select>
                <select id="filter-source" onchange="renderList()">
                    <option value="">전체 출처</option>
                    <option value="자체">자체</option><option value="제휴">제휴</option>
                </select>
                <button class="btn btn-dark" onclick="exportExcel()"><i class="fas fa-file-excel"></i> 엑셀</button>
            </div>
        </div>

        <div class="content-area">
            <div id="view-list" class="dynamic-section active">
                <div class="db-grid" id="db-grid"></div>
            </div>

            <div id="view-analysis" class="dynamic-section">
                <div class="stats-grid" id="my-stats"></div>
                <div class="analysis-grid" id="my-analysis"></div>
            </div>

            <div id="view-roadmap" class="dynamic-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title"><i class="fas fa-tasks"></i> 나의 로드맵</span>
                        <button class="btn btn-primary" onclick="openRoadmapPopup()"><i class="fas fa-edit"></i> 로드맵 편집</button>
                    </div>
                    <div id="my-roadmap-summary"></div>
                </div>
            </div>

            <div id="view-dashboard" class="dynamic-section">
                <div class="stats-grid" id="admin-stats"></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <span class="chart-title"><i class="fas fa-chart-bar"></i> 월별 계약 현황</span>
                        </div>
                        <div id="admin-chart"></div>
                    </div>
                    <div class="ranking-list">
                        <h4 style="margin:0 0 16px 0;"><i class="fas fa-trophy"></i> 이번달 실적 랭킹</h4>
                        <div id="admin-ranking"></div>
                    </div>
                </div>
                <div class="chart-container" style="margin-top:20px;">
                    <div class="chart-header">
                        <span class="chart-title"><i class="fas fa-bell"></i> 미팅 알림 (D-7 이내)</span>
                    </div>
                    <div id="meeting-alerts"></div>
                </div>
            </div>

            <div id="view-admin-analysis" class="dynamic-section">
                <div class="top-bar" style="background:transparent; border:none; padding:0 0 20px 0;">
                    <select id="admin-analysis-member" onchange="renderAdminAnalysis()" style="padding:10px 14px; border:2px solid var(--border); border-radius:8px;">
                        <option value="">전체 팀원</option>
                    </select>
                    <select id="admin-analysis-year" onchange="renderAdminAnalysis()" style="padding:10px 14px; border:2px solid var(--border); border-radius:8px;"></select>
                </div>
                <div class="stats-grid" id="admin-analysis-stats"></div>
                <div class="analysis-grid" id="admin-analysis-grid"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">DB 등록</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="panel-left">
                    <input type="hidden" id="edit-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-building"></i> 업체명 *</label>
                            <input type="text" id="edit-company" placeholder="업체명 입력" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> 연락처</label>
                            <input type="text" id="edit-contact" placeholder="010-0000-0000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> 등록일</label>
                            <input type="date" id="edit-date">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-flag"></i> 상태</label>
                            <select id="edit-status">
                                <option value="가망">가망</option>
                                <option value="진행중">진행중</option>
                                <option value="계약">계약</option>
                                <option value="철회">철회</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-box"></i> 상품</label>
                            <input type="text" id="edit-product" placeholder="상품명">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-won-sign"></i> 계약금액</label>
                            <input type="text" id="edit-amount" placeholder="0" oninput="formatAmount(this); updateShareCalc();">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-industry"></i> 업종</label>
                            <select id="edit-industry">
                                <option value="">선택</option>
                                <option value="제조업">제조업</option>
                                <option value="건설업">건설업</option>
                                <option value="도소매">도소매</option>
                                <option value="음식점">음식점</option>
                                <option value="서비스">서비스</option>
                                <option value="IT">IT</option>
                                <option value="부동산">부동산</option>
                                <option value="운송">운송</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-link"></i> 출처</label>
                            <select id="edit-source">
                                <option value="자체">자체</option>
                                <option value="제휴">제휴</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-calendar-check"></i> 미팅 예정일</label>
                            <input type="date" id="edit-meeting">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-percent"></i> 순수익률 (%)</label>
                            <input type="text" id="edit-profit-rate" placeholder="0" oninput="updateShareCalc();">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> 메모</label>
                        <textarea id="edit-memo" rows="2" placeholder="메모 입력"></textarea>
                    </div>
                    <div class="share-section">
                        <h4><i class="fas fa-hand-holding-usd"></i> 쉐어 계산기</h4>
                        <div id="share-rows"></div>
                        <button class="btn btn-secondary" onclick="addShareRow()" style="margin-top:8px;"><i class="fas fa-plus"></i> 파트너 추가</button>
                        <div style="margin-top:12px; padding-top:12px; border-top:1px dashed #93c5fd;">
                            <div style="display:flex; justify-content:space-between; font-weight:700;">
                                <span>순수익:</span><span id="calc-profit">0원</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-right">
                    <div class="activity-section">
                        <h4><i class="fas fa-history"></i> 활동 로그</h4>
                        <div class="activity-input">
                            <input type="text" id="new-log" placeholder="새 활동 기록..." onkeypress="if(event.key==='Enter')addLog()">
                            <button class="btn btn-primary" onclick="addLog()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="activity-list" id="activity-list"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteData()" id="btn-delete" style="display:none;"><i class="fas fa-trash"></i> 삭제</button>
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" onclick="saveData()"><i class="fas fa-save"></i> 저장</button>
            </div>
        </div>
    </div>

    <!-- 팀원 관리 모달 -->
    <div class="modal-overlay" id="team-modal-overlay">
        <div class="modal team-modal">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> 팀원 관리</h3>
                <button class="modal-close" onclick="closeTeamModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex-direction:column;">
                <div class="team-list" id="team-list"></div>
                <div class="team-add-form">
                    <h4><i class="fas fa-user-plus"></i> 새 팀원 추가</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>아이디</label>
                            <input type="text" id="new-member-id" placeholder="아이디">
                        </div>
                        <div class="form-group">
                            <label>이름</label>
                            <input type="text" id="new-member-name" placeholder="이름">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>비밀번호</label>
                            <input type="password" id="new-member-pw" placeholder="비밀번호">
                        </div>
                        <div class="form-group">
                            <label>역할</label>
                            <select id="new-member-role">
                                <option value="member">팀원</option>
                                <option value="admin">관리자</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addMember()" style="width:100%;"><i class="fas fa-user-plus"></i> 팀원 추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div class="modal-overlay" id="pw-modal-overlay">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>비밀번호 변경</h3>
                <button class="modal-close" onclick="closePwModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex-direction:column;">
                <div class="form-group">
                    <label>현재 비밀번호</label>
                    <input type="password" id="current-pw">
                </div>
                <div class="form-group">
                    <label>새 비밀번호</label>
                    <input type="password" id="new-pw">
                </div>
                <div class="form-group">
                    <label>새 비밀번호 확인</label>
                    <input type="password" id="confirm-pw">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePwModal()">취소</button>
                <button class="btn btn-primary" onclick="changePw()">변경</button>
            </div>
        </div>
    </div>

    <!-- 로드맵 팝업 -->
    <div class="roadmap-popup" id="roadmap-popup">
        <div class="roadmap-container">
            <div class="roadmap-header">
                <h3><i class="fas fa-road"></i> 로드맵 편집</h3>
                <button class="modal-close" onclick="closeRoadmapPopup()" style="color:white;">&times;</button>
            </div>
            <div class="roadmap-body">
                <div class="rm-progress">
                    <div class="rm-progress-header">
                        <span class="rm-progress-text">전체 진행률</span>
                        <span class="rm-progress-text" id="rm-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="rm-progress-bar" style="width:0%"></div>
                    </div>
                </div>
                <div class="rm-bar-container" id="rm-bar-container"></div>
                <div class="rm-timeline" id="rm-timeline"></div>
                <div class="rm-add-form">
                    <h4><i class="fas fa-plus-circle"></i> 새 항목 추가</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>제목</label>
                            <input type="text" id="rm-new-title" placeholder="항목 제목">
                        </div>
                        <div class="form-group">
                            <label>목표일</label>
                            <input type="date" id="rm-new-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>내용</label>
                        <textarea id="rm-new-content" rows="2" placeholder="상세 내용"></textarea>
                    </div>
                    <button class="btn btn-warning" onclick="addRoadmapItem()" style="width:100%;"><i class="fas fa-plus"></i> 항목 추가</button>
                </div>
            </div>
            <div class="roadmap-footer">
                <div>
                    <button class="btn btn-secondary" onclick="previewRoadmapPrint()"><i class="fas fa-eye"></i> 미리보기</button>
                    <button class="btn btn-dark" onclick="printRoadmap()"><i class="fas fa-print"></i> 인쇄</button>
                </div>
                <button class="btn btn-primary" onclick="saveRoadmap()"><i class="fas fa-save"></i> 저장</button>
            </div>
        </div>
    </div>

    <!-- 인쇄 미리보기 모달 -->
    <div class="modal-overlay" id="print-preview-modal">
        <div class="modal print-preview-modal">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> 인쇄 미리보기</h3>
                <button class="modal-close" onclick="closePrintPreview()">&times;</button>
            </div>
            <div class="modal-body" style="flex-direction:column;">
                <div class="print-preview-content" id="print-preview-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePrintPreview()">닫기</button>
                <button class="btn btn-primary" onclick="executePrint()"><i class="fas fa-print"></i> 인쇄하기</button>
            </div>
        </div>
    </div>

    <!-- 인쇄 영역 (숨김) -->
    <div id="print-area" class="print-area" style="display:none;"></div>

    <div class="loading-overlay" id="loading"><div class="spinner"></div><span>로딩 중...</span></div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbx3BhJhRdcrZsYcEKbQwA6HSCziWhdY7gbux82bh2xdjFHZi6BFxlvhcl7er8oW2VaXGg/exec';
    
    let currentUser = null;
    let allData = [];
    let allMembers = [];
    let currentLogs = [];
    let myRoadmap = [];
    let draggedItem = null;

    document.getElementById('login-pw').addEventListener('keypress', e => { if(e.key === 'Enter') doLogin(); });
    
    function showLoading() { document.getElementById('loading').classList.add('active'); }
    function hideLoading() { document.getElementById('loading').classList.remove('active'); }
    function showToast(msg, type = 'success') {
        const t = document.createElement('div');
        t.className = 'toast ' + type;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('open');
        document.querySelector('.mobile-overlay').classList.toggle('active');
    }

    function doLogin() {
        const id = document.getElementById('login-id').value.trim();
        const pw = document.getElementById('login-pw').value;
        if(!id || !pw) return showToast('아이디와 비밀번호를 입력하세요.', 'error');
        
        document.getElementById('login-loading').style.display = 'block';
        
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', id, pw }) })
        .then(r => r.json())
        .then(d => {
            document.getElementById('login-loading').style.display = 'none';
            if(d.success) {
                currentUser = d.user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role').textContent = currentUser.role === 'admin' ? '관리자' : '팀원';
                document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
                if(currentUser.role === 'admin') {
                    document.getElementById('nav-dashboard').style.display = 'flex';
                    document.getElementById('nav-admin-analysis').style.display = 'flex';
                    document.getElementById('btn-team').style.display = 'flex';
                }
                initFilters();
                fetchDB(() => renderList());
                fetchMembers();
                loadMyRoadmap();
            } else {
                showToast(d.message || '로그인 실패', 'error');
            }
        })
        .catch(e => {
            document.getElementById('login-loading').style.display = 'none';
            showToast('서버 연결 실패', 'error');
        });
    }

    function doLogout() {
        if(!confirm('로그아웃 하시겠습니까?')) return;
        currentUser = null;
        allData = [];
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('login-id').value = '';
        document.getElementById('login-pw').value = '';
    }

    function initFilters() {
        const yearSel = document.getElementById('filter-year');
        const curYear = new Date().getFullYear();
        yearSel.innerHTML = '<option value="">전체 연도</option>';
        for(let y = curYear; y >= curYear - 5; y--) {
            yearSel.innerHTML += `<option value="${y}" ${y === curYear ? 'selected' : ''}>${y}년</option>`;
        }
        
        const adminYearSel = document.getElementById('admin-analysis-year');
        if(adminYearSel) {
            adminYearSel.innerHTML = '';
            for(let y = curYear; y >= curYear - 5; y--) {
                adminYearSel.innerHTML += `<option value="${y}" ${y === curYear ? 'selected' : ''}>${y}년</option>`;
            }
        }
    }

    function fetchDB(callback) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'list' }) })
        .then(r => r.json())
        .then(d => {
            allData = d.data || [];
            if(callback) callback();
        })
        .catch(e => showToast('데이터 로딩 실패', 'error'));
    }

    function fetchMembers() {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'members' }) })
        .then(r => r.json())
        .then(d => {
            allMembers = d.members || [];
            updateMemberSelects();
        })
        .catch(e => console.error('멤버 로딩 실패'));
    }

    function updateMemberSelects() {
        const adminMemberSel = document.getElementById('admin-analysis-member');
        if(adminMemberSel) {
            adminMemberSel.innerHTML = '<option value="">전체 팀원</option>';
            allMembers.forEach(m => {
                adminMemberSel.innerHTML += `<option value="${m.name}">${m.name}</option>`;
            });
        }
    }

    function parseDBDate(dateStr) {
        if(!dateStr) return null;
        if(dateStr instanceof Date) return dateStr;
        
        let d = new Date(dateStr);
        if(!isNaN(d.getTime())) return d;
        
        const parts = dateStr.split(/[-./]/);
        if(parts.length === 3) {
            d = new Date(parts[0], parts[1] - 1, parts[2]);
            if(!isNaN(d.getTime())) return d;
        }
        return null;
    }

    function switchView(view) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.target.closest('.nav-item').classList.add('active');
        document.querySelectorAll('.dynamic-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        
        if(view === 'analysis') renderMyAnalysis();
        if(view === 'roadmap') renderRoadmapSummary();
        if(view === 'dashboard' && currentUser.role === 'admin') renderAdminDashboard();
        if(view === 'admin-analysis' && currentUser.role === 'admin') renderAdminAnalysis();
        
        if(window.innerWidth <= 768) toggleSidebar();
    }

    function getFilteredData(forAdmin = false) {
        const year = document.getElementById('filter-year').value;
        const month = document.getElementById('filter-month').value;
        const status = document.getElementById('filter-status').value;
        const source = document.getElementById('filter-source').value;
        const search = document.getElementById('search-input').value.toLowerCase();
        
        return allData.filter(item => {
            if(!forAdmin && item.member !== currentUser.name) return false;
            
            const d = parseDBDate(item.date);
            if(year && d && d.getFullYear() !== parseInt(year)) return false;
            if(month && d && (d.getMonth() + 1) !== parseInt(month)) return false;
            if(status && item.status !== status) return false;
            if(source && item.source !== source) return false;
            if(search) {
                const searchStr = `${item.company || ''} ${item.product || ''} ${item.memo || ''}`.toLowerCase();
                if(!searchStr.includes(search)) return false;
            }
            return true;
        });
    }

    function renderList() {
        const grid = document.getElementById('db-grid');
        const data = getFilteredData();
        
        if(data.length === 0) {
            grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-inbox"></i><h3>데이터가 없습니다</h3><p>새 DB를 등록해보세요!</p></div>`;
            return;
        }
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        grid.innerHTML = data.sort((a, b) => {
            const da = parseDBDate(a.date);
            const db = parseDBDate(b.date);
            return (db || 0) - (da || 0);
        }).map(item => {
            let meetingHtml = '';
            if(item.meeting) {
                const meetDate = parseDBDate(item.meeting);
                if(meetDate) {
                    const diff = Math.ceil((meetDate - today) / (1000 * 60 * 60 * 24));
                    if(diff >= 0 && diff <= 7) {
                        const urgentClass = diff <= 2 ? 'urgent' : '';
                        const dday = diff === 0 ? 'D-Day' : `D-${diff}`;
                        meetingHtml = `<div class="db-card-meeting ${urgentClass}"><i class="fas fa-calendar-check"></i> 미팅: ${item.meeting} (${dday})</div>`;
                    }
                }
            }
            
            return `
            <div class="db-card status-${item.status}" onclick="openModal('${item.id}')">
                <div class="db-card-header">
                    <div class="db-card-title">${item.company || '(업체명 없음)'}</div>
                    <span class="db-card-status status-badge-${item.status}">${item.status}</span>
                </div>
                <div class="db-card-info"><i class="fas fa-box"></i>${item.product || '-'}</div>
                <div class="db-card-info"><i class="fas fa-calendar"></i>${item.date || '-'}</div>
                <div class="db-card-info"><i class="fas fa-industry"></i>${item.industry || '-'} / ${item.source || '-'}</div>
                <div class="db-card-amount">${item.amount ? Number(item.amount).toLocaleString() + '원' : '-'}</div>
                ${item.memo ? `<div class="db-card-memo"><i class="fas fa-sticky-note"></i> ${item.memo}</div>` : ''}
                ${meetingHtml}
            </div>`;
        }).join('');
    }

    function openModal(id = null) {
        document.getElementById('modal-overlay').classList.add('active');
        document.getElementById('modal-title').textContent = id ? 'DB 수정' : 'DB 등록';
        document.getElementById('btn-delete').style.display = id ? 'inline-flex' : 'none';
        
        if(id) {
            const item = allData.find(d => d.id === id);
            if(item) {
                document.getElementById('edit-id').value = item.id;
                document.getElementById('edit-company').value = item.company || '';
                document.getElementById('edit-contact').value = item.contact || '';
                document.getElementById('edit-date').value = item.date || '';
                document.getElementById('edit-status').value = item.status || '가망';
                document.getElementById('edit-product').value = item.product || '';
                document.getElementById('edit-amount').value = item.amount ? Number(item.amount).toLocaleString() : '';
                document.getElementById('edit-industry').value = item.industry || '';
                document.getElementById('edit-source').value = item.source || '자체';
                document.getElementById('edit-meeting').value = item.meeting || '';
                document.getElementById('edit-profit-rate').value = item.profitRate || '';
                document.getElementById('edit-memo').value = item.memo || '';
                currentLogs = item.logs || [];
                
                renderShareRows(item.shares || []);
                renderLogs();
                updateShareCalc();
            }
        } else {
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-company').value = '';
            document.getElementById('edit-contact').value = '';
            document.getElementById('edit-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('edit-status').value = '가망';
            document.getElementById('edit-product').value = '';
            document.getElementById('edit-amount').value = '';
            document.getElementById('edit-industry').value = '';
            document.getElementById('edit-source').value = '자체';
            document.getElementById('edit-meeting').value = '';
            document.getElementById('edit-profit-rate').value = '';
            document.getElementById('edit-memo').value = '';
            currentLogs = [];
            
            renderShareRows([]);
            renderLogs();
            updateShareCalc();
        }
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('active');
    }

    function formatAmount(input) {
        let val = input.value.replace(/[^\d]/g, '');
        input.value = val ? Number(val).toLocaleString() : '';
    }

    function renderShareRows(shares = []) {
        const container = document.getElementById('share-rows');
        container.innerHTML = '';
        
        if(shares.length === 0) {
            addShareRow();
        } else {
            shares.forEach((s, i) => addShareRow(s.member, s.percent));
        }
    }

    function addShareRow(member = '', percent = '') {
        const container = document.getElementById('share-rows');
        const row = document.createElement('div');
        row.className = 'share-row';
        
        const memberOptions = allMembers
            .filter(m => m.name !== currentUser.name)
            .map(m => `<option value="${m.name}" ${m.name === member ? 'selected' : ''}>${m.name}</option>`)
            .join('');
        
        row.innerHTML = `
            <select onchange="updateShareCalc()">
                <option value="">파트너 선택</option>
                ${memberOptions}
            </select>
            <input type="text" value="${percent}" placeholder="%" oninput="updateShareCalc()" maxlength="3">
            <span class="share-val">0원</span>
            <button class="btn btn-danger" onclick="this.parentElement.remove(); updateShareCalc();"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(row);
    }

    function updateShareCalc() {
        const amountStr = document.getElementById('edit-amount').value.replace(/[^\d]/g, '');
        const amount = parseInt(amountStr) || 0;
        const profitRate = parseFloat(document.getElementById('edit-profit-rate').value) || 0;
        const profit = Math.round(amount * profitRate / 100);
        
        document.getElementById('calc-profit').textContent = profit.toLocaleString() + '원';
        
        document.querySelectorAll('.share-row').forEach(row => {
            const percentInput = row.querySelector('input[type="text"]');
            const valSpan = row.querySelector('.share-val');
            const percent = parseFloat(percentInput.value) || 0;
            const shareAmount = Math.round(profit * percent / 100);
            valSpan.textContent = shareAmount.toLocaleString() + '원';
        });
    }

    function renderLogs() {
        const list = document.getElementById('activity-list');
        const sortedLogs = [...currentLogs].sort((a, b) => new Date(b.time) - new Date(a.time));
        
        list.innerHTML = sortedLogs.map((log, i) => {
            const isNew = i < 2 && (Date.now() - new Date(log.time).getTime()) < 86400000;
            return `
            <div class="activity-item ${isNew ? 'new-log' : ''}">
                <div class="activity-dot"></div>
                <div class="activity-content">
                    <div>${log.text}</div>
                    <div class="activity-time">${log.time}</div>
                </div>
            </div>`;
        }).join('') || '<div style="text-align:center; color:#94a3b8; padding:20px;">활동 기록이 없습니다.</div>';
    }

    function addLog() {
        const input = document.getElementById('new-log');
        const text = input.value.trim();
        if(!text) return;
        
        currentLogs.push({
            text: text,
            time: new Date().toLocaleString('ko-KR')
        });
        input.value = '';
        renderLogs();
    }

    function saveData() {
        const company = document.getElementById('edit-company').value.trim();
        if(!company) {
            showToast('업체명은 필수 입력 항목입니다.', 'error');
            document.getElementById('edit-company').focus();
            return;
        }
        
        const shares = [];
        document.querySelectorAll('.share-row').forEach(row => {
            const member = row.querySelector('select').value;
            const percent = parseFloat(row.querySelector('input[type="text"]').value) || 0;
            if(member && percent > 0) {
                shares.push({ member, percent });
            }
        });
        
        const obj = {
            id: document.getElementById('edit-id').value || null,
            member: currentUser.name,
            company: company,
            contact: document.getElementById('edit-contact').value,
            date: document.getElementById('edit-date').value,
            status: document.getElementById('edit-status').value,
            product: document.getElementById('edit-product').value,
            amount: document.getElementById('edit-amount').value.replace(/[^\d]/g, ''),
            industry: document.getElementById('edit-industry').value,
            source: document.getElementById('edit-source').value,
            meeting: document.getElementById('edit-meeting').value,
            profitRate: document.getElementById('edit-profit-rate').value,
            memo: document.getElementById('edit-memo').value,
            shares: shares,
            logs: currentLogs,
            hasAdminAlert: document.getElementById('edit-meeting').value ? true : false
        };
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', data: obj }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('저장되었습니다.');
                closeModal();
                fetchDB(() => {
                    if(currentUser.role === 'admin' && document.getElementById('view-dashboard').classList.contains('active')) {
                        renderAdminDashboard();
                    } else {
                        renderList();
                    }
                });
            } else {
                showToast(d.message || '저장 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('저장 실패', 'error');
        });
    }

    function deleteData() {
        if(!confirm('정말 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) return;
        
        const id = document.getElementById('edit-id').value;
        if(!id) return showToast('삭제할 데이터가 없습니다.', 'error');
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('삭제되었습니다.');
                closeModal();
                fetchDB(() => renderList());
            } else {
                showToast(d.message || '삭제 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('삭제 실패', 'error');
        });
    }

    // 팀원 관리
    function openTeamModal() {
        document.getElementById('team-modal-overlay').classList.add('active');
        renderTeamList();
    }

    function closeTeamModal() {
        document.getElementById('team-modal-overlay').classList.remove('active');
        document.getElementById('new-member-id').value = '';
        document.getElementById('new-member-name').value = '';
        document.getElementById('new-member-pw').value = '';
        document.getElementById('new-member-role').value = 'member';
    }

    function renderTeamList() {
        const list = document.getElementById('team-list');
        list.innerHTML = allMembers.map(m => `
            <div class="team-item">
                <div class="team-avatar">${m.name.charAt(0)}</div>
                <div class="team-info">
                    <div class="team-name">${m.name}</div>
                    <div class="team-role">${m.role === 'admin' ? '관리자' : '팀원'} (ID: ${m.id})</div>
                </div>
                <div class="team-actions">
                    <button class="btn btn-secondary" onclick="resetMemberPw('${m.id}')" title="비밀번호 초기화"><i class="fas fa-key"></i></button>
                    ${m.id !== currentUser.id ? `<button class="btn btn-danger" onclick="deleteMember('${m.id}')" title="삭제"><i class="fas fa-trash"></i></button>` : ''}
                </div>
            </div>
        `).join('') || '<div style="text-align:center; color:#94a3b8; padding:20px;">등록된 팀원이 없습니다.</div>';
    }

    function addMember() {
        const id = document.getElementById('new-member-id').value.trim();
        const name = document.getElementById('new-member-name').value.trim();
        const pw = document.getElementById('new-member-pw').value;
        const role = document.getElementById('new-member-role').value;
        
        if(!id || !name || !pw) {
            showToast('모든 항목을 입력하세요.', 'error');
            return;
        }
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'add_member', id, name, pw, role }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('팀원이 추가되었습니다.');
                document.getElementById('new-member-id').value = '';
                document.getElementById('new-member-name').value = '';
                document.getElementById('new-member-pw').value = '';
                document.getElementById('new-member-role').value = 'member';
                fetchMembers();
                setTimeout(renderTeamList, 500);
            } else {
                showToast(d.message || '추가 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('추가 실패', 'error');
        });
    }

    function deleteMember(id) {
        if(!confirm('정말 이 팀원을 삭제하시겠습니까?')) return;
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'del_member', id }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('팀원이 삭제되었습니다.');
                fetchMembers();
                setTimeout(renderTeamList, 500);
            } else {
                showToast(d.message || '삭제 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('삭제 실패', 'error');
        });
    }

    function resetMemberPw(id) {
        const newPw = prompt('새 비밀번호를 입력하세요:');
        if(!newPw) return;
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'reset_pw', id, newPw }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('비밀번호가 초기화되었습니다.');
            } else {
                showToast(d.message || '초기화 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('초기화 실패', 'error');
        });
    }

    // 비밀번호 변경
    function openPwModal() {
        document.getElementById('pw-modal-overlay').classList.add('active');
    }

    function closePwModal() {
        document.getElementById('pw-modal-overlay').classList.remove('active');
        document.getElementById('current-pw').value = '';
        document.getElementById('new-pw').value = '';
        document.getElementById('confirm-pw').value = '';
    }

    function changePw() {
        const currentPw = document.getElementById('current-pw').value;
        const newPw = document.getElementById('new-pw').value;
        const confirmPw = document.getElementById('confirm-pw').value;
        
        if(!currentPw || !newPw || !confirmPw) {
            showToast('모든 항목을 입력하세요.', 'error');
            return;
        }
        if(newPw !== confirmPw) {
            showToast('새 비밀번호가 일치하지 않습니다.', 'error');
            return;
        }
        
        showLoading();
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'change_pw', id: currentUser.id, currentPw, newPw }) })
        .then(r => r.json())
        .then(d => {
            hideLoading();
            if(d.success) {
                showToast('비밀번호가 변경되었습니다.');
                closePwModal();
            } else {
                showToast(d.message || '변경 실패', 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('변경 실패', 'error');
        });
    }

    // 엑셀 내보내기
    function exportExcel() {
        const data = getFilteredData();
        if(data.length === 0) {
            showToast('내보낼 데이터가 없습니다.', 'error');
            return;
        }
        
        const ws_data = [['업체명', '연락처', '등록일', '상태', '상품', '계약금액', '순수익', '업종', '출처', '미팅예정일', '메모']];
        data.forEach(item => {
            const amount = parseInt(item.amount) || 0;
            const profitRate = parseFloat(item.profitRate) || 0;
            const profit = Math.round(amount * profitRate / 100);
            
            ws_data.push([
                item.company || '',
                item.contact || '',
                item.date || '',
                item.status || '',
                item.product || '',
                amount,
                profit,
                item.industry || '',
                item.source || '',
                item.meeting || '',
                item.memo || ''
            ]);
        });
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, 'DB목록');
        
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `DB_Export_${currentUser.name}_${today}.xlsx`);
        showToast('엑셀 파일이 다운로드되었습니다.');
    }

    // 분석
    function renderMyAnalysis() {
        const data = allData.filter(d => d.member === currentUser.name);
        const curYear = new Date().getFullYear();
        const curMonth = new Date().getMonth() + 1;
        
        const thisYearData = data.filter(d => {
            const dt = parseDBDate(d.date);
            return dt && dt.getFullYear() === curYear;
        });
        
        const thisMonthData = thisYearData.filter(d => {
            const dt = parseDBDate(d.date);
            return dt && (dt.getMonth() + 1) === curMonth;
        });
        
        const lastYearData = data.filter(d => {
            const dt = parseDBDate(d.date);
            return dt && dt.getFullYear() === curYear - 1;
        });
        
        const calcStats = (arr) => ({
            total: arr.length,
            contract: arr.filter(d => d.status === '계약').length,
            amount: arr.filter(d => d.status === '계약').reduce((s, d) => s + (parseInt(d.amount) || 0), 0)
        });
        
        const thisYear = calcStats(thisYearData);
        const thisMonth = calcStats(thisMonthData);
        const lastYear = calcStats(lastYearData);
        
        document.getElementById('my-stats').innerHTML = `
            <div class="stat-card primary">
                <div class="stat-icon"><i class="fas fa-database"></i></div>
                <div class="stat-value">${thisMonth.total}</div>
                <div class="stat-label">이번달 등록 DB</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value">${thisMonth.contract}</div>
                <div class="stat-label">이번달 계약</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-won-sign"></i></div>
                <div class="stat-value">${(thisMonth.amount / 10000).toFixed(0)}만</div>
                <div class="stat-label">이번달 계약금액</div>
            </div>
            <div class="stat-card prospect">
                <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                <div class="stat-value">${thisYear.total}</div>
                <div class="stat-label">올해 총 DB</div>
            </div>
        `;
        
        const yoyChange = lastYear.amount > 0 ? ((thisYear.amount - lastYear.amount) / lastYear.amount * 100).toFixed(1) : 'N/A';
        
        document.getElementById('my-analysis').innerHTML = `
            <div class="analysis-card">
                <h4><i class="fas fa-chart-line"></i> 연간 비교 (YoY)</h4>
                <div class="yoy-item">
                    <span>올해 계약금액</span>
                    <span class="yoy-change">${(thisYear.amount / 10000).toLocaleString()}만원</span>
                </div>
                <div class="yoy-item">
                    <span>작년 계약금액</span>
                    <span>${(lastYear.amount / 10000).toLocaleString()}만원</span>
                </div>
                <div class="yoy-item">
                    <span>증감률</span>
                    <span class="yoy-change ${yoyChange > 0 ? 'positive' : yoyChange < 0 ? 'negative' : ''}">${yoyChange !== 'N/A' ? (yoyChange > 0 ? '+' : '') + yoyChange + '%' : 'N/A'}</span>
                </div>
            </div>
            <div class="analysis-card">
                <h4><i class="fas fa-pie-chart"></i> 상태별 현황 (올해)</h4>
                ${['계약', '가망', '진행중', '철회'].map(st => {
                    const cnt = thisYearData.filter(d => d.status === st).length;
                    const pct = thisYearData.length > 0 ? (cnt / thisYearData.length * 100).toFixed(0) : 0;
                    return `
                    <div class="yoy-item">
                        <span>${st}</span>
                        <span>${cnt}건 (${pct}%)</span>
                    </div>`;
                }).join('')}
            </div>
        `;
    }

    // 관리자 대시보드
    function renderAdminDashboard() {
        const curYear = new Date().getFullYear();
        const curMonth = new Date().getMonth() + 1;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const thisMonthData = allData.filter(d => {
            const dt = parseDBDate(d.date);
            return dt && dt.getFullYear() === curYear && (dt.getMonth() + 1) === curMonth;
        });
        
        const contractData = thisMonthData.filter(d => d.status === '계약');
        const totalAmount = contractData.reduce((s, d) => s + (parseInt(d.amount) || 0), 0);
        
        document.getElementById('admin-stats').innerHTML = `
            <div class="stat-card primary">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value">${allMembers.length}</div>
                <div class="stat-label">전체 팀원</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon"><i class="fas fa-database"></i></div>
                <div class="stat-value">${thisMonthData.length}</div>
                <div class="stat-label">이번달 총 DB</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value">${contractData.length}</div>
                <div class="stat-label">이번달 계약</div>
            </div>
            <div class="stat-card prospect">
                <div class="stat-icon"><i class="fas fa-won-sign"></i></div>
                <div class="stat-value">${(totalAmount / 10000).toFixed(0)}만</div>
                <div class="stat-label">이번달 계약금액</div>
            </div>
        `;
        
        // 월별 차트
        const monthlyData = [];
        for(let m = 1; m <= 12; m++) {
            const mData = allData.filter(d => {
                const dt = parseDBDate(d.date);
                return dt && dt.getFullYear() === curYear && (dt.getMonth() + 1) === m && d.status === '계약';
            });
            monthlyData.push({
                month: m + '월',
                count: mData.length,
                amount: mData.reduce((s, d) => s + (parseInt(d.amount) || 0), 0)
            });
        }
        
        const maxAmount = Math.max(...monthlyData.map(m => m.amount), 1);
        document.getElementById('admin-chart').innerHTML = `
            <div style="display:flex; align-items:flex-end; gap:8px; height:200px; padding:10px 0;">
                ${monthlyData.map(m => `
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:11px; color:#64748b; margin-bottom:4px;">${(m.amount / 10000).toFixed(0)}만</div>
                        <div style="width:100%; background:linear-gradient(to top, var(--primary), #60a5fa); border-radius:4px 4px 0 0; height:${Math.max(m.amount / maxAmount * 150, 4)}px;"></div>
                        <div style="font-size:11px; margin-top:4px;">${m.month}</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        // 랭킹
        const memberStats = {};
        allMembers.forEach(m => memberStats[m.name] = { count: 0, amount: 0 });
        thisMonthData.filter(d => d.status === '계약').forEach(d => {
            if(memberStats[d.member]) {
                memberStats[d.member].count++;
                memberStats[d.member].amount += parseInt(d.amount) || 0;
            }
        });
        
        const ranking = Object.entries(memberStats)
            .sort((a, b) => b[1].amount - a[1].amount)
            .slice(0, 5);
        
        document.getElementById('admin-ranking').innerHTML = ranking.map((r, i) => `
            <div class="ranking-item">
                <div class="ranking-num">${i + 1}</div>
                <div class="ranking-name">${r[0]}</div>
                <div class="ranking-value">${(r[1].amount / 10000).toFixed(0)}만원 (${r[1].count}건)</div>
            </div>
        `).join('') || '<div style="text-align:center; color:#94a3b8; padding:20px;">데이터 없음</div>';
        
        // 미팅 알림
        const upcomingMeetings = allData.filter(d => {
            if(!d.meeting) return false;
            const meetDate = parseDBDate(d.meeting);
            if(!meetDate) return false;
            const diff = Math.ceil((meetDate - today) / (1000 * 60 * 60 * 24));
            return diff >= 0 && diff <= 7;
        }).sort((a, b) => parseDBDate(a.meeting) - parseDBDate(b.meeting));
        
        document.getElementById('meeting-alerts').innerHTML = upcomingMeetings.length > 0 ? upcomingMeetings.map(d => {
            const meetDate = parseDBDate(d.meeting);
            const diff = Math.ceil((meetDate - today) / (1000 * 60 * 60 * 24));
            const dday = diff === 0 ? 'D-Day' : `D-${diff}`;
            const urgentClass = diff <= 2 ? 'urgent' : '';
            
            return `
            <div class="db-card-meeting ${urgentClass}" style="margin-bottom:8px; cursor:pointer;" onclick="openModal('${d.id}')">
                <i class="fas fa-calendar-check"></i>
                <strong>${d.company}</strong> - ${d.member} | ${d.meeting} (${dday})
            </div>`;
        }).join('') : '<div style="text-align:center; color:#94a3b8; padding:20px;">예정된 미팅이 없습니다.</div>';
        
        // 미팅 알림 배지 업데이트
        const alertCount = upcomingMeetings.length;
        const badge = document.getElementById('meeting-alert-badge');
        const countSpan = document.getElementById('meeting-alert-count');
        if(alertCount > 0) {
            badge.style.display = 'inline-flex';
            countSpan.textContent = alertCount;
        } else {
            badge.style.display = 'none';
        }
    }

    function renderAdminAnalysis() {
        const memberFilter = document.getElementById('admin-analysis-member').value;
        const yearFilter = parseInt(document.getElementById('admin-analysis-year').value) || new Date().getFullYear();
        
        let data = allData.filter(d => {
            const dt = parseDBDate(d.date);
            return dt && dt.getFullYear() === yearFilter;
        });
        
        if(memberFilter) {
            data = data.filter(d => d.member === memberFilter);
        }
        
        const contractData = data.filter(d => d.status === '계약');
        const totalAmount = contractData.reduce((s, d) => s + (parseInt(d.amount) || 0), 0);
        
        document.getElementById('admin-analysis-stats').innerHTML = `
            <div class="stat-card primary">
                <div class="stat-icon"><i class="fas fa-database"></i></div>
                <div class="stat-value">${data.length}</div>
                <div class="stat-label">총 DB</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value">${contractData.length}</div>
                <div class="stat-label">계약 건수</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-won-sign"></i></div>
                <div class="stat-value">${(totalAmount / 10000).toFixed(0)}만</div>
                <div class="stat-label">총 계약금액</div>
            </div>
            <div class="stat-card prospect">
                <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                <div class="stat-value">${data.length > 0 ? (contractData.length / data.length * 100).toFixed(0) : 0}%</div>
                <div class="stat-label">계약률</div>
            </div>
        `;
        
        // 업종별 분석
        const industryStats = {};
        data.forEach(d => {
            const ind = d.industry || '미분류';
            if(!industryStats[ind]) industryStats[ind] = { total: 0, contract: 0, amount: 0 };
            industryStats[ind].total++;
            if(d.status === '계약') {
                industryStats[ind].contract++;
                industryStats[ind].amount += parseInt(d.amount) || 0;
            }
        });
        
        document.getElementById('admin-analysis-grid').innerHTML = `
            <div class="analysis-card">
                <h4><i class="fas fa-industry"></i> 업종별 현황</h4>
                ${Object.entries(industryStats).sort((a, b) => b[1].amount - a[1].amount).slice(0, 8).map(([ind, stat]) => `
                    <div class="yoy-item">
                        <span>${ind}</span>
                        <span>${stat.contract}건 / ${(stat.amount / 10000).toFixed(0)}만원</span>
                    </div>
                `).join('')}
            </div>
            <div class="analysis-card">
                <h4><i class="fas fa-chart-pie"></i> 출처별 현황</h4>
                ${['자체', '제휴'].map(src => {
                    const srcData = data.filter(d => d.source === src);
                    const srcContract = srcData.filter(d => d.status === '계약');
                    const srcAmount = srcContract.reduce((s, d) => s + (parseInt(d.amount) || 0), 0);
                    return `
                    <div class="yoy-item">
                        <span>${src}</span>
                        <span>${srcContract.length}건 / ${(srcAmount / 10000).toFixed(0)}만원</span>
                    </div>`;
                }).join('')}
            </div>
        `;
    }

    // 로드맵
    function loadMyRoadmap() {
        const saved = localStorage.getItem('roadmap_' + currentUser.id);
        myRoadmap = saved ? JSON.parse(saved) : [];
    }

    function saveRoadmap() {
        localStorage.setItem('roadmap_' + currentUser.id, JSON.stringify(myRoadmap));
        showToast('로드맵이 저장되었습니다.');
        renderRoadmapTimeline();
        renderRoadmapSummary();
    }

    function openRoadmapPopup() {
        document.getElementById('roadmap-popup').classList.add('active');
        renderRoadmapTimeline();
    }

    function closeRoadmapPopup() {
        document.getElementById('roadmap-popup').classList.remove('active');
    }

    function renderRoadmapTimeline() {
        const timeline = document.getElementById('rm-timeline');
        const barContainer = document.getElementById('rm-bar-container');
        
        const sorted = [...myRoadmap].sort((a, b) => new Date(a.date) - new Date(b.date));
        const doneCount = sorted.filter(r => r.done).length;
        const progress = sorted.length > 0 ? Math.round(doneCount / sorted.length * 100) : 0;
        
        document.getElementById('rm-progress-percent').textContent = progress + '%';
        document.getElementById('rm-progress-bar').style.width = progress + '%';
        
        // 바 차트
        barContainer.innerHTML = sorted.map((item, i) => {
            const statusClass = item.done ? 'done' : 'progress';
            const pct = sorted.length > 0 ? ((i + 1) / sorted.length * 100) : 0;
            return `
            <div class="rm-bar-item">
                <div class="rm-bar-label">
                    <span>${item.title}</span>
                    <span>${item.date}</span>
                </div>
                <div class="rm-bar-outer">
                    <div class="rm-bar-inner ${statusClass}" style="width:${item.done ? 100 : 50}%">${item.done ? '완료' : '진행중'}</div>
                    ${!item.done ? `<span class="rm-bar-outer-text">${item.done ? '' : '50%'}</span>` : ''}
                </div>
            </div>`;
        }).join('') || '<div style="text-align:center; color:#94a3b8;">항목이 없습니다.</div>';
        
        // 타임라인
        timeline.innerHTML = sorted.map((item, i) => `
            <div class="rm-item ${item.done ? 'done' : ''}" draggable="true" data-idx="${i}"
                ondragstart="handleDragStart(event, ${i})"
                ondragover="handleDragOver(event)"
                ondrop="handleDrop(event, ${i})"
                ondragend="handleDragEnd(event)">
                <div class="rm-item-header">
                    <div class="rm-item-title">${item.title}</div>
                    <div class="rm-item-date">${item.date}</div>
                </div>
                <div class="rm-item-content">${item.content || ''}</div>
                <div class="rm-item-actions">
                    <button class="btn ${item.done ? 'btn-secondary' : 'btn-success'}" onclick="toggleRoadmapDone(${i}); event.stopPropagation();">
                        <i class="fas ${item.done ? 'fa-undo' : 'fa-check'}"></i> ${item.done ? '미완료' : '완료'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteRoadmapItem(${i}); event.stopPropagation();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('') || '';
    }

    function renderRoadmapSummary() {
        const container = document.getElementById('my-roadmap-summary');
        const sorted = [...myRoadmap].sort((a, b) => new Date(a.date) - new Date(b.date));
        const doneCount = sorted.filter(r => r.done).length;
        const progress = sorted.length > 0 ? Math.round(doneCount / sorted.length * 100) : 0;
        
        container.innerHTML = `
            <div class="rm-progress" style="margin-bottom:20px;">
                <div class="rm-progress-header">
                    <span class="rm-progress-text">전체 진행률</span>
                    <span class="rm-progress-text">${progress}% (${doneCount}/${sorted.length})</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width:${progress}%"></div>
                </div>
            </div>
            <div class="rm-bar-container">
                ${sorted.slice(0, 5).map(item => `
                    <div class="rm-bar-item">
                        <div class="rm-bar-label">
                            <span>${item.done ? '✅' : '⏳'} ${item.title}</span>
                            <span>${item.date}</span>
                        </div>
                    </div>
                `).join('') || '<div style="text-align:center; color:#94a3b8; padding:20px;">로드맵 항목이 없습니다.</div>'}
            </div>
        `;
    }

    function addRoadmapItem() {
        const title = document.getElementById('rm-new-title').value.trim();
        const date = document.getElementById('rm-new-date').value;
        const content = document.getElementById('rm-new-content').value.trim();
        
        if(!title || !date) {
            showToast('제목과 목표일을 입력하세요.', 'error');
            return;
        }
        
        myRoadmap.push({ title, date, content, done: false });
        document.getElementById('rm-new-title').value = '';
        document.getElementById('rm-new-date').value = '';
        document.getElementById('rm-new-content').value = '';
        
        renderRoadmapTimeline();
        showToast('항목이 추가되었습니다.');
    }

    function toggleRoadmapDone(idx) {
        myRoadmap[idx].done = !myRoadmap[idx].done;
        renderRoadmapTimeline();
    }

    function deleteRoadmapItem(idx) {
        if(!confirm('이 항목을 삭제하시겠습니까?')) return;
        myRoadmap.splice(idx, 1);
        renderRoadmapTimeline();
        showToast('항목이 삭제되었습니다.');
    }

    // 드래그 앤 드롭
    function handleDragStart(e, idx) {
        draggedItem = idx;
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
    }

    function handleDrop(e, targetIdx) {
        e.preventDefault();
        if(draggedItem === null || draggedItem === targetIdx) return;
        
        const item = myRoadmap.splice(draggedItem, 1)[0];
        myRoadmap.splice(targetIdx, 0, item);
        draggedItem = null;
        renderRoadmapTimeline();
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        draggedItem = null;
    }

    // 로드맵 인쇄
    function previewRoadmapPrint() {
        const sorted = [...myRoadmap].sort((a, b) => new Date(a.date) - new Date(b.date));
        const doneCount = sorted.filter(r => r.done).length;
        const progress = sorted.length > 0 ? Math.round(doneCount / sorted.length * 100) : 0;
        
        const previewContent = document.getElementById('print-preview-content');
        previewContent.innerHTML = `
            <h2><i class="fas fa-road"></i> ${currentUser.name}의 로드맵</h2>
            <p style="text-align:center; color:#64748b; margin-bottom:30px;">진행률: ${progress}% (${doneCount}/${sorted.length} 완료)</p>
            <div class="progress-bar-bg" style="margin-bottom:30px;">
                <div class="progress-bar-fill" style="width:${progress}%; background:var(--primary);"></div>
            </div>
            ${sorted.map(item => `
                <div class="print-item ${item.done ? 'done' : ''}">
                    <div class="print-item-title">${item.done ? '✅' : '⏳'} ${item.title}</div>
                    <div class="print-item-date">목표일: ${item.date}</div>
                    ${item.content ? `<div class="print-item-content">${item.content}</div>` : ''}
                </div>
            `).join('') || '<p style="text-align:center; color:#94a3b8;">로드맵 항목이 없습니다.</p>'}
            <p style="text-align:right; color:#94a3b8; font-size:12px; margin-top:30px;">출력일: ${new Date().toLocaleDateString('ko-KR')}</p>
        `;
        
        document.getElementById('print-preview-modal').classList.add('active');
    }

    function closePrintPreview() {
        document.getElementById('print-preview-modal').classList.remove('active');
    }

    function executePrint() {
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = document.getElementById('print-preview-content').innerHTML;
        printArea.style.display = 'block';
        
        window.print();
        
        setTimeout(() => {
            printArea.style.display = 'none';
        }, 500);
    }

    function printRoadmap() {
        previewRoadmapPrint();
        setTimeout(executePrint, 300);
    }
</script>
</body>
</html>
