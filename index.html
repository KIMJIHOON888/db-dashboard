<!DOCTYPE html>
<html lang="ko"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DB Pro Master v24.25</title>
    <link href="./DB Pro Master v24.25(260213ìµœì¢…)_files/all.min.css" rel="stylesheet">
    <script src="./DB Pro Master v24.25(260213ìµœì¢…)_files/xlsx.full.min.js.ë‹¤ìš´ë¡œë“œ"></script>
    <script src="./DB Pro Master v24.25(260213ìµœì¢…)_files/chart.umd.min.js.ë‹¤ìš´ë¡œë“œ"></script>
    <style>
        :root { --primary: #2563eb; --primary-dark: #1e40af; --bg-light: #f1f5f9; --border: #e2e8f0; --text: #334155; --danger: #ef4444; --success: #10b981; --prospect: #8b5cf6; --warning: #f59e0b; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; margin: 0; background: var(--bg-light); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: #fecaca; }
        .btn-dark { background: #1e293b; color: white; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #64748b; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        input, select, textarea { font-family: inherit; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="date"] { cursor: pointer; position: relative; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        #hist-input { padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        #hist-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 24px; width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .login-input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-size: 16px; transition: 0.2s; }
        .login-input:focus { border-color: var(--primary); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: white; padding: 16px 20px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; animation: slideInRight 0.3s forwards; pointer-events: auto; border-left: 5px solid var(--primary); min-width: 300px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
        .sidebar.admin-mode { background: linear-gradient(160deg, #0f172a 0%, #1e293b 100%); color: white; border: none; }
        .logo-area { font-size: 20px; font-weight: 900; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .sidebar.admin-mode .logo-area { color: white; }
        .btn-big-action { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-new-db { background: var(--primary); color: white; }
        .btn-new-db:hover { background: var(--primary-dark); }
        .nav-item { padding: 12px 14px; margin-bottom: 6px; border-radius: 10px; cursor: pointer; color: #64748b; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: #eff6ff; color: var(--primary); }
        .sidebar.admin-mode .nav-item { color: #94a3b8; }
        .sidebar.admin-mode .nav-item:hover, .sidebar.admin-mode .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .sidebar.admin-mode .profile-box { background: rgba(255,255,255,0.1) !important; border-color: rgba(255,255,255,0.2) !important; }
        .sidebar.admin-mode #profile-name { color: white !important; }
        .sidebar.admin-mode #profile-role { color: #cbd5e1 !important; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { height: 64px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-content { flex: 1; overflow-y: auto; padding: 30px; }
        .card { background: white; border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .table-container { overflow-x: auto; background: white; border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th { background: #f8fafc; padding: 12px 16px; text-align: center; color: #64748b; font-weight: 700; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: #333; text-align: center; font-weight: 500; }
        tr:hover { background-color: #f8fafc; cursor: pointer; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .status-wait { background: #f1f5f9; color: #64748b; }
        .status-ing { background: #dbeafe; color: #2563eb; }
        .status-prospect { background: #f3e8ff; color: #7c3aed; }
        .status-done { background: #dcfce7; color: #16a34a; }
        .status-end { background: #fee2e2; color: #dc2626; }
        .status-share { background: #ffedd5; color: #c2410c; }
        .status-pending { background: #fce7f3; color: #e11d48; border: 1px solid #f9a8d4; } /* ë°˜ë‚©ëŒ€ê¸°ìš© ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .call-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .call-none { background: #f1f5f9; color: #94a3b8; }
        .call-absent { background: #fef3c7; color: #d97706; }
        .call-joke { background: #fee2e2; color: #dc2626; }
        .call-recall { background: #dbeafe; color: #2563eb; }
        .call-done { background: #dcfce7; color: #16a34a; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: 16px; display: flex; flex-direction: column; justify-content: space-between; border-left: 5px solid var(--primary); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-label { font-size: 13px; color: #64748b; font-weight: 700; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1e293b; }
        .rank-card { flex:1; background:white; border-radius:12px; padding:20px; border:1px solid #e2e8f0; }
        .rank-title { font-weight:800; font-size:15px; margin-bottom:15px; display:flex; align-items:center; gap:8px; }
        .rank-list { list-style:none; padding:0; margin:0; }
        .rank-item { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f1f5f9; font-size:14px; }
        .rank-val { font-weight:bold; color:var(--primary); }
        .progress-bar-bg { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; width: 100px; margin: 5px auto 0; }
        .progress-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.3s ease; }
        .compare-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .compare-box { flex: 1; background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .compare-val { font-size: 24px; font-weight: 800; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px); }
        .modal-window { background: white; width: 1200px; height: 95vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { flex: 1; display: flex; overflow: hidden; background: #f8fafc; position: relative; }
        .panel-left { flex: 7; padding: 30px; overflow-y: auto; border-right: 1px solid var(--border); position: relative; }
        .panel-right { flex: 3; padding: 30px; display: flex; flex-direction: column; background: white; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .form-group label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        .dynamic-section { display: none; background: white; border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-top: 15px; }
        .dynamic-section.active { display: block; animation: fadeIn 0.3s; }
        .contract-box { background: #ecfdf5; border-color: #6ee7b7; }
        .prospect-box { background: #f3e8ff; border-color: #d8b4fe; }
        .share-info { background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .share-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .share-row select { flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .share-row input { width: 70px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: right; }
        .share-val { min-width: 80px; text-align: right; font-weight: bold; color: var(--primary); }
        .meeting-badge { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; }
        .meeting-today { background: #fef3c7; color: #d97706; animation: pulse 2s infinite; }
        .meeting-upcoming { background: #dbeafe; color: #2563eb; }
        .meeting-overdue { background: #fee2e2; color: #dc2626; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .admin-alert-icon { color: #ff6b00; margin-left: 5px; animation: alertBounce 1s ease-in-out infinite; filter: drop-shadow(0 0 3px #ff6b00); font-size: 16px; }
        @keyframes alertBounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3px) scale(1.2); } }
        .dday-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; margin-left: 4px; }
        .dday-today { background: #fef3c7; color: #d97706; animation: pulse 1.5s infinite; }
        .dday-soon { background: #dbeafe; color: #2563eb; }
        .dday-overdue { background: #fee2e2; color: #dc2626; }
        .phone-link { color: var(--primary); cursor: pointer; text-decoration: underline; }
        .phone-link:hover { color: var(--primary-dark); }
        #member-modal .modal-window { width: 600px; height: auto; max-height: 80vh; }
        #member-modal .modal-body { display: block; padding: 20px; overflow-y: auto; }
        .member-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #e2e8f0; }
        .member-list-item:hover { background: #f8fafc; }
        .member-name { font-weight: 600; color: #1e293b; }
        .member-role { font-size: 12px; color: #64748b; margin-left: 8px; }
        .member-actions { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; }
        .btn-icon-danger { background: #fee2e2; color: #dc2626; }
        .btn-icon-danger:hover { background: #fecaca; }
        .add-member-row { display: flex; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 8px; margin-top: 15px; }
        .add-member-row input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        #roadmap-modal .modal-window { width: 1400px; height: 95vh; }
        #roadmap-modal .modal-body { display: block; padding: 30px; overflow-y: auto; }
        .roadmap-toolbar { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .roadmap-presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-preset { padding: 8px 14px; font-size: 13px; background: white; color: #475569; border: 1px solid #cbd5e1; border-radius: 20px; cursor: pointer; font-weight: 600; }
        .btn-preset.active { background: #eff6ff; color: var(--primary); border-color: var(--primary); }
        .rm-input-row { display: flex; gap: 10px; align-items: center; background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .rm-input-row.edit-mode { border: 2px solid var(--primary); background: #eff6ff; }
        .rm-input-group { display: flex; flex-direction: column; gap: 5px; }
        .rm-container { border: 2px solid #334155; padding: 30px; border-radius: 15px; margin-bottom: 20px; background: white; overflow-x: auto; }
        .rm-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; }
        .rm-header { background: #1e3a8a; color: white; padding: 12px 0; border: 1px solid #94a3b8; font-weight:bold; text-align:center; }
        .rm-subheader { background: #3b82f6; color: white; padding: 6px 0; border: 1px solid #94a3b8; font-size:11px; text-align:center; }
        .rm-cell { border: 1px solid #cbd5e1; height: 55px; position: relative; background: white; }
        .rm-cat-col { width: 120px; text-align: center; font-weight: 800; border: 1px solid #94a3b8; color: white; padding: 5px; word-break: keep-all; vertical-align: middle; }
        .rm-diagonal { background: linear-gradient(to top right, #f1f5f9 49.5%, #94a3b8 50%, #f1f5f9 50.5%); position: relative; }
        .rm-diagonal-text { position: absolute; font-size: 11px; font-weight: bold; color: #334155; }
        .rm-text-bottom-left { bottom: 5px; left: 8px; }
        .rm-text-top-right { top: 5px; right: 8px; }
        .rm-bar-container { position: absolute; top: 10px; bottom: 10px; border-radius: 15px; display: flex; align-items: center; color: white; font-size: 12px; font-weight: bold; box-shadow: 2px 3px 6px rgba(0,0,0,0.15); overflow: hidden; z-index: 10; cursor: pointer; white-space: nowrap; }
        .rm-align-left { justify-content: flex-start; padding-left: 10px; }
        .rm-align-center { justify-content: center; }
        .rm-align-right { justify-content: flex-end; padding-right: 10px; }
        .rm-bar-outer-text { position: absolute; top: 50%; transform: translateY(-50%); left: 105%; margin-left: 8px; font-size: 11px; font-weight: bold; color: #334155; z-index: 5; white-space: nowrap; }
        .rm-item-chip { display:inline-flex; background:#f1f5f9; padding:6px 12px; margin:3px; border-radius:20px; border:1px solid #cbd5e1; font-size:13px; cursor:grab; align-items:center; }
        .rm-item-chip.drag-over { border-left: 3px solid var(--primary); background: #eff6ff; }
        .rm-title-edit { font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 40px; border: 2px dashed transparent; display: block; font-family:'Pretendard'; color:#1e293b; outline:none; }
        .rm-title-edit:hover { border-color: #cbd5e1; background: #f8fafc; }
        .perf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .perf-table th, .perf-table td { padding: 12px 8px; text-align: center; border: 1px solid #e2e8f0; }
        .perf-table th { background: #f8fafc; font-weight: 700; color: #64748b; font-size: 12px; }
        .perf-table td { font-weight: 600; }
        .perf-table .row-label { background: #f1f5f9; font-weight: 700; color: #334155; }
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 280px; box-shadow: none; }
            .sidebar.active { transform: translateX(0); box-shadow: 100px 0 0 rgba(0,0,0,0.5); }
            .main-content { width: 100%; height: auto; overflow: visible; }
            .page-content { padding: 15px; overflow: visible; padding-bottom: 80px; }
            .header { padding: 0 15px; }
            #mobile-menu-btn { display: block !important; font-size: 24px; cursor: pointer; color: #334155; }
            .login-box { width: 90%; padding: 25px; }
            .dashboard-grid, .form-grid { grid-template-columns: 1fr; gap: 10px; }
            .compare-row, #list-filter-container { flex-direction: column; }
            .modal-window { width: 100% !important; height: 100% !important; border-radius: 0; }
            .modal-body { flex-direction: column; overflow-y: auto; }
            .panel-left, .panel-right { width: 100%; padding: 15px; border: none; flex: none; }
            .panel-right { border-top: 4px solid #f1f5f9; padding-bottom: 100px; }
        }

        .nav-special-calendar { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; color: #1d4ed8 !important; font-weight: 800 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 15px; }
        .nav-special-calendar:hover { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); transform: translateY(-2px); }
        .nav-special-message { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; color: #15803d !important; font-weight: 800 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 6px;}
        .nav-special-message:hover { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); transform: translateY(-2px); }
        .nav-special-request { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fde68a; color: #b45309 !important; font-weight: 800 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 6px;}
        .nav-special-request:hover { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); transform: translateY(-2px); }
        .sidebar.admin-mode .nav-special-calendar { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border: 1px solid #3b82f6; color: #eff6ff !important; }
        .sidebar.admin-mode .nav-special-message { background: linear-gradient(135deg, #14532d 0%, #166534 100%); border: 1px solid #22c55e; color: #f0fdf4 !important; }
        .sidebar.admin-mode .nav-special-request { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); border: 1px solid #f59e0b; color: #fffbeb !important; }
        
        /* ë°˜ë‚©ëŒ€ê¸° ì‹œ íŒ¨ë„ ì ê¸ˆì„ ìœ„í•œ ì˜¤ë²„ë ˆì´ */
        #modal-overlay-lock { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); z-index: 10; display: none; cursor: not-allowed; }
    </style>
</head>
<body>
<div id="toast-container"></div>
<div id="loading-overlay"><div class="spinner"></div></div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-server"></i> DB Pro Master</h2>
        <div style="font-size:14px; color:#64748b; margin-bottom:20px; font-weight:600;">v24.25</div>
        <div id="login-loading" style="display: none; text-align: center; margin-bottom: 15px; color: var(--primary);"><i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i><br><span style="font-size:12px; font-weight:600;">ì ‘ì† ì¤‘...</span></div>
        <input type="text" id="login-user-name" class="login-input" placeholder="ì„±í•¨ ì…ë ¥ (ì˜ˆ: í™ê¸¸ë™)" onkeypress="if(event.keyCode==13) document.getElementById('login-pw').focus()">
        <input type="password" id="login-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeypress="if(event.keyCode==13) attemptLogin('member')">
        <div style="text-align: left; margin-bottom: 20px; padding-left: 5px;">
            <label style="font-size: 14px; color: #64748b; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="login-remember" style="width: 18px; height: 18px; cursor: pointer;"> ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
            </label>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-primary" style="padding:15px; font-size:16px;" onclick="attemptLogin('member')">íŒ€ì› ì ‘ì†í•˜ê¸°</button>
            <button class="btn btn-dark" style="padding:15px; font-size:16px;" onclick="attemptLogin('admin')">ê´€ë¦¬ì ì ‘ì†í•˜ê¸°</button>
        </div>
        <p style="margin-top:25px; font-size:12px; color:#94a3b8; line-height:1.5;">* ì´ˆê¸° ë¹„ë²ˆ : 1234<br><span style="color:#ef4444; font-weight:bold;">âš ï¸ ìµœì´ˆ ë¡œê·¸ì¸ í›„ ë°˜ë“œì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”!</span></p>
    </div>
</div>

<div class="sidebar" id="app-sidebar" style="display:none;">
    <div class="logo-area"><i class="fa-solid fa-layer-group"></i> DB Master</div>
    <button class="btn-big-action btn-new-db" onclick="openModal(); toggleMobileMenu();"><i class="fa-solid fa-plus"></i> ì‹ ê·œ DB ë“±ë¡</button>
    <div class="profile-box" style="background:#f8fafc; padding:15px; border-radius:12px; margin: 15px 0; border:1px solid #e2e8f0;">
        <div id="profile-name" style="font-weight:bold; font-size:16px; color:#1e293b;"></div>
        <div style="font-size:12px; opacity:0.7; margin-top:4px; color:#64748b;" id="profile-role"></div>
        <button onclick="changePassword()" style="margin-top:10px; font-size:11px; padding:4px 10px; border:1px solid #cbd5e1; background:white; border-radius:6px; cursor:pointer; color:#333;">ë¹„ë²ˆë³€ê²½</button>
    </div>
    <div id="nav-list" class="nav-item active" onclick="navTo('list'); toggleMobileMenu();"><i class="fa-solid fa-folder-open"></i> <span id="menu-list-text">ë‚˜ì˜ DB ê´€ë¦¬</span></div>
    <div id="nav-analysis" class="nav-item" onclick="navTo('analysis'); toggleMobileMenu();"><i class="fa-solid fa-chart-column"></i> ì‹¤ì  ìƒì„¸ ë¶„ì„</div>
    <div id="nav-history" class="nav-item" onclick="navTo('history'); toggleMobileMenu();"><i class="fa-solid fa-calendar-days"></i> ì›”ë³„ íˆìŠ¤í† ë¦¬</div>
    
    <div id="nav-calendar" class="nav-item nav-special-calendar" onclick="navTo('calendar'); toggleMobileMenu();"><i class="fa-solid fa-calendar-check"></i> ë¯¸íŒ… ìº˜ë¦°ë”</div>
    <div id="nav-message" class="nav-item nav-special-message" onclick="navTo('message'); toggleMobileMenu();"><i class="fa-solid fa-comments"></i> 1:1 ë©”ì‹œì§€ <span id="msg-badge" style="display:none; background:#ef4444; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:5px;"></span></div>
    <div id="nav-member-request" class="nav-item nav-special-request" style="display:none;" onclick="openMemberRequestModal(); toggleMobileMenu();"><i class="fa-solid fa-comment-dots"></i> ê±´ì˜ì‚¬í•­/ì§ˆë¬¸</div>
    
    <div id="admin-menu" style="display:none; margin-top:20px;">
        <div style="font-size:11px; opacity:0.7; font-weight:bold; padding-left:10px; margin-bottom:5px;">ê´€ë¦¬ì ì „ìš©</div>
        <div id="nav-dashboard" class="nav-item" onclick="navTo('dashboard'); toggleMobileMenu();"><i class="fa-solid fa-tower-observation"></i> í†µí•© ê´€ì œíƒ‘</div>
        <div id="nav-members" class="nav-item" onclick="openMemberModal(); toggleMobileMenu();"><i class="fa-solid fa-users-gear"></i> íŒ€ì› ê´€ë¦¬</div>
        <div id="nav-admin-request" class="nav-item nav-special-request" onclick="openAdminRequestModal(); toggleMobileMenu();"><i class="fa-solid fa-envelope-open-text"></i> íŒ€ì› ìš”ì²­ê¸€ <span id="request-badge" style="display:none; background:#ef4444; color:white; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:5px; animation: pulse 1.5s infinite;">0</span></div>
    </div>
    <button onclick="logout()" style="margin-top:auto; background:none; border:none; color:#ef4444; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px;"><i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div id="mobile-sidebar-overlay" onclick="toggleMobileMenu()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:40;"></div>

<div class="main-content" id="app-main" style="display:none;">
    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <i class="fa-solid fa-bars" id="mobile-menu-btn" style="display:none; cursor:pointer;" onclick="toggleMobileMenu()"></i>
            <h2 id="page-title" style="font-size:18px; font-weight:800; margin:0;">ë‚˜ì˜ DB ê´€ë¦¬</h2>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="meeting-alert-badge" style="display:none;" onclick="showMeetingList()"></div>
            <div style="font-size:12px; color:#64748b; font-weight:bold; background:#f1f5f9; padding:6px 12px; border-radius:20px;">v24.25</div>
        </div>
    </div>

    <div class="page-content" id="view-list">
        <div class="card" style="padding:20px;">
            <div id="list-filter-container" style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:13px; color:#64748b;"><i class="fa-solid fa-circle-info" style="color:var(--primary);"></i> ì‰ì–´ ë°›ì€ DBëŠ” <b>[ì´ë¦„]ì‰ì–´</b>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
                <button class="btn btn-success" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
        <div class="table-container" style="height: calc(100vh - 300px); overflow-y: auto;">
            <table id="main-table"><thead id="list-head"></thead><tbody id="list-body"></tbody></table>
            <div id="empty-message" style="display:none; text-align:center; padding:50px; color:#94a3b8;"><i class="fa-solid fa-folder-open" style="font-size:40px; margin-bottom:10px; opacity:0.5;"></i><br>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div id="pagination-controls" style="display:none; margin-top:15px; text-align:center; padding:10px;">
                <button class="btn btn-secondary" onclick="changePage(-1)" id="btn-prev-page" style="margin-right:8px;">â† ì´ì „</button>
                <span id="page-info" style="font-weight:bold; color:#334155; margin:0 12px;"></span>
                <button class="btn btn-secondary" onclick="changePage(1)" id="btn-next-page" style="margin-left:8px;">ë‹¤ìŒ â†’</button>
            </div>
        </div>
    </div>

    <div class="page-content" id="view-analysis" style="display:none;">
        <div id="admin-yoy-summary" style="display:none; margin-bottom:30px;">
            <div style="font-weight:800; font-size:16px; margin-bottom:15px;">ğŸ† ì—°ê°„ ì´ì‹¤ì  ìˆœìœ„ <span style="font-size:12px; color:#64748b; font-weight:normal;">(ê³„ì•½ì¼ ê¸°ì¤€)</span></div>
            <div class="table-container"><table id="yoy-summary-table"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì‘ë…„ ë§¤ì¶œ</th><th>ì˜¬í•´ ë§¤ì¶œ</th><th>ì„±ì¥ì•¡</th><th>ë‹¬ì„±ë¥ </th></tr></thead><tbody></tbody></table></div>
        </div>
        <div style="font-weight:800; font-size:16px; margin-bottom:15px;">ğŸ“Š ì „ë…„ vs ê¸ˆë…„ ì‹¤ì  ë¹„êµ <span style="font-size:12px; color:#64748b; font-weight:normal;">(ê³„ì•½ì¼ ê¸°ì¤€)</span></div>
        <div class="compare-row">
            <div class="compare-box"><div class="compare-val" style="color:#64748b;" id="val-last-total">0</div><div style="font-size:12px; color:#94a3b8;">ì‘ë…„ ì´ ë§¤ì¶œ</div></div>
            <div class="compare-box" style="background:#eff6ff;"><div class="compare-val" style="color:var(--primary);" id="val-this-total">0</div><div style="font-size:12px; color:var(--primary);">ì˜¬í•´ ì´ ë§¤ì¶œ</div></div>
            <div class="compare-box"><div class="compare-val" id="val-growth">0</div><div style="font-size:12px; color:#64748b;">ì „ë…„ ëŒ€ë¹„ ì„±ì¥</div></div>
        </div>
        <div class="card" style="padding:12px;"><h4 style="margin-bottom:8px;">ğŸ“… ì›”ë³„ ë§¤ì¶œ ì¶”ì´ <span style="font-size:12px; color:#64748b; font-weight:normal;">(ê³„ì•½ì¼ ê¸°ì¤€)</span></h4><div class="table-container"><table id="yoy-detail-table" style="font-size:12px;"><thead><tr><th style="padding:4px 6px;">êµ¬ë¶„</th><th style="padding:4px 3px;">1ì›”</th><th style="padding:4px 3px;">2ì›”</th><th style="padding:4px 3px;">3ì›”</th><th style="padding:4px 3px;">4ì›”</th><th style="padding:4px 3px;">5ì›”</th><th style="padding:4px 3px;">6ì›”</th><th style="padding:4px 3px;">7ì›”</th><th style="padding:4px 3px;">8ì›”</th><th style="padding:4px 3px;">9ì›”</th><th style="padding:4px 3px;">10ì›”</th><th style="padding:4px 3px;">11ì›”</th><th style="padding:4px 3px;">12ì›”</th><th style="padding:4px 6px;">í•©ê³„</th></tr></thead><tbody id="yoy-detail-body"></tbody></table></div><div style="margin-top:12px; height:200px;"><canvas id="revenue-chart"></canvas></div></div>
        <div class="card"><h4>ğŸ“‹ ì›”ë³„ DB ì¶œì²˜ë³„ ì„±ê³¼ <span style="font-size:12px; color:#64748b; font-weight:normal;">(ê³„ì•½ì¼ ê¸°ì¤€)</span></h4><div class="table-container"><table id="month-kpi-table"><thead><tr><th>êµ¬ë¶„</th><th>1ì›”</th><th>2ì›”</th><th>3ì›”</th><th>4ì›”</th><th>5ì›”</th><th>6ì›”</th><th>7ì›”</th><th>8ì›”</th><th>9ì›”</th><th>10ì›”</th><th>11ì›”</th><th>12ì›”</th><th>í•©ê³„</th></tr></thead><tbody id="month-kpi-body"></tbody></table></div></div>
        <div id="member-perf-section" style="display:none;">
            <div class="card">
                <h4>ğŸ“ˆ ë‚˜ì˜ ì„±ê³¼ í˜„í™©í‘œ</h4>
                <div class="table-container">
                    <table class="perf-table">
                        <thead><tr><th>êµ¬ë¶„</th><th>DBë°°ì •</th><th>ë¯¸íŒ…</th><th>ê°€ë§</th><th>ê³„ì•½</th><th>ì „í™˜ìœ¨</th><th>ë§¤ì¶œ</th></tr></thead>
                        <tbody id="member-perf-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="page-content" id="view-history" style="display:none;">
        <div class="card" style="display:flex; align-items:center; gap:15px; background:#f8fafc;">
            <h3 style="margin:0; font-size:16px;">ğŸ“… ì¡°íšŒ ê¸°ê°„ :</h3>
            <select id="hist-year" style="padding:8px; border-radius:6px;"><option value="all">ì „ì²´ ì—°ë„</option><option value="2027">2027ë…„</option><option value="2026" selected="">2026ë…„</option><option value="2025">2025ë…„</option><option value="2024">2024ë…„</option><option value="2023">2023ë…„</option></select>
            <select id="hist-month" style="padding:8px; border-radius:6px;"><option value="all">ì „ì²´ (1ë…„ì¹˜)</option><option></option><option value="1">1ì›”</option><option value="2" selected="">2ì›”</option><option value="3">3ì›”</option><option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option><option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option></select>
            <button class="btn btn-primary" onclick="renderHistory()">ì¡°íšŒí•˜ê¸°</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px;" id="history-tabs"></div>
        <div class="table-container"><table><thead id="history-head"></thead><tbody id="history-body"></tbody></table></div>
    </div>

    <div class="page-content" id="view-calendar" style="display:none;">
        <div class="card" style="display:flex; align-items:center; gap:15px; background:#f8fafc;">
            <h3 style="margin:0; font-size:16px;">ğŸ“… ë¯¸íŒ… ìº˜ë¦°ë”</h3>
            <button class="btn btn-secondary" onclick="changeCalMonth(-1)">â† ì´ì „</button>
            <span id="cal-month-label" style="font-weight:800; font-size:18px; min-width:120px; text-align:center;"></span>
            <button class="btn btn-secondary" onclick="changeCalMonth(1)">ë‹¤ìŒ â†’</button>
        </div>
        <div id="calendar-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-top:10px;"></div>
    </div>

    <div class="page-content" id="view-message" style="display:none;">
        <div style="display:flex; height:calc(100vh - 140px); gap:0; border-radius:12px; overflow:hidden; border:1px solid #e2e8f0;">
            <div id="msg-member-list" style="width:200px; background:#f8fafc; border-right:1px solid #e2e8f0; overflow-y:auto; flex-shrink:0;">
                <div style="padding:12px; font-weight:800; font-size:14px; background:#1e3a8a; color:white; text-align:center;">
                    <i class="fa-solid fa-comments"></i> ëŒ€í™” ëª©ë¡
                </div>
                <div id="msg-contacts"></div>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; background:white;">
                <div id="msg-chat-header" style="padding:12px 16px; background:#f1f5f9; border-bottom:1px solid #e2e8f0; font-weight:800; font-size:15px;">
                    <i class="fa-solid fa-user-circle" style="color:#3b82f6;"></i> <span id="msg-chat-name">ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                </div>
                <div id="msg-chat-body" style="flex:1; overflow-y:auto; padding:16px; background:#e8edf3;">
                    <div style="text-align:center; color:#94a3b8; margin-top:40px;"><i class="fa-solid fa-comments" style="font-size:40px; opacity:0.3;"></i><br><br>ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                </div>
                <div id="msg-input-area" style="display:none; padding:10px; border-top:1px solid #e2e8f0; background:#f8fafc;">
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="flex:1; padding:10px 14px; border:1px solid #cbd5e1; border-radius:20px; outline:none; font-size:14px;" onkeypress="if(event.key==='Enter')sendMessage()">
                        <button onclick="sendMessage()" style="background:#3b82f6; color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:16px;"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-content" id="view-dashboard" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-weight:800;"><i class="fa-solid fa-tower-observation"></i> í†µí•© ê´€ì œíƒ‘ <span style="font-size:12px; color:#64748b; font-weight:normal;">(ê³„ì•½ì¼ ê¸°ì¤€)</span></h3>
            <select id="admin-stat-month" style="padding:8px; border-radius:6px; font-weight:bold;" onchange="renderAdminDashboard()"><option value="all">ì „ì²´ ì›”</option><option value="1">1ì›”</option><option value="2" selected="">2ì›”</option><option value="3">3ì›”</option><option value="4">4ì›”</option><option value="5">5ì›”</option><option value="6">6ì›”</option><option value="7">7ì›”</option><option value="8">8ì›”</option><option value="9">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option></select>
        </div>
        <div class="dashboard-grid">
            <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ì´ ë§¤ì¶œ</div><div class="stat-value" id="ad-total-rev">0</div></div>
            <div class="stat-card" style="border-left-color:#10b981;"><div class="stat-label">ì´ë²ˆë‹¬ ì´ ê³„ì•½</div><div class="stat-value" id="ad-total-cont">0ê±´</div></div>
            <div class="stat-card" style="border-left-color:#f59e0b;"><div class="stat-label">ì‹ ê·œ DB ìœ ì…</div><div class="stat-value" id="ad-total-db">0ê°œ</div></div>
            <div class="stat-card" style="border-left-color:#8b5cf6;"><div class="stat-label">ê³„ì•½ ì „í™˜ìœ¨</div><div class="stat-value" id="ad-conv-rate">0%</div></div>
        </div>
        <h3 style="margin-bottom:15px;">ğŸ† ì´ë‹¬ì˜ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
        <div style="display:flex; gap:20px; margin-bottom:30px;">
            <div class="rank-card" style="border-top:4px solid #f59e0b;"><div class="rank-title" style="color:#b45309;"><i class="fa-solid fa-trophy"></i> 500ë§Œì› ì´ìƒ</div><ul class="rank-list" id="rank-500"></ul></div>
            <div class="rank-card" style="border-top:4px solid #10b981;"><div class="rank-title" style="color:#047857;"><i class="fa-solid fa-medal"></i> 300ë§Œì› ì´ìƒ</div><ul class="rank-list" id="rank-300"></ul></div>
            <div class="rank-card" style="border-top:4px solid #3b82f6;"><div class="rank-title" style="color:#1d4ed8;"><i class="fa-solid fa-thumbs-up"></i> 60ë§Œì› ì´ìƒ</div><ul class="rank-list" id="rank-60"></ul></div>
        </div>
        <h4 style="margin-bottom:15px;">ğŸ‘¥ íŒ€ì›ë³„ ì„±ê³¼ í˜„í™©í‘œ</h4>
        <div class="card"><div class="table-container"><table><thead><tr><th>ìˆœìœ„</th><th>íŒ€ì›ëª…</th><th>DBë°°ì •</th><th>ë¯¸íŒ…</th><th>ê°€ë§</th><th>ê³„ì•½</th><th>ì „í™˜ìœ¨</th><th>ì´ ë§¤ì¶œ</th><th>ìƒíƒœ</th></tr></thead><tbody id="team-status-body"></tbody></table></div></div>
    </div>
</div>

<div class="modal-overlay" id="member-modal">
    <div class="modal-window">
        <div class="modal-header"><h3><i class="fa-solid fa-users-gear"></i> íŒ€ì› ê´€ë¦¬</h3><button onclick="closeMemberModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">Ã—</button></div>
        <div class="modal-body">
            <div style="font-size:13px; color:#64748b; margin-bottom:15px; background:#f8fafc; padding:12px; border-radius:8px;">ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” <b>1234</b>ì…ë‹ˆë‹¤.</div>
            <div id="member-list-container" style="border:1px solid #e2e8f0; border-radius:8px; max-height:400px; overflow-y:auto;"></div>
            <div class="add-member-row"><input type="text" id="new-member-name" placeholder="ìƒˆ íŒ€ì› ì´ë¦„"><button class="btn btn-primary" onclick="addTeamMember()"><i class="fa-solid fa-plus"></i> ì¶”ê°€</button></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="member-request-modal">
    <div class="modal-window" style="width:600px; height:auto; max-height:85vh;">
        <div class="modal-header" style="background:linear-gradient(135deg, #fef3c7, #fde68a);"><h3><i class="fa-solid fa-comment-dots"></i> ê±´ì˜ì‚¬í•­/ì§ˆë¬¸</h3><button onclick="closeMemberRequestModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">Ã—</button></div>
        <div class="modal-body" style="display:block; padding:20px; overflow-y:auto;">
            <div style="margin-bottom:20px;">
                <label style="font-weight:700; font-size:13px; color:#64748b; display:block; margin-bottom:8px;">ìƒˆ ê±´ì˜ì‚¬í•­/ì§ˆë¬¸ ì‘ì„±</label>
                <textarea id="member-request-input" placeholder="ê´€ë¦¬ìì—ê²Œ ì „ë‹¬í•  ê±´ì˜ì‚¬í•­ì´ë‚˜ ì§ˆë¬¸ì„ ì‘ì„±í•˜ì„¸ìš”..." style="width:100%; min-height:100px; padding:12px; border:2px solid #fcd34d; border-radius:8px; font-size:14px; resize:vertical; background:#fffbeb;"></textarea>
                <button class="btn btn-warning" style="margin-top:10px; width:100%;" onclick="submitMemberRequest()"><i class="fa-solid fa-paper-plane"></i> ì „ì†¡í•˜ê¸°</button>
            </div>
            <div style="border-top:1px solid #e2e8f0; padding-top:15px;">
                <div style="font-weight:700; font-size:13px; color:#64748b; margin-bottom:10px;">ğŸ“‹ ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ ëª©ë¡</div>
                <div id="my-request-list" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="admin-request-modal">
    <div class="modal-window" style="width:800px; height:auto; max-height:90vh;">
        <div class="modal-header" style="background:#1e293b; color:white;"><h3><i class="fa-solid fa-envelope-open-text"></i> íŒ€ì› ìš”ì²­ê¸€ ê´€ë¦¬</h3><button onclick="closeAdminRequestModal()" style="border:none; background:none; font-size:24px; cursor:pointer; color:white;">Ã—</button></div>
        <div class="modal-body" style="display:block; padding:20px; overflow-y:auto;">
            <div id="admin-request-list"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal-window">
        <div class="modal-header"><h3>ğŸ“ DB ì •ë³´ ìƒì„¸</h3><button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">Ã—</button></div>
        <div class="modal-body">
            <div class="panel-left">
                <div id="modal-overlay-lock"></div>
                
                <input type="hidden" id="edit-id">
                
                <div id="admin-reassign-panel" style="display:none; background:linear-gradient(135deg, #fef08a, #fde047); padding:15px; border-radius:12px; margin-bottom:15px; border:2px solid #eab308; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="font-weight:900; color:#854d0e; margin-bottom:10px;"><i class="fa-solid fa-rocket"></i> [ê´€ë¦¬ì ì „ìš©] ë‹¤ë¥¸ íŒ€ì›ì—ê²Œ ê°•ì œ ì¬ë°°ì • (ë³µì œ/ë™ê²° ì‹œìŠ¤í…œ)</div>
                    <div style="display:flex; gap:10px;">
                        <select id="admin-reassign-target" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ca8a04; font-weight:bold; outline:none;"></select>
                        <button class="btn btn-dark" onclick="executeRedistribution()"><i class="fa-solid fa-shuffle"></i> ì¬ë°°ì • ì‹¤í–‰</button>
                    </div>
                </div>

                <div id="reassign-req-area" style="display:none; margin-bottom:15px; text-align:right;">
                    <button class="btn btn-warning" onclick="requestRedistribution()" style="box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);"><i class="fa-solid fa-rotate"></i> SMì·¨í•©/ì¬ë¶„ë°° ìš”ì²­í•˜ê¸°</button>
                </div>

                <div id="modal-summary-card" style="display:none; background:linear-gradient(135deg,#1e3a8a,#3b82f6); color:white; padding:16px 20px; border-radius:12px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div><div style="font-size:11px; opacity:0.7;">ì—…ì²´ëª…</div><div id="sum-company" style="font-size:18px; font-weight:800;"></div></div>
                        <div style="text-align:center;"><div style="font-size:11px; opacity:0.7;">ì§„í–‰ìƒíƒœ</div><div id="sum-status" style="font-size:14px; font-weight:bold;"></div></div>
                        <div style="text-align:right;"><div style="font-size:11px; opacity:0.7;">ì´ ê³„ì•½ê¸ˆì•¡</div><div id="sum-amount" style="font-size:18px; font-weight:800;"></div></div>
                    </div>
                    <div id="sum-share-bar" style="margin-top:10px; display:none;">
                        <div style="font-size:11px; opacity:0.7; margin-bottom:4px;">ì‰ì–´ ë°°ë¶„</div>
                        <div id="sum-share-visual" style="display:flex; height:8px; border-radius:4px; overflow:hidden; background:rgba(255,255,255,0.2);"></div>
                        <div id="sum-share-labels" style="display:flex; gap:10px; margin-top:4px; font-size:10px; flex-wrap:wrap;"></div>
                    </div>
                </div>
                <div class="card" style="margin:0 0 20px 0; border-left:4px solid var(--primary);">
                    <div style="color:var(--primary); font-weight:800; margin-bottom:10px;">1ë‹¨ê³„: ì—…ì²´ ê¸°ë³¸ì •ë³´</div>
                    <div style="background:#f8fafc; padding:12px; margin-bottom:15px; border-radius:8px; font-size:14px;"><span style="color:#64748b;">ë‹´ë‹¹ì:</span> <span id="display-member" style="font-weight:bold;"></span></div>
                    <div class="form-grid">
                        <div class="form-group"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="input-date" onclick="this.showPicker()"></div>
                        <div class="form-group"><label>DB ì¶œì²˜</label><select id="input-source" onchange="updateShareFields(); toggleGradeField(); calculateShare();"><option value="íšŒì‚¬DB">ğŸ¢ íšŒì‚¬ DB</option><option value="ê°œì¸DB">ğŸ‘¤ ê°œì¸ DB</option><option value="íŒ€DB">ğŸ‘¥ íŒ€ DB</option><option value="ì¶”ì¥í˜¸DB">ğŸ¯ ì¶”ì¥í˜¸ DB</option><option value="ê¸°íƒ€DB">ğŸ¸ ê¸°íƒ€ DB</option></select></div>
                        <div class="form-group" id="group-grade-prov"><label>ì œê³µ ë“±ê¸‰</label><select id="input-grade-prov"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
                        <div class="form-group">
                            <label>ì—…ì²´ëª… <span style="color:red">*</span></label>
                            <input type="text" id="input-company" placeholder="í•„ìˆ˜ ì…ë ¥" onkeydown="if(event.key === 'Enter') event.preventDefault();">
                        </div>
                        <div class="form-group"><label>ëŒ€í‘œì</label><input type="text" id="input-ceo"></div>
                        <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="input-phone"></div>
                        <div class="form-group"><label>ì—…ì¢…</label><select id="input-industry"><option value="">ì„ íƒ</option><option value="ì œì¡°">ì œì¡°</option><option value="ê±´ì„¤">ê±´ì„¤</option><option value="ë„ì†Œë§¤">ë„ì†Œë§¤</option><option value="ì„œë¹„ìŠ¤">ì„œë¹„ìŠ¤</option><option value="IT">IT</option><option value="ìŒì‹ì ">ìŒì‹ì </option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                        <div class="form-group"><label>ë§¤ì¶œ ê·œëª¨</label><select id="input-revenue"><option value="ë¯¸í™•ì¸">ë¯¸í™•ì¸</option><option value="1ì–µë¯¸ë§Œ">1ì–µ ë¯¸ë§Œ</option><option value="1ì–µ~3ì–µ">1ì–µ~3ì–µ</option><option value="3ì–µì´ìƒ">3ì–µ ì´ìƒ</option><option value="5ì–µì´ìƒ">5ì–µ ì´ìƒ</option><option value="10ì–µì´ìƒ">10ì–µ ì´ìƒ</option><option value="30ì–µì´ìƒ">30ì–µ ì´ìƒ</option></select></div>
                    </div>
                </div>
                <div class="card" style="margin:0 0 20px 0; border-left:4px solid #f59e0b;">
                    <div style="color:#b45309; font-weight:800; margin-bottom:10px;">2ë‹¨ê³„: ì „í™” ê²€ì¦</div>
                    <div class="form-grid">
                        <div class="form-group"><label>í†µí™”ì—¬ë¶€</label><select id="input-call-status"><option value="">ì„ íƒ</option><option value="ë¶€ì¬ì¤‘">ë¶€ì¬ì¤‘</option><option value="ì—°ì†ë¶€ì¬ ë¬¸ìì „ì†¡">ì—°ì†ë¶€ì¬ ë¬¸ìì „ì†¡</option><option value="ì¥ë‚œDB">ì¥ë‚œDB</option><option value="ì¬í†µí™”ìš”ì²­">ì¬í†µí™”ìš”ì²­</option><option value="í†µí™”ì™„ë£Œ">í†µí™”ì™„ë£Œ</option></select></div>
                        <div class="form-group"><label>ëŒ€í‘œ ì‹ ìš©ì ìˆ˜</label><select id="input-credit"><option value="">ë¯¸í™•ì¸</option><option value="900ì´ìƒ">900ì  ì´ìƒ</option><option value="800ì´ìƒ">800ì  ì´ìƒ</option><option value="700ì´ìƒ">700ì  ì´ìƒ</option><option value="700ë¯¸ë§Œ">700ì  ë¯¸ë§Œ</option><option value="ì‚¬ê³ ì´ë ¥">ì‚¬ê³  ì´ë ¥</option></select></div>
                        <div class="form-group"><label>ì—°ë§¤ì¶œ (ë°±ë§Œì›)</label><input type="text" id="input-annual-rev" onkeyup="formatCurrency(this)"></div>
                        <div class="form-group"><label>ì„¸ê¸ˆ ì²´ë‚©ì—¬ë¶€</label><select id="input-tax"><option value="ì™„ë‚©">ì™„ë‚©</option><option value="ë¶„ë‚©ì¤‘">ë¶„ë‚©ì¤‘</option><option value="ì—°ì²´ì¤‘">ì—°ì²´ì¤‘</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                        <div class="form-group"><label>ì§€ì—­</label><select id="input-region"><option value="">ì„ íƒ</option><option value="ì„œìš¸">ì„œìš¸</option><option value="ê²½ê¸°">ê²½ê¸°</option><option value="ì¸ì²œ">ì¸ì²œ</option><option value="ë¶€ì‚°">ë¶€ì‚°</option><option value="ëŒ€êµ¬">ëŒ€êµ¬</option><option value="ê´‘ì£¼">ê´‘ì£¼</option><option value="ëŒ€ì „">ëŒ€ì „</option><option value="ìš¸ì‚°">ìš¸ì‚°</option><option value="ì„¸ì¢…">ì„¸ì¢…</option><option value="ê°•ì›">ê°•ì›</option><option value="ì¶©ë¶">ì¶©ë¶</option><option value="ì¶©ë‚¨">ì¶©ë‚¨</option><option value="ì „ë¶">ì „ë¶</option><option value="ì „ë‚¨">ì „ë‚¨</option><option value="ê²½ë¶">ê²½ë¶</option><option value="ê²½ë‚¨">ê²½ë‚¨</option><option value="ì œì£¼">ì œì£¼</option></select></div>
                        <div class="form-group"><label>ë¯¸íŒ… ì¼ì •</label><input type="date" id="input-meet-date" onclick="this.showPicker()"></div>
                    </div>
                    <div class="form-group" style="margin-top:15px;">
                        <label><i class="fas fa-phone-volume" style="color:#f59e0b;"></i> ì „í™”ì´ìŠˆ ë©”ëª¨</label>
                        <textarea id="input-phone-issue" placeholder="ë¶€ì¬ì¤‘ ì¬ ì‹œë„ ê¸°ë¡ and í†µí™” í›„ ì²´í¬ì‚¬í•­ ê¸°ë¡" style="width:100%; min-height:80px; padding:12px; border:2px solid #fcd34d; border-radius:8px; background:#fffbeb; font-size:14px; resize:vertical;"></textarea>
                    </div>
                </div>
                <div class="card" style="margin:0; border-left:4px solid #10b981;">
                    <div style="color:#047857; font-weight:800; margin-bottom:10px;">3ë‹¨ê³„: ì§„í–‰ ë° ê³„ì•½</div>
                    <div class="form-group"><label>í˜„ì¬ ìƒíƒœ</label><select id="input-status" style="padding:12px; font-weight:bold;" onchange="toggleStatusFields()"><option value="ëŒ€ê¸°">â³ ëŒ€ê¸°</option><option value="ì§„í–‰ì¤‘">ğŸƒ ì§„í–‰ì¤‘</option><option value="ê°€ë§ê³ ê°">ğŸŒŸ ê°€ë§ê³ ê°</option><option value="ê³„ì•½">ğŸ‰ ê³„ì•½</option><option value="ì¢…ë£Œ">âŒ ì¢…ë£Œ</option><option value="ë°˜ë‚©ëŒ€ê¸°" style="display:none;">âš ï¸ ë°˜ë‚©ëŒ€ê¸°(ì ê¸ˆ)</option></select></div>
                    <div id="box-wait" class="dynamic-section"><div class="form-group"><label>ëŒ€ê¸° ì‚¬ìœ </label><input type="text" id="input-wait-reason"></div></div>
                    <div id="box-ing" class="dynamic-section"><div class="form-group"><label>ì§„í–‰ ìƒì„¸</label><textarea id="input-ing-detail" rows="3"></textarea></div></div>
                    <div id="box-prospect" class="dynamic-section prospect-box"><div class="form-group"><label>ğŸŒŸ ê°€ë§ê³ ê° í¬ì¸íŠ¸</label><textarea id="input-prospect-detail" rows="3"></textarea></div></div>
                    <div id="box-end" class="dynamic-section"><div class="form-group"><label>ì¢…ë£Œ ì‚¬ìœ </label><input type="text" id="input-end-reason"></div></div>
                    <div id="box-contract" class="dynamic-section contract-box">
                        <div class="form-grid">
                            <div class="form-group"><label>ê³„ì•½ì¼</label><input type="date" id="input-contract-date" onclick="this.showPicker()"></div>
                            <div class="form-group"><label>ê³„ì•½ ìƒí’ˆ</label><input type="text" id="input-product" placeholder="ì˜ˆ)êµë³´ê²½ì •"></div>
                            <div class="form-group"><label>ê³„ì•½ ê¸ˆì•¡ (ì›)</label><input type="text" id="input-amount" onkeyup="formatCurrency(this); calculateShare();"></div>
                        </div>
                        <div class="share-info" id="share-calculator">
                            <div style="font-weight:bold; margin-bottom:10px;">ğŸ“Š ì‰ì–´ ê³„ì‚°ê¸° <span style="font-size:11px; color:#ef4444;">* ì‰ì–´ë°›ëŠ” íŒ€ì¥ë§Œ ì…ë ¥</span></div>
                            <div class="share-row"><span style="width:20px;">1</span><select id="share-partner-1" onchange="calculateShare()"><option value="">ì„ íƒ</option></select><input type="number" id="share-percent-1" oninput="calculateShare()"> % <span class="share-val" id="share-val-1">0</span></div>
                            <div class="share-row"><span style="width:20px;">2</span><select id="share-partner-2" onchange="calculateShare()"><option value="">ì„ íƒ</option></select><input type="number" id="share-percent-2" oninput="calculateShare()"> % <span class="share-val" id="share-val-2">0</span></div>
                            <div class="share-row"><span style="width:20px;">3</span><select id="share-partner-3" onchange="calculateShare()"><option value="">ì„ íƒ</option></select><input type="number" id="share-percent-3" oninput="calculateShare()"> % <span class="share-val" id="share-val-3">0</span></div>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #e2e8f0; display:flex; justify-content:space-between; font-weight:bold;"><span>ì´ì•¡: <span id="disp-total">0</span></span><span style="color:blue;">ë‚´ ì‹¤ì : <span id="disp-net">0</span></span></div>
                        </div>
                    </div>
                    <div id="btn-roadmap-area" style="display:none; margin-top:20px;"><button class="btn btn-dark" style="width:100%; padding:15px;" onclick="openRoadmapPopup()"><i class="fa-solid fa-diagram-project"></i> ì»¨ì„¤íŒ… ë¡œë“œë§µ ê´€ë¦¬</button></div>
                    <div class="form-group" style="margin-top:15px;"><label>ìƒë‹´ë‚´ìš© ë° ì»¨ì„¤íŒ… ë°©í–¥</label><textarea id="input-consulting" rows="3"></textarea></div>
                </div>
            </div>
            <div class="panel-right">
                <h4><i class="fa-regular fa-clock"></i> í™œë™ ë¡œê·¸</h4>
                <div style="font-size:12px; color:#64748b; margin-bottom:10px; background:#f1f5f9; padding:12px; border-radius:8px;">ì‹¤ì‹œê°„ ì§„í–‰ê³¼ì • or ë†“ì¹˜ì§€ ë§ì•„ì•¼ í•  ë©”ëª¨ê¸°ë¡!</div>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="hist-input" placeholder="ë‚´ìš© ì…ë ¥" style="flex:1;" onkeypress="if(event.keyCode==13) addLog()"><button onclick="addLog()" class="btn btn-primary">ë“±ë¡</button></div>
                <div id="log-list" style="flex:1; overflow-y:auto; border-top:1px solid #eee; padding-top:10px;"></div>
                <div style="margin-top:auto; display:flex; gap:5px;" id="modal-action-buttons">
                    <button onclick="saveData()" class="btn btn-primary" style="flex:1;">ì €ì¥</button>
                    <button onclick="deleteData()" class="btn btn-danger">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="roadmap-modal">
    <div class="modal-window">
        <div class="modal-header"><h3><i class="fa-solid fa-diagram-project"></i> ì»¨ì„¤íŒ… ë¡œë“œë§µ</h3><button onclick="closeRoadmapPopup()" style="border:none; background:none; font-size:24px; cursor:pointer;">Ã—</button></div>
        <div class="modal-body" style="background:#fff;">
            <div class="roadmap-toolbar">
                <div style="font-weight:800; margin-bottom:10px;">ë¹ ë¥¸ í•­ëª© ì¶”ê°€</div>
                <div class="roadmap-presets" id="rm-presets"></div>
                <div class="rm-input-row" id="rm-input-box">
                    <div class="rm-input-group" style="flex:2;"><span>í•­ëª©ëª…</span><input type="text" id="rm-name" style="padding:10px; border:1px solid #cbd5e1; border-radius:6px;"></div>
                    <div class="rm-input-group" style="flex:1;"><span>ì‹œì‘</span><select id="rm-start" style="padding:10px; border:1px solid #cbd5e1; border-radius:6px;"></select></div>
                    <div class="rm-input-group" style="flex:1;"><span>ì¢…ë£Œ</span><select id="rm-end" style="padding:10px; border:1px solid #cbd5e1; border-radius:6px;"></select></div>
                    <div class="rm-input-group" style="flex:1;"><span>ì •ë ¬</span><select id="rm-align" style="padding:10px; border:1px solid #cbd5e1; border-radius:6px;"><option value="center">ê°€ìš´ë°</option><option value="left">ì¢Œì¸¡</option><option value="right">ìš°ì¸¡</option><option value="out">ë°”ê¹¥</option></select></div>
                    <div class="rm-input-group" style="flex:3;"><span>ì§„í–‰ë‚´ìš©</span><input type="text" id="rm-desc" placeholder="ë‚´ìš© ì…ë ¥ ì¤‘ // ì…ë ¥ì‹œ ì¤„ë°”ê¿” í‘œì‹œë¨" style="padding:10px; border:1px solid #cbd5e1; border-radius:6px;"></div>
                    <div style="display:flex; flex-direction:column; gap:5px; margin-top:auto;"><button class="btn btn-primary" id="btn-add-rm" onclick="addManualRoadmap()"><i class="fa-solid fa-plus"></i> ì¶”ê°€</button><button class="btn btn-secondary" id="btn-cancel-rm" style="display:none;" onclick="resetRoadmapInput()">ì·¨ì†Œ</button></div>
                </div>
            </div>
            <div id="rm-list" style="margin-bottom:15px; padding:10px; border:1px dashed #cbd5e1; border-radius:8px;"></div>
            <div class="rm-container">
                <div id="roadmap-print-area">
                    <div contenteditable="true" id="print-company-name" class="rm-title-edit">Project Schedule</div>
                    <div style="font-size:14px; color:#64748b; margin-bottom:20px; text-align:right;" id="print-member-name"></div>
                    <table class="rm-table"><thead><tr id="rm-header-row-1"><th class="rm-header rm-diagonal" style="width:120px;" rowspan="2"><span class="rm-diagonal-text rm-text-bottom-left">í•­ëª©</span><span class="rm-diagonal-text rm-text-top-right">ì¼ì •</span></th></tr><tr id="rm-header-row-2"></tr></thead><tbody id="rm-body"></tbody></table>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:20px; border-top:1px solid #eee;"><button class="btn btn-primary" style="padding:15px 30px;" onclick="saveRoadmap()">ì €ì¥ í›„ ë‹«ê¸°</button><button class="btn btn-dark" style="padding:15px 30px;" onclick="printRoadmap()"><i class="fa-solid fa-print"></i> ì¸ì‡„</button></div>
        </div>
    </div>
</div>

<script>const GAS_URL = 'https://script.google.com/macros/s/AKfycbwcLiEa_C-BkOBPwugpKJdKfYGXeAEx_KVWpvtsUym7dXq_atZvIV2K1s10gEnMcEm4RA/exec';
function sha256(ascii){function rightRotate(v,a){return(v>>>a)|(v<<(32-a))}var mathPow=Math.pow;var maxWord=mathPow(2,32);var lengthProperty='length';var i,j;var result='';var words=[];var asciiBitLength=ascii[lengthProperty]*8;var hash=[0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19];var k=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];ascii+='\x80';while(ascii[lengthProperty]%64-56)ascii+='\x00';for(i=0;i<ascii[lengthProperty];i++){j=ascii.charCodeAt(i);if(j>>8)return;words[i>>2]|=j<<((3-i)%4)*8}words[words[lengthProperty]]=((asciiBitLength/maxWord)|0);words[words[lengthProperty]]=(asciiBitLength);for(j=0;j<words[lengthProperty];){var w=words.slice(j,j+=16);var oldHash=hash;hash=hash.slice(0,8);for(i=0;i<64;i++){var w15=w[i-15],w2=w[i-2];var a=hash[0],e=hash[4];var temp1=hash[7]+(rightRotate(e,6)^rightRotate(e,11)^rightRotate(e,25))+((e&hash[5])^((~e)&hash[6]))+k[i]+(w[i]=(i<16)?w[i]:(w[i-16]+(rightRotate(w15,7)^rightRotate(w15,18)^(w15>>>3))+w[i-7]+(rightRotate(w2,17)^rightRotate(w2,19)^(w2>>>10)))|0);var temp2=(rightRotate(a,2)^rightRotate(a,13)^rightRotate(a,22))+((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));hash=[(temp1+temp2)|0].concat(hash);hash[4]=(hash[4]+temp1)|0}for(i=0;i<8;i++){hash[i]=(hash[i]+oldHash[i])|0}}for(i=0;i<8;i++){for(j=3;j+1;j--){var b=(hash[i]>>(j*8))&255;result+=((b<16)?0:'')+b.toString(16)}}return result}
let members=[],dbList=[],currentUser=null,tempLogs=[],currentId=null,historyTab='prospect';
let isAdminLogAdded=false,tempRoadmap=[],editIndex=-1,dragSrcEl=null,dragSrcIndex=null,isDragging=false;
let isModalDirty=false,requestList=[];
let isDataLoaded=false;
let currentPage=1, pageSize=30, totalFilteredData=[];
let calYear, calMonth, revenueChartInstance=null;
const roadmapItems=["ì‹ ë³´","ê¸°ë³´","ì‹ ìš©ë³´ì¦ì¬ë‹¨","ì†Œì§„ê³µ","ì¤‘ì§„ê³µ","ë²•ì¸ì„¤ë¦½(ì „í™˜)","íŠ¹í—ˆ","ë²¤ì²˜ì¸ì¦","ì—°êµ¬ì „ë‹´ë¶€ì„œì„¤ë¦½","ì¬ë¬´ë“±ê¸‰ê´€ë¦¬"];
const colorPalette=['#0f172a','#1e3a8a','#1d4ed8','#3b82f6','#60a5fa','#93c5fd'];
const shareColors=['#ef4444','#f59e0b','#8b5cf6','#10b981','#3b82f6','#ec4899'];

// â˜… ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ í—¬í¼ í•¨ìˆ˜
function sendSystemMessage(toName, text) {
    var msg = { id: Date.now() + Math.floor(Math.random()*1000), from: currentUser.name, to: toName, text: text, time: new Date().toLocaleString(), timestamp: Date.now(), isRead: false, _localPending: true };
    messageList.push(msg);
    saveMsgLocal();
    fetch(GAS_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'send_message', data: msg }) })
    .then(function(r) { return r.json(); }).then(function(d) { if (d.result === 'success') { msg._localPending = false; saveMsgLocal(); } }).catch(function(e) {});
}

// â˜… íŒ€ì›: SMì·¨í•©/ì¬ë¶„ë°° ìš”ì²­ ê¸°ëŠ¥ (ë°©ì–´ ë¡œì§ & ì ê¸ˆ ì²˜ë¦¬ ì™„ë²½íŒ)
function requestRedistribution() {
    var comp = document.getElementById('input-company').value.trim();
    if(!comp) {
        alert("ì—…ì²´ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì—…ì²´ëª…ì„ ë¨¼ì € ê¸°ì…í•´ì£¼ì„¸ìš”.");
        document.getElementById('input-company').focus();
        return;
    }

    var reason = prompt("ì¬ë¶„ë°°(SMì·¨í•©) ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: ì¥ê¸° ë¶€ì¬, ê°€ë§ ì—†ìŒ ë“±)");
    if(reason === null) return; 
    if(reason.trim() === '') return showToast("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.", "error");

    // â˜… ìƒíƒœë¥¼ 'ë°˜ë‚©ëŒ€ê¸°'ë¡œ ì¦‰ì‹œ ë³€ê²½
    document.getElementById('input-status').value = 'ë°˜ë‚©ëŒ€ê¸°';

    var logText = "ğŸ¤– (ì‹œìŠ¤í…œ) ì¬ë¶„ë°° ìš”ì²­ë¨ (ì‚¬ìœ : " + reason + ")";
    tempLogs.unshift({time: new Date().toLocaleString(), text: logText, writer: currentUser.name});
    renderLogs();
    
    var adminUser = members.find(function(m) { return m.role === 'admin'; });
    var adminName = adminUser ? adminUser.name : 'ê´€ë¦¬ì';
    var msgText = "ğŸ¤– [ì‹œìŠ¤í…œ ì•Œë¦¼] " + currentUser.name + " íŒ€ì¥ì´ '" + comp + "' ì—…ì²´ì˜ DB ì¬ë¶„ë°°ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : " + reason;
    sendSystemMessage(adminName, msgText);
    
    isModalDirty = true;
    saveData(true); // ì €ì¥ í›„ ì°½ ë‹«ê¸° ì—°ë™
    showToast("ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìœ¼ë©°, DBê°€ ë°˜ë‚©ëŒ€ê¸°(ì ê¸ˆ) ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// â˜… ê´€ë¦¬ì: ê°•ì œ ì¬ë°°ì • ì‹¤í–‰ ê¸°ëŠ¥ (ë³µì œ & ë™ê²° ë¡œì§ ë° ê¸°ë¡ ì„¸ë¶„í™”)
function executeRedistribution() {
    var targetMem = document.getElementById('admin-reassign-target').value;
    if(!targetMem) return showToast('ì¬ë°°ì •í•  íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
    
    var originalId = document.getElementById('edit-id').value;
    var originalDB = dbList.find(function(x) { return x.id == originalId; });
    if(!originalDB) return showToast('DBë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');

    if(!confirm('[' + targetMem + '] íŒ€ì¥ì—ê²Œ ì´ DBë¥¼ ì¬ë°°ì • í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ê¸°ì¡´ DBëŠ” "ì¢…ë£Œ" ì²˜ë¦¬ë˜ì–´ ë³´ì¡´ë˜ë©°, ìƒˆë¡œìš´ DBê°€ ë³µì œë˜ì–´ íƒ€ê²Ÿ íŒ€ì›ì—ê²Œ ìƒì„±ë©ë‹ˆë‹¤.')) return;

    var compName = document.getElementById('input-company').value.trim() || originalDB.company || 'ì´ë¦„ì—†ìŒ';
    var isTeamRequest = (originalDB.status === 'ë°˜ë‚©ëŒ€ê¸°');

    // 1. ì›ë³¸ DB ë™ê²° ì„¸íŒ…
    document.getElementById('input-status').value = 'ì¢…ë£Œ';
    toggleStatusFields(true);
    
    // â˜… ë°°ì •íŒ€ì¥ê³¼ ì‚¬ìœ ë¥¼ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê¸°ê¸° ìœ„í•´ endReasonì— ì €ì¥ (ë‚˜ì¤‘ì— íˆìŠ¤í† ë¦¬ì—ì„œ íŒŒì‹±)
    var endRsn = isTeamRequest ? 'íŒ€ì›ìš”ì²­(ì¬ë°°ì •->' + targetMem + ')' : 'SMì·¨í•©(ì¬ë°°ì •->' + targetMem + ')';
    document.getElementById('input-end-reason').value = endRsn;
    
    var logText1 = "ğŸ¤– (ì‹œìŠ¤í…œ) ê´€ë¦¬ì ì§ê¶Œìœ¼ë¡œ [" + targetMem + "] íŒ€ì¥ì—ê²Œ ì¬ë°°ì •ë¨";
    tempLogs.unshift({time: new Date().toLocaleString(), text: logText1, writer: currentUser.name});
    
    showLoading();
    var total = parseInt(document.getElementById('input-amount').value.replace(/,/g,'')) || 0;
    
    var frozenObj = {
        id: originalId, member: originalDB.member, date: document.getElementById('input-date').value,
        source: document.getElementById('input-source').value, gradeProv: document.getElementById('input-grade-prov').value,
        company: compName, ceo: document.getElementById('input-ceo').value, phone: document.getElementById('input-phone').value,
        industry: document.getElementById('input-industry').value, revenue: document.getElementById('input-revenue').value,
        callStatus: document.getElementById('input-call-status').value, credit: document.getElementById('input-credit').value,
        annualRev: parseInt(document.getElementById('input-annual-rev').value.replace(/,/g,''))||0, tax: document.getElementById('input-tax').value,
        region: document.getElementById('input-region').value, meetDate: document.getElementById('input-meet-date').value,
        status: 'ì¢…ë£Œ', waitReason: document.getElementById('input-wait-reason').value, ingDetail: document.getElementById('input-ing-detail').value,
        prospectDetail: document.getElementById('input-prospect-detail').value, endReason: endRsn,
        contractDate: document.getElementById('input-contract-date').value, product: document.getElementById('input-product').value,
        totalAmount: total, amount: total, shareList: originalDB.shareList || [], consulting: document.getElementById('input-consulting').value,
        phoneIssue: document.getElementById('input-phone-issue').value, logs: tempLogs, roadmap: tempRoadmap, hasAdminAlert: false
    };

    // 2. ìƒˆ ë³µì œ DB ìƒì„± ì„¸íŒ…
    var newId = Date.now() + 100;
    var clonedLogs = tempLogs.slice();
    clonedLogs.unshift({time: new Date().toLocaleString(), text: "ğŸ¤– (ì‹œìŠ¤í…œ) [" + originalDB.member + "] íŒ€ì¥ìœ¼ë¡œë¶€í„° ì¸ê³„ë°›ì€ ì¬ë°°ì • DBì…ë‹ˆë‹¤.", writer: "ì‹œìŠ¤í…œ"});

    var newObj = {
        id: newId, member: targetMem, date: new Date().toISOString().split('T')[0], 
        source: 'íŒ€DB', gradeProv: frozenObj.gradeProv,
        company: frozenObj.company, ceo: frozenObj.ceo, phone: frozenObj.phone,
        industry: frozenObj.industry, revenue: frozenObj.revenue,
        callStatus: frozenObj.callStatus, credit: frozenObj.credit,
        annualRev: frozenObj.annualRev, tax: frozenObj.tax,
        region: frozenObj.region, meetDate: '', 
        status: 'ëŒ€ê¸°', waitReason: 'ì¬ë°°ì • ìˆ˜ë ¹', ingDetail: frozenObj.ingDetail,
        prospectDetail: frozenObj.prospectDetail, endReason: '',
        contractDate: '', product: '',
        totalAmount: 0, amount: 0, shareList: [], consulting: frozenObj.consulting,
        phoneIssue: frozenObj.phoneIssue, logs: clonedLogs, roadmap: frozenObj.roadmap, hasAdminAlert: true 
    };

    // í†µì‹  ì‹œí€€ìŠ¤: ë™ê²°ë³¸ ì €ì¥ -> ìƒˆ ë³µì œë³¸ ì €ì¥ -> ë§ˆë¬´ë¦¬
    fetch(GAS_URL, { method:'POST', body:JSON.stringify({action:'save', data:frozenObj}) })
    .then(function(r){ return r.json(); })
    .then(function(d1) {
        return fetch(GAS_URL, { method:'POST', body:JSON.stringify({action:'save', data:newObj}) });
    })
    .then(function(r2){ return r2.json(); })
    .then(function(d2) {
        sendSystemMessage(targetMem, "ğŸ¤– [ì•Œë¦¼] ìƒˆë¡œìš´ ì¬ë°°ì • DBê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤! (ì—…ì²´ëª…: " + compName + ")");
        sendSystemMessage(originalDB.member, "ğŸ¤– [ì‹œìŠ¤í…œ] ê·€í•˜ì˜ '" + compName + "' ì—…ì²´ê°€ " + targetMem + " íŒ€ì¥ì—ê²Œ ì¬ë°°ì • ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        hideLoading();
        showToast("ì„±ê³µì ìœ¼ë¡œ ì¬ë°°ì • ë˜ì—ˆìŠµë‹ˆë‹¤.");
        isModalDirty = false;
        closeModal();
        fetchDB(function() { 
            if(document.getElementById('view-dashboard').style.display==='block') renderAdminDashboard(); 
            else renderList(); 
            checkMeetingAlerts(); 
            setupHistoryTabs(); // NEW ë±ƒì§€ ê°±ì‹ ìš©
        });
    })
    .catch(function(e) {
        hideLoading(); showToast('ì¬ë°°ì • ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

function getVirtualShareEntries(partnerName){var entries=[];dbList.forEach(function(d){if(d.status!=='ê³„ì•½'||!d.shareList||!Array.isArray(d.shareList))return;d.shareList.forEach(function(s){if(s.partner===partnerName&&s.amount>0){entries.push({id:d.id,member:partnerName,date:d.contractDate||d.date,source:d.member+'ì‰ì–´',company:d.company,status:'ê³„ì•½',amount:s.amount,totalAmount:s.amount,contractDate:d.contractDate||d.date,product:d.product||'',ceo:d.ceo||'',phone:d.phone||'',region:d.region||'',industry:d.industry||'',meetDate:'',callStatus:'',isVirtualShare:true,originalId:d.id,originalMember:d.member,sharePercent:s.percent})}});});return entries}
function getShareRevenue(memberName,year,month){var rev=0;getVirtualShareEntries(memberName).forEach(function(e){var p=parseDBDate(e.contractDate);if(year&&p.year!==year)return;if(month&&p.month!==month)return;rev+=e.amount});return rev}
function getSpecialPartnerRevenue(partnerName,year,month){var rev=0;dbList.forEach(function(d){if(d.status!=='ê³„ì•½'||!d.shareList||!Array.isArray(d.shareList))return;var cd=getContractDate(d);var p=parseDBDate(cd);if(year&&p.year!==year)return;if(month&&p.month!==month)return;d.shareList.forEach(function(s){if(s.partner===partnerName&&s.amount>0)rev+=s.amount})});return rev}
function getShareContractCount(memberName,year,month){var count=0;getVirtualShareEntries(memberName).forEach(function(e){var p=parseDBDate(e.contractDate);if(year&&p.year!==year)return;if(month&&p.month!==month)return;count++});return count}
function isExternalPartner(name){if(!name)return false;if(name==='íšŒì‚¬')return true;if(/\d.*íŒ€/.test(name))return true;return false}
function getTeamRevenue(contracts){var total=0;contracts.forEach(function(d){var amt=parseInt(String(d.totalAmount||d.amount).toString().replace(/,/g,''))||0;total+=amt;if(d.shareList&&Array.isArray(d.shareList)){d.shareList.forEach(function(s){if(isExternalPartner(s.partner)&&s.amount>0)total-=s.amount})}});return total}
window.onload=function(){var now=new Date();calYear=now.getFullYear();calMonth=now.getMonth();fetchDB(function(){isDataLoaded=true;var lastId=localStorage.getItem('last_login_id');var lastPw=localStorage.getItem('last_login_pw');if(lastId&&lastPw){document.getElementById('login-user-name').value=lastId;document.getElementById('login-remember').checked=true;var user=members.find(function(m){return m.name===lastId});if(user&&user.pw===lastPw)processLoginSuccess(user)}});initDateSelects()};
function showLoading(){document.getElementById('loading-overlay').style.display='flex'}
function hideLoading(){document.getElementById('loading-overlay').style.display='none'}
function showToast(msg,type){if(!type)type='success';var c=document.getElementById('toast-container');var t=document.createElement('div');t.className='toast '+type;var icon=type==='success'?'fa-circle-check':type==='warning'?'fa-triangle-exclamation':'fa-circle-exclamation';var color=type==='success'?'var(--success)':type==='warning'?'var(--warning)':'var(--danger)';t.innerHTML='<i class="fa-solid '+icon+'" style="color:'+color+'"></i> '+msg;c.appendChild(t);setTimeout(function(){t.style.animation='fadeOut 0.3s forwards';setTimeout(function(){t.remove()},300)},3000)}
function toggleMobileMenu(){if(window.innerWidth>768)return;var sidebar=document.getElementById('app-sidebar');var overlay=document.getElementById('mobile-sidebar-overlay');if(sidebar.classList.contains('active')){sidebar.classList.remove('active');overlay.style.display='none'}else{sidebar.classList.add('active');overlay.style.display='block'}}
function parseDBDate(dateStr){if(!dateStr)return{year:0,month:0};try{var dateObj=new Date(dateStr);if(!isNaN(dateObj.getTime()))return{year:dateObj.getFullYear(),month:dateObj.getMonth()+1};var parts=dateStr.match(/(\d{4})[\.\-\/]\s?(\d{1,2})[\.\-\/]\s?(\d{1,2})/);if(parts)return{year:parseInt(parts[1]),month:parseInt(parts[2])}}catch(e){}return{year:0,month:0}}
function getContractDate(d){return d.contractDate||d.date}
function getDdayText(meetDateStr){if(!meetDateStr)return'';var today=new Date();today.setHours(0,0,0,0);var meetDate=new Date(meetDateStr);meetDate.setHours(0,0,0,0);var diffDays=Math.ceil((meetDate-today)/(1000*60*60*24));if(diffDays===0)return' <span class="dday-badge dday-today">D-DAY</span>';else if(diffDays>0&&diffDays<=7)return' <span class="dday-badge dday-soon">D-'+diffDays+'</span>';return''}
function getCallStatusBadge(callStatus){if(!callStatus)return'<span class="call-badge call-none">-</span>';var badgeClass='call-none';if(callStatus==='ë¶€ì¬ì¤‘')badgeClass='call-absent';else if(callStatus==='ì¥ë‚œDB')badgeClass='call-joke';else if(callStatus==='ì¬í†µí™”ìš”ì²­')badgeClass='call-recall';else if(callStatus==='í†µí™”ì™„ë£Œ')badgeClass='call-done';return'<span class="call-badge '+badgeClass+'">'+callStatus+'</span>'}
function checkMeetingAlerts(){if(!currentUser)return;var today=new Date();today.setHours(0,0,0,0);var myDB=currentUser.role==='admin'?dbList:dbList.filter(function(d){return d.member===currentUser.name});var todayCount=0,upcomingCount=0,overdueCount=0,meetingDetails=[];myDB.forEach(function(d){if(!d.meetDate||d.status==='ê³„ì•½'||d.status==='ì¢…ë£Œ')return;var meetDate=new Date(d.meetDate);meetDate.setHours(0,0,0,0);var diffDays=Math.ceil((meetDate-today)/(1000*60*60*24));if(diffDays===0){todayCount++;meetingDetails.push({company:d.company,type:'today',date:d.meetDate,id:d.id})}else if(diffDays>0&&diffDays<=3){upcomingCount++;meetingDetails.push({company:d.company,type:'upcoming',date:d.meetDate,days:diffDays,id:d.id})}else if(diffDays<0&&diffDays>=-7){overdueCount++;meetingDetails.push({company:d.company,type:'overdue',date:d.meetDate,days:Math.abs(diffDays),id:d.id})}});var badge=document.getElementById('meeting-alert-badge');badge.dataset.details=JSON.stringify(meetingDetails);if(todayCount>0){badge.innerHTML='<span class="meeting-badge meeting-today"><i class="fa-solid fa-bell"></i> ì˜¤ëŠ˜ ë¯¸íŒ… '+todayCount+'ê±´</span>';badge.style.display='block'}else if(overdueCount>0){badge.innerHTML='<span class="meeting-badge meeting-overdue"><i class="fa-solid fa-exclamation-triangle"></i> ì§€ë‚œ ë¯¸íŒ… '+overdueCount+'ê±´</span>';badge.style.display='block'}else if(upcomingCount>0){badge.innerHTML='<span class="meeting-badge meeting-upcoming"><i class="fa-solid fa-calendar"></i> ì˜ˆì • ë¯¸íŒ… '+upcomingCount+'ê±´</span>';badge.style.display='block'}else{badge.style.display='none'}}
function showMeetingList(){var badge=document.getElementById('meeting-alert-badge');var details=JSON.parse(badge.dataset.details||'[]');if(details.length===0)return;var msg='ğŸ“… ë¯¸íŒ… ì¼ì • ì•Œë¦¼\n\n';details.forEach(function(m){if(m.type==='today')msg+='ğŸ”´ ì˜¤ëŠ˜: '+m.company+'\n';else if(m.type==='upcoming')msg+='ğŸ”µ '+m.days+'ì¼ í›„: '+m.company+' ('+m.date+')\n';else if(m.type==='overdue')msg+='âš ï¸ '+m.days+'ì¼ ì „: '+m.company+' ('+m.date+')\n'});alert(msg)}
function fetchDB(callback){if(!GAS_URL)return showToast('URL ì„¤ì • í•„ìš”','error');document.getElementById('login-loading').style.display='block';fetch(GAS_URL).then(function(res){return res.json()}).then(function(data){document.getElementById('login-loading').style.display='none';if(data.db)dbList=data.db;else dbList=[];if(data.members)members=data.members;if(data.requests)requestList=data.requests;else requestList=[];dbList.sort(function(a,b){var dateA=new Date(a.date).getTime()||0;var dateB=new Date(b.date).getTime()||0;if(dateB!==dateA)return dateB-dateA;return(Number(b.id)||0)-(Number(a.id)||0)});if(callback)callback();checkMeetingAlerts();updateRequestBadge()}).catch(function(err){document.getElementById('login-loading').style.display='none';console.error(err);showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨','error')})}
function updateRequestBadge(){if(!currentUser||currentUser.role!=='admin')return;var unreadCount=requestList.filter(function(r){return!r.isRead}).length;var badge=document.getElementById('request-badge');if(unreadCount>0){badge.style.display='inline';badge.innerText=unreadCount}else{badge.style.display='none'}}
function attemptLogin(type){var inputName=document.getElementById('login-user-name').value.trim();var inputPw=document.getElementById('login-pw').value;if(!inputName)return showToast("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",'error');if(!inputPw)return showToast("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",'error');if(!isDataLoaded){return showToast("ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.",'warning')}var user=members.find(function(m){return m.name===inputName});if(!user)return showToast("ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.",'error');var hashedInput=sha256(inputPw);if(user.pw!==hashedInput)return showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.",'error');if(type==='admin'&&user.role!=='admin')return showToast("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.",'error');processLoginSuccess(user)}
function processLoginSuccess(user){currentUser=user;var isRemember=document.getElementById('login-remember').checked;if(isRemember){localStorage.setItem('last_login_id',user.name);localStorage.setItem('last_login_pw',user.pw)}else{localStorage.removeItem('last_login_id');localStorage.removeItem('last_login_pw')}document.getElementById('login-screen').style.display='none';document.getElementById('app-sidebar').style.display='flex';document.getElementById('app-main').style.display='flex';document.getElementById('profile-name').innerText=user.name;document.getElementById('profile-role').innerText=user.role==='admin'?'Admin Master':'Team Leader';if(user.role==='admin'){document.getElementById('app-sidebar').classList.add('admin-mode');document.getElementById('admin-menu').style.display='block';document.getElementById('admin-yoy-summary').style.display='block';document.getElementById('menu-list-text').innerText='íŒ€ì› DB ê´€ë¦¬';document.getElementById('page-title').innerText='íŒ€ì› DB ê´€ë¦¬';document.getElementById('nav-member-request').style.display='none';document.getElementById('member-perf-section').style.display='none'}else{document.getElementById('app-sidebar').classList.remove('admin-mode');document.getElementById('admin-menu').style.display='none';document.getElementById('admin-yoy-summary').style.display='none';document.getElementById('menu-list-text').innerText='ë‚˜ì˜ DB ê´€ë¦¬';document.getElementById('page-title').innerText='ë‚˜ì˜ DB ê´€ë¦¬';document.getElementById('nav-member-request').style.display='flex';document.getElementById('member-perf-section').style.display='block'}setupHistoryTabs();checkMeetingAlerts();updateRequestBadge();loadMessages(function(){updateMsgBadge()});navTo('list')}
function openMemberModal(){document.getElementById('member-modal').style.display='flex';renderMemberList()}
function closeMemberModal(){document.getElementById('member-modal').style.display='none';document.getElementById('new-member-name').value=''}
function openMemberRequestModal(){document.getElementById('member-request-modal').style.display='flex';renderMyRequests()}
function closeMemberRequestModal(){document.getElementById('member-request-modal').style.display='none';document.getElementById('member-request-input').value=''}
function openAdminRequestModal(){document.getElementById('admin-request-modal').style.display='flex';renderAdminRequests();markRequestsAsRead()}
function closeAdminRequestModal(){document.getElementById('admin-request-modal').style.display='none'}
function submitMemberRequest(){var content=document.getElementById('member-request-input').value.trim();if(!content)return showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.','error');var newRequest={id:Date.now(),member:currentUser.name,content:content,date:new Date().toLocaleString(),isRead:false,reply:''};showLoading();fetch(GAS_URL,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'add_request',data:newRequest})}).then(function(r){return r.json()}).then(function(d){hideLoading();if(d.result==='success'){showToast('ì „ì†¡ ì™„ë£Œ!');document.getElementById('member-request-input').value='';requestList.unshift(newRequest);renderMyRequests()}else{showToast('ì „ì†¡ ì‹¤íŒ¨','error')}}).catch(function(e){hideLoading();showToast('ì„œë²„ ì˜¤ë¥˜','error')})}
function renderMyRequests(){var container=document.getElementById('my-request-list');var myReqs=requestList.filter(function(r){return r.member===currentUser.name});if(myReqs.length===0){container.innerHTML='<div style="text-align:center; color:#94a3b8; padding:20px;">ë³´ë‚¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}container.innerHTML=myReqs.map(function(r){return'<div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:10px; border-left:4px solid '+(r.reply?'#10b981':'#f59e0b')+';"><div style="font-size:12px; color:#64748b; margin-bottom:5px;">'+r.date+'</div><div style="font-weight:600; margin-bottom:8px;">'+r.content+'</div>'+(r.reply?'<div style="background:#ecfdf5; padding:10px; border-radius:6px; margin-top:8px;"><div style="font-size:11px; color:#047857; font-weight:bold; margin-bottom:4px;">ğŸ’¬ ê´€ë¦¬ì ë‹µë³€</div><div style="font-size:13px;">'+r.reply+'</div></div>':'<div style="font-size:12px; color:#f59e0b;">â³ ë‹µë³€ ëŒ€ê¸°ì¤‘</div>')+'</div>'}).join('')}
function renderAdminRequests(){var container=document.getElementById('admin-request-list');if(requestList.length===0){container.innerHTML='<div style="text-align:center; color:#94a3b8; padding:40px;">ìš”ì²­ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}container.innerHTML=requestList.map(function(r){return'<div style="background:'+(r.isRead?'#f8fafc':'#fffbeb')+'; padding:20px; border-radius:12px; margin-bottom:15px; border:1px solid '+(r.isRead?'#e2e8f0':'#fcd34d')+'; position:relative;"><button onclick="deleteRequest('+r.id+')" style="position:absolute; top:10px; right:10px; background:#fee2e2; border:none; border-radius:6px; width:30px; height:30px; cursor:pointer; font-size:15px; line-height:1; display:flex; align-items:center; justify-content:center;" title="ì‚­ì œ">ğŸ—‘ï¸</button><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-right:35px;"><span style="font-weight:bold; color:#1e293b;">ğŸ‘¤ '+r.member+'</span><span style="font-size:12px; color:#64748b;">'+r.date+'</span></div><div style="background:white; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #e2e8f0;">'+r.content+'</div>'+(r.reply?'<div style="background:#ecfdf5; padding:12px; border-radius:8px;"><div style="font-size:11px; color:#047857; font-weight:bold; margin-bottom:4px;">âœ… ë‚´ ë‹µë³€</div><div>'+r.reply+'</div></div>':'<div style="display:flex; gap:8px;"><input type="text" id="reply-'+r.id+'" placeholder="ë‹µë³€ ì…ë ¥..." style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:6px;"><button class="btn btn-primary" onclick="submitReply('+r.id+')">ë‹µë³€</button></div>')+'</div>'}).join('')}
function deleteRequest(reqId){if(!confirm('ì´ ìš”ì²­ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;showLoading();fetch(GAS_URL,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'delete_request',id:reqId})}).then(function(r){return r.json()}).then(function(d){hideLoading();requestList=requestList.filter(function(r){return r.id!==reqId});renderAdminRequests();updateRequestBadge();showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')}).catch(function(e){hideLoading();requestList=requestList.filter(function(r){return r.id!==reqId});renderAdminRequests();updateRequestBadge();showToast('ì‚­ì œ ì²˜ë¦¬ë¨ (ì„œë²„ ë™ê¸°í™”ëŠ” ë‹¤ìŒ ì ‘ì† ì‹œ ë°˜ì˜)')})}
function submitReply(reqId){var replyInput=document.getElementById('reply-'+reqId);var reply=replyInput.value.trim();if(!reply)return showToast('ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”.','error');showLoading();fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'reply_request',id:reqId,reply:reply})}).then(function(r){return r.json()}).then(function(d){hideLoading();if(d.result==='success'){showToast('ë‹µë³€ ì™„ë£Œ!');var req=requestList.find(function(r){return r.id===reqId});if(req)req.reply=reply;renderAdminRequests()}else{showToast('ë‹µë³€ ì‹¤íŒ¨','error')}}).catch(function(e){hideLoading();showToast('ì„œë²„ ì˜¤ë¥˜','error')})}
function markRequestsAsRead(){var unreadIds=requestList.filter(function(r){return!r.isRead}).map(function(r){return r.id});if(unreadIds.length===0)return;requestList.forEach(function(r){if(!r.isRead)r.isRead=true});updateRequestBadge();fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'mark_read',ids:unreadIds})})}
function renderMemberList(){var container=document.getElementById('member-list-container');container.innerHTML='';members.forEach(function(m){if(m.name==='ê´€ë¦¬ì')return;var isAdmin=m.role==='admin';var item=document.createElement('div');item.className='member-list-item';item.innerHTML='<div><span class="member-name">'+m.name+'</span> <span class="member-role">'+(isAdmin?'(ê´€ë¦¬ì)':'(íŒ€ì›)')+'</span></div><div class="member-actions"><button class="btn-icon btn-icon-danger" style="font-size:16px; line-height:1;" onclick="deleteTeamMember(\''+m.name+'\')" title="ì‚­ì œ">ğŸ—‘ï¸</button></div>';container.appendChild(item)});if(members.filter(function(m){return m.name!=='ê´€ë¦¬ì'}).length===0)container.innerHTML='<div style="padding:20px; text-align:center; color:#94a3b8;">ë“±ë¡ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}
function addTeamMember(){var nameInput=document.getElementById('new-member-name');var newName=nameInput.value.trim();if(!newName)return showToast("íŒ€ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",'error');showLoading();fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'add_member',name:newName,pw:'1234'})}).then(function(res){return res.json()}).then(function(data){hideLoading();if(data.result==='success'){showToast("íŒ€ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");nameInput.value='';fetchDB(function(){renderMemberList()})}else if(data.result==='duplicate'){showToast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.",'error')}else{showToast("ì˜¤ë¥˜ ë°œìƒ",'error')}}).catch(function(err){hideLoading();showToast("ì„œë²„ ì˜¤ë¥˜",'error')})}
function deleteTeamMember(targetName){if(targetName==='ê´€ë¦¬ì')return showToast("ê´€ë¦¬ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",'error');if(!confirm('ì •ë§ \''+targetName+'\' íŒ€ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;showLoading();fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'del_member',name:targetName})}).then(function(res){return res.json()}).then(function(data){hideLoading();if(data.result==='success'){showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");fetchDB(function(){renderMemberList()})}else{showToast("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒ€ì›ì…ë‹ˆë‹¤.",'error')}}).catch(function(err){hideLoading();showToast("ì„œë²„ ì˜¤ë¥˜",'error')})}
function changePassword(){var newPw=prompt("ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");if(!newPw)return;if(newPw.length<4)return showToast("ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",'error');showLoading();fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:'change_pw',name:currentUser.name,newPw:newPw})}).then(function(res){return res.json()}).then(function(data){hideLoading();if(data.result==='success'){showToast("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");var hashedNewPw=sha256(newPw);if(localStorage.getItem('last_login_id')===currentUser.name)localStorage.setItem('last_login_pw',hashedNewPw);currentUser.pw=hashedNewPw}else{showToast("ë³€ê²½ ì‹¤íŒ¨",'error')}})}
function toggleGradeField(){document.getElementById('group-grade-prov').style.display=(document.getElementById('input-source').value==='íšŒì‚¬DB')?'block':'none'}
function toggleStatusFields(isInit) {
    var s = document.getElementById('input-status').value;
    document.querySelectorAll('.dynamic-section').forEach(function(el){ el.classList.remove('active') });
    
    // â˜… ë°˜ë‚©ëŒ€ê¸° ì‹œ í¼ ì ê¸ˆ(Lock) ì œì–´ ë¡œì§
    var lockOverlay = document.getElementById('modal-overlay-lock');
    var actionButtons = document.getElementById('modal-action-buttons');
    var reassignArea = document.getElementById('reassign-req-area');
    var adminPanel = document.getElementById('admin-reassign-panel');
    
    if (s === 'ë°˜ë‚©ëŒ€ê¸°') {
        // íŒ€ì›: ì €ì¥ë²„íŠ¼ ìˆ¨ê¹€, ìˆ˜ì • ì ê¸ˆ ì˜¤ë²„ë ˆì´ ì¼¬ (ê´€ë¦¬ì ì œì™¸)
        if(currentUser.role !== 'admin') {
            lockOverlay.style.display = 'block';
            if(actionButtons) actionButtons.style.display = 'none';
        }
        if(reassignArea) reassignArea.style.display = 'none';
    } else {
        lockOverlay.style.display = 'none';
        if(actionButtons) actionButtons.style.display = 'flex';
        // â˜… ìˆ˜ì •: 'ì¢…ë£Œ' ìƒíƒœì—ì„œë„ ì¬ë°°ì • ìš”ì²­ ë²„íŠ¼ ë³´ì´ê¸°! (ê³„ì•½ë§Œ ì œì™¸)
        if(reassignArea && currentUser.role !== 'admin' && (s==='ëŒ€ê¸°' || s==='ì§„í–‰ì¤‘' || s==='ê°€ë§ê³ ê°' || s==='ì¢…ë£Œ')) {
            reassignArea.style.display = 'block';
        } else if(reassignArea) {
            reassignArea.style.display = 'none';
        }
    }

    // â˜… ìˆ˜ì •: ê´€ë¦¬ì íŒ¨ë„ì€ 'ê³„ì•½' ê±´ì—ë§Œ ìˆ¨ê¸°ê³ , 'ì¢…ë£Œ' ê±´ì—ì„œëŠ” ë‹¤ì‹œ ë‚˜íƒ€ë‚˜ê²Œ í•¨!
    if (currentUser.role === 'admin' && adminPanel) {
        if (s === 'ê³„ì•½') adminPanel.style.display = 'none';
        else adminPanel.style.display = 'block';
    }
    
    if(s === 'ëŒ€ê¸°') document.getElementById('box-wait').classList.add('active');
    if(s === 'ì§„í–‰ì¤‘') document.getElementById('box-ing').classList.add('active');
    if(s === 'ê°€ë§ê³ ê°') document.getElementById('box-prospect').classList.add('active');
    if(s === 'ê³„ì•½') {
        document.getElementById('box-contract').classList.add('active');
        if (isInit !== true) {
            updateShareFields();
            calculateShare();
        }
    }
    if(s === 'ì¢…ë£Œ') document.getElementById('box-end').classList.add('active');
    document.getElementById('btn-roadmap-area').style.display = (s === 'ì§„í–‰ì¤‘' || s === 'ê³„ì•½') ? 'block' : 'none';
}

function copyPhone(phone){navigator.clipboard.writeText(phone).then(function(){showToast('ğŸ“ '+phone+' ë³µì‚¬ë¨!')}).catch(function(){window.location.href='tel:'+phone})}

function formatCurrency(input) {
    var selectionStart = input.selectionStart;
    var oldLength = input.value.length;
    var val = input.value.replace(/,/g, '');
    if (!val) { input.value = ''; return; }
    var num = parseInt(val);
    if (isNaN(num)) { input.value = ''; return; }
    
    input.value = num.toLocaleString();
    
    var newLength = input.value.length;
    var newPos = selectionStart + (newLength - oldLength);
    input.setSelectionRange(newPos, newPos);
}

function exportToExcel(){
    try{
        if(typeof XLSX==='undefined') throw new Error('XLSX not loaded');
        var data=[];var isAdmin=currentUser.role==='admin';
        var headers=isAdmin?['ì ‘ìˆ˜ì¼','ë‹´ë‹¹ì','ì—…ì²´ëª…','ëŒ€í‘œì','ì—°ë½ì²˜','ì§€ì—­','ì¶œì²˜','í†µí™”ìƒíƒœ','ë¯¸íŒ…ì¼','ì§„í–‰ìƒíƒœ','ê³„ì•½ì¼','ìƒí’ˆ','ì´ê¸ˆì•¡','ìˆœìˆ˜ì‹¤ì ']:['ì ‘ìˆ˜ì¼','ì—…ì²´ëª…','ëŒ€í‘œì','ì—°ë½ì²˜','ì§€ì—­','ì¶œì²˜','í†µí™”ìƒíƒœ','ë¯¸íŒ…ì¼','ì§„í–‰ìƒíƒœ','ê³„ì•½ì¼','ìƒí’ˆ','ì´ê¸ˆì•¡','ìˆœìˆ˜ì‹¤ì '];
        data.push(headers);
        totalFilteredData.forEach(function(d){
            if(d.isVirtualShare)return;
            var row=isAdmin?[d.date||'',d.member||'',d.company||'',d.ceo||'',d.phone||'',d.region||'',d.source||'',d.callStatus||'',d.meetDate||'',d.status||'',d.contractDate||'',d.product||'',d.totalAmount||0,d.amount||0]:[d.date||'',d.company||'',d.ceo||'',d.phone||'',d.region||'',d.source||'',d.callStatus||'',d.meetDate||'',d.status||'',d.contractDate||'',d.product||'',d.totalAmount||0,d.amount||0];
            data.push(row);
        });
        var ws=XLSX.utils.aoa_to_sheet(data);
        ws['!cols']=headers.map(function(){return{wch:15}});
        var wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'DB_List');
        XLSX.writeFile(wb,'DB_List_'+new Date().toISOString().split('T')[0]+'.xlsx');
        showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
    }catch(e){
        console.error('Excel error:',e);
        exportToCSV();
    }
}
function exportToCSV(){
    var isAdmin=currentUser.role==='admin';
    var headers=isAdmin?['ì ‘ìˆ˜ì¼','ë‹´ë‹¹ì','ì—…ì²´ëª…','ëŒ€í‘œì','ì—°ë½ì²˜','ì§€ì—­','ì¶œì²˜','í†µí™”ìƒíƒœ','ë¯¸íŒ…ì¼','ì§„í–‰ìƒíƒœ','ê³„ì•½ì¼','ìƒí’ˆ','ì´ê¸ˆì•¡','ìˆœìˆ˜ì‹¤ì ']:['ì ‘ìˆ˜ì¼','ì—…ì²´ëª…','ëŒ€í‘œì','ì—°ë½ì²˜','ì§€ì—­','ì¶œì²˜','í†µí™”ìƒíƒœ','ë¯¸íŒ…ì¼','ì§„í–‰ìƒíƒœ','ê³„ì•½ì¼','ìƒí’ˆ','ì´ê¸ˆì•¡','ìˆœìˆ˜ì‹¤ì '];
    var csv='\uFEFF'+headers.join(',')+'\n';
    totalFilteredData.forEach(function(d){
        if(d.isVirtualShare)return;
        var row=isAdmin?[d.date,d.member,d.company,d.ceo||'',d.phone||'',d.region||'',d.source||'',d.callStatus||'',d.meetDate||'',d.status,d.contractDate||'',d.product||'',d.totalAmount||0,d.amount||0]:[d.date,d.company,d.ceo||'',d.phone||'',d.region||'',d.source||'',d.callStatus||'',d.meetDate||'',d.status,d.contractDate||'',d.product||'',d.totalAmount||0,d.amount||0];
        csv+=row.map(function(v){return'"'+String(v||'').replace(/"/g,'""')+'"'}).join(',')+'\n';
    });
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    var link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='DB_List_'+new Date().toISOString().split('T')[0]+'.csv';
    link.click();
    showToast('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! (ì—‘ì…€ë¡œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
}
function sortMemberNames(memberList,currentMember){var specialItems=[];var koreanItems=[];memberList.forEach(function(m){if(m.role!=='admin'&&m.name!==currentMember){var firstChar=m.name.charAt(0);if(/[ê°€-í£]/.test(firstChar)){koreanItems.push(m)}else{specialItems.push(m)}}});koreanItems.sort(function(a,b){return a.name.localeCompare(b.name,'ko')});specialItems.sort(function(a,b){return a.name.localeCompare(b.name,'ko')});return specialItems.concat(koreanItems)}
function updateShareFields(){var source=document.getElementById('input-source').value;var currentMember=document.getElementById('display-member').innerText;var selectors=[1,2,3].map(function(i){return document.getElementById('share-partner-'+i)});var inputs=[1,2,3].map(function(i){return document.getElementById('share-percent-'+i)});var sortedMembers=sortMemberNames(members,currentMember);var commonOptions='<option value="">ì„ íƒ</option>';sortedMembers.forEach(function(m){commonOptions+='<option value="'+m.name+'">'+m.name+' íŒ€ì¥</option>'});selectors.forEach(function(sel,idx){var finalOptions=commonOptions;if(idx===0){if(source==='íšŒì‚¬DB')finalOptions='<option value="íšŒì‚¬">ğŸ¢ íšŒì‚¬</option>';else if(source==='íŒ€DB')finalOptions='<option value="SM">ğŸ—£ï¸ SM</option>';else if(source==='ì¶”ì¥í˜¸DB')finalOptions='<option value="ì¶”ì¥í˜¸">ğŸ¯ ì¶”ì¥í˜¸</option>'}else{if(source==='íšŒì‚¬DB')finalOptions='<option value="">ì„ íƒ</option><option value="íšŒì‚¬">ğŸ¢ íšŒì‚¬</option>'+commonOptions.replace('<option value="">ì„ íƒ</option>','');else if(source==='íŒ€DB')finalOptions='<option value="">ì„ íƒ</option><option value="SM">ğŸ—£ï¸ SM</option>'+commonOptions.replace('<option value="">ì„ íƒ</option>','');else if(source==='ì¶”ì¥í˜¸DB')finalOptions='<option value="">ì„ íƒ</option><option value="ì¶”ì¥í˜¸">ğŸ¯ ì¶”ì¥í˜¸</option>'+commonOptions.replace('<option value="">ì„ íƒ</option>','')}sel.innerHTML=finalOptions});if(source==='íšŒì‚¬DB'){selectors[0].value='íšŒì‚¬';selectors[0].disabled=true;inputs[0].value=10}else if(source==='íŒ€DB'){selectors[0].value='SM';selectors[0].disabled=true;inputs[0].value=40}else if(source==='ì¶”ì¥í˜¸DB'){selectors[0].value='ì¶”ì¥í˜¸';selectors[0].disabled=true;inputs[0].value=50}else{selectors[0].value='';selectors[0].disabled=false;inputs[0].value='';selectors[1].value='';inputs[1].value='';selectors[2].value='';inputs[2].value=''}}
function calculateShare(){var totalRaw=document.getElementById('input-amount').value.replace(/,/g,'');var total=totalRaw===''?0:(parseInt(totalRaw)||0);var totalDeduction=0;for(var i=1;i<=3;i++){var partnerSel=document.getElementById('share-partner-'+i);var percentIn=document.getElementById('share-percent-'+i);var valSpan=document.getElementById('share-val-'+i);var pct=parseInt(percentIn.value)||0;var shareAmt=0;if(pct>0&&partnerSel.value)shareAmt=Math.floor(total*(pct/100));valSpan.innerText=shareAmt.toLocaleString();valSpan.style.color=shareAmt>0?'#ef4444':'#ccc';totalDeduction+=shareAmt}document.getElementById('disp-total').innerText=total.toLocaleString();document.getElementById('disp-net').innerText=(total-totalDeduction).toLocaleString()}

function renderFilters() {
    var container = document.getElementById('list-filter-container');
    if (!container) return;
    
    var searchHtml = '<input type="text" id="search-keyword" placeholder="ì—…ì²´ëª… ê²€ìƒ‰" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:8px;" onkeyup="currentPage=1;renderList()">';
    
    if (currentUser.role === 'admin') {
        container.innerHTML = searchHtml + 
            '<select id="filter-year" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()"></select>' +
            '<select id="filter-month" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()"></select>' +
            '<select id="filter-source" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()">' +
                '<option value="all">ì „ì²´ ì¶œì²˜</option><option value="íšŒì‚¬DB">íšŒì‚¬ DB</option><option value="ê°œì¸DB">ê°œì¸ DB</option><option value="íŒ€DB">íŒ€ DB</option><option value="ì¶”ì¥í˜¸DB">ì¶”ì¥í˜¸ DB</option><option value="ê¸°íƒ€DB">ğŸ¸ ê¸°íƒ€ DB</option><option value="ì‰ì–´ë°›ìŒ">ì‰ì–´ ë°›ìŒ</option>' +
            '</select>' +
            '<select id="filter-call" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()">' +
                '<option value="all">ì „ì²´ í†µí™”</option><option value="">ë¯¸í™•ì¸</option><option value="ë¶€ì¬ì¤‘">ë¶€ì¬ì¤‘</option><option value="ì¥ë‚œDB">ì¥ë‚œDB</option><option value="ì¬í†µí™”ìš”ì²­">ì¬í†µí™”ìš”ì²­</option><option value="í†µí™”ì™„ë£Œ">í†µí™”ì™„ë£Œ</option>' +
            '</select>' +
            '<select id="filter-status" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()">' +
                '<option value="all">ì „ì²´ ì§„í–‰ìƒíƒœ</option><option value="ëŒ€ê¸°">â³ ëŒ€ê¸°</option><option value="ì§„í–‰ì¤‘">ğŸƒ ì§„í–‰ì¤‘</option><option value="ê°€ë§ê³ ê°">ğŸŒŸ ê°€ë§ê³ ê°</option><option value="ê³„ì•½">ğŸ‰ ê³„ì•½</option><option value="ì¢…ë£Œ">âŒ ì¢…ë£Œ</option><option value="ë°˜ë‚©ëŒ€ê¸°">âš ï¸ ë°˜ë‚©ëŒ€ê¸°</option>' +
            '</select>' +
            '<select id="filter-member" style="padding:10px; border:1px solid #2563eb; color:#2563eb; font-weight:bold; border-radius:8px;" onchange="currentPage=1;renderList()"><option value="all">ì „ì²´ íŒ€ì› ë³´ê¸°</option></select>';
        
        var memSel = document.getElementById('filter-member');
        members.forEach(function(m) { if (m.role !== 'admin') memSel.innerHTML += '<option value="' + m.name + '">' + m.name + '</option>'; });
    } else {
        container.innerHTML = searchHtml + 
            '<select id="filter-year" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()"></select>' +
            '<select id="filter-month" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()"></select>' +
            '<select id="filter-source" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()">' +
                '<option value="all">ì „ì²´ ì¶œì²˜</option><option value="íšŒì‚¬DB">íšŒì‚¬ DB</option><option value="ê°œì¸DB">ê°œì¸ DB</option><option value="íŒ€DB">íŒ€ DB</option><option value="ì¶”ì¥í˜¸DB">ì¶”ì¥í˜¸ DB</option><option value="ê¸°íƒ€DB">ğŸ¸ ê¸°íƒ€ DB</option><option value="ì‰ì–´ë°›ìŒ">ì‰ì–´ ë°›ìŒ</option>' +
            '</select>' +
            '<select id="filter-status" style="padding:10px; border:1px solid #ddd; border-radius:8px;" onchange="currentPage=1;renderList()"><option value="all">ì „ì²´ ì§„í–‰ìƒíƒœ</option><option value="ëŒ€ê¸°">â³ ëŒ€ê¸°</option><option value="ì§„í–‰ì¤‘">ğŸƒ ì§„í–‰ì¤‘</option><option value="ê°€ë§ê³ ê°">ğŸŒŸ ê°€ë§ê³ ê°</option><option value="ê³„ì•½">ğŸ‰ ê³„ì•½</option><option value="ì¢…ë£Œ">âŒ ì¢…ë£Œ</option><option value="ë°˜ë‚©ëŒ€ê¸°">âš ï¸ ë°˜ë‚©ëŒ€ê¸°(ì ê¸ˆ)</option></select>';
    }
    initDateSelects();
}

function initDateSelects(){var yearSel=document.getElementById('filter-year');var monthSel=document.getElementById('filter-month');var histYearSel=document.getElementById('hist-year');var histMonthSel=document.getElementById('hist-month');var adminMonthSel=document.getElementById('admin-stat-month');var currentYear=new Date().getFullYear();var currentMonth=new Date().getMonth()+1;var opts='<option value="all">ì „ì²´ ì—°ë„</option>';for(var y=currentYear+1;y>=2023;y--)opts+='<option value="'+y+'" '+(y===currentYear?'selected':'')+'>'+y+'ë…„</option>';if(yearSel)yearSel.innerHTML=opts;if(histYearSel)histYearSel.innerHTML=opts;var mOpts='<option value="all">ì „ì²´ ì›”</option>';for(var m=1;m<=12;m++)mOpts+='<option value="'+m+'"'+(m===currentMonth?' selected':'')+'>'+m+'ì›”</option>';if(monthSel)monthSel.innerHTML=mOpts;if(histMonthSel)histMonthSel.innerHTML='<option value="all">ì „ì²´ (1ë…„ì¹˜)</option>'+mOpts.replace('value="all"','').replace('ì „ì²´ ì›”','');var adminOpts='<option value="all">ì „ì²´ ì›”</option>';for(var am=1;am<=12;am++)adminOpts+='<option value="'+am+'"'+(am===currentMonth?' selected':'')+'>'+am+'ì›”</option>';if(adminMonthSel)adminMonthSel.innerHTML=adminOpts}

// â˜… [ìˆ˜ì •] íˆìŠ¤í† ë¦¬ íƒ­ì— 'DBì¬ë°°ì •' ë©”ë‰´ ì¶”ê°€ (ê´€ë¦¬ì ì „ìš© NEW ë±ƒì§€ í¬í•¨)
function setupHistoryTabs(){
    var tabsDiv=document.getElementById('history-tabs');if(!tabsDiv)return;
    var btnClass=function(tab){return'btn '+(historyTab===tab?'btn-primary':'btn-secondary')};
    
    if(currentUser.role==='admin'){
        // ë°˜ë‚© ëŒ€ê¸° ê±´ìˆ˜ ì²´í¬ (NEW ë±ƒì§€ìš©)
        var pendingCount = dbList.filter(function(d) { return d.status === 'ë°˜ë‚©ëŒ€ê¸°'; }).length;
        var newBadge = pendingCount > 0 ? ' <span style="background:#ef4444;color:white;font-size:10px;padding:2px 6px;border-radius:10px;animation:pulse 1s infinite;">'+pendingCount+'</span>' : '';
        
        tabsDiv.innerHTML=
            '<button class="'+btnClass('admin-prospect')+'" onclick="switchHistoryTab(\'admin-prospect\')">ğŸŒŸ ê°€ë§ê³ ê°</button>'+
            '<button class="'+btnClass('contract')+'" onclick="switchHistoryTab(\'contract\')">ğŸ¤ ê³„ì•½ ê³ ê°</button>'+
            '<button class="'+btnClass('reassign')+'" onclick="switchHistoryTab(\'reassign\')">ğŸ”„ DBì¬ë°°ì • í˜„í™©' + newBadge + '</button>';
    }else{
        tabsDiv.innerHTML=
            '<button class="'+btnClass('prospect')+'" onclick="switchHistoryTab(\'prospect\')">ğŸŒŸ ê°€ë§ê³ ê°</button>'+
            '<button class="'+btnClass('contract')+'" onclick="switchHistoryTab(\'contract\')">ğŸ¤ ê³„ì•½ ê³ ê°</button>';
    }
}
function switchHistoryTab(t){historyTab=t;setupHistoryTabs();renderHistory()}
function navTo(page){if(page==='dashboard'&&currentUser.role!=='admin')return showToast("ê´€ë¦¬ì ê¶Œí•œ í•„ìš”",'error');document.querySelectorAll('.nav-item').forEach(function(el){el.classList.remove('active')});var map={'list':'nav-list','analysis':'nav-analysis','history':'nav-history','calendar':'nav-calendar','message':'nav-message','dashboard':'nav-dashboard'};if(document.getElementById(map[page]))document.getElementById(map[page]).classList.add('active');document.querySelectorAll('.page-content').forEach(function(el){el.style.display='none'});document.getElementById('view-'+page).style.display='block';history.pushState({page:page},page,'#'+page);if(page==='list'){renderFilters();if(currentUser.role==='admin'){document.getElementById('list-head').innerHTML='<tr><th>ì ‘ìˆ˜ì¼</th><th>ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>í†µí™”ìœ ë¬´</th><th>ë¯¸íŒ…ì¼</th><th>ì—°ë½ì²˜</th><th>ì§€ì—­</th><th>ì¶œì²˜</th><th>ì§„í–‰ìƒíƒœ</th></tr>';document.getElementById('page-title').innerText='íŒ€ì› DB ê´€ë¦¬'}else{document.getElementById('list-head').innerHTML='<tr><th>ì ‘ìˆ˜ì¼</th><th>ì—…ì²´ëª…</th><th>í†µí™”ìœ ë¬´</th><th>ë¯¸íŒ…ì¼</th><th>ì—°ë½ì²˜</th><th>ì§€ì—­</th><th>ì¶œì²˜</th><th>ì§„í–‰ìƒíƒœ</th></tr>';document.getElementById('page-title').innerText='ë‚˜ì˜ DB ê´€ë¦¬'}currentPage=1;renderList()}if(page==='analysis')renderAnalysisData();if(page==='dashboard')renderAdminDashboard();if(page==='history'){setupHistoryTabs();renderHistory()}if(page==='calendar')renderCalendar();if(page==='message')initMessageView()}
window.addEventListener('popstate',function(e){if(e.state&&e.state.page){var page=e.state.page;document.querySelectorAll('.nav-item').forEach(function(el){el.classList.remove('active')});var map={'list':'nav-list','analysis':'nav-analysis','history':'nav-history','calendar':'nav-calendar','message':'nav-message','dashboard':'nav-dashboard'};if(document.getElementById(map[page]))document.getElementById(map[page]).classList.add('active');document.querySelectorAll('.page-content').forEach(function(el){el.style.display='none'});document.getElementById('view-'+page).style.display='block';if(page==='list'){currentPage=1;renderList()}if(page==='analysis')renderAnalysisData();if(page==='dashboard')renderAdminDashboard();if(page==='history'){setupHistoryTabs();renderHistory()}if(page==='calendar')renderCalendar();if(page==='message')initMessageView()}else{if(currentUser){history.pushState({page:'list'},'list','#list')}}});
function changePage(dir){var totalPages=Math.ceil(totalFilteredData.length/pageSize);currentPage+=dir;if(currentPage<1)currentPage=1;if(currentPage>totalPages)currentPage=totalPages;renderListPage()}

function renderList() {
    var tbody = document.getElementById('list-body'); if (!tbody) return;
    var year = document.getElementById('filter-year').value;
    var month = document.getElementById('filter-month').value;
    var source = document.getElementById('filter-source').value;
    var statusFilter = document.getElementById('filter-status').value;
    var callFilter = document.getElementById('filter-call') ? document.getElementById('filter-call').value : 'all';
    var kw = document.getElementById('search-keyword').value.toLowerCase();
    
    var targetMem = 'all';
    if (currentUser.role === 'admin') targetMem = document.getElementById('filter-member').value;

    var filtered = dbList.filter(function(d) {
        if (!d) return false;
        var parsed = parseDBDate(d.date);
        
        var matchKw = !kw || (d.company || "").toLowerCase().includes(kw) || (d.member || "").toLowerCase().includes(kw);
        if (!matchKw) return false;

        if (year !== 'all' && parsed.year != year) return false;
        if (month !== 'all' && parsed.month != month) return false;
        if (source !== 'all' && source !== 'ì‰ì–´ë°›ìŒ' && d.source !== source) return false;
        if (statusFilter !== 'all' && d.status !== statusFilter) return false;
        if (callFilter !== 'all' && (d.callStatus || "") !== callFilter) return false;

        if (currentUser.role === 'admin') {
            if (targetMem !== 'all' && d.member !== targetMem) return false;
        } else {
            if (d.member !== currentUser.name) return false;
        }
        return true;
    });

    if (source === 'all' || source === 'ì‰ì–´ë°›ìŒ') {
        var shareSearchName = (currentUser.role === 'admin') ? targetMem : currentUser.name;
        if (shareSearchName !== 'all') {
            var virtualEntries = getVirtualShareEntries(shareSearchName);
            virtualEntries.forEach(function(ve) {
                var vp = parseDBDate(ve.contractDate);
                if (year !== 'all' && vp.year != year) return;
                if (month !== 'all' && vp.month != month) return;
                if (kw && !ve.company.toLowerCase().includes(kw)) return;
                if (statusFilter !== 'all' && ve.status !== statusFilter) return;
                filtered.push(ve);
            });
        }
    }

    filtered.sort(function(a,b){
        var dateA = new Date(a.contractDate || a.date).getTime() || 0;
        var dateB = new Date(b.contractDate || b.date).getTime() || 0;
        return dateB - dateA;
    });

    totalFilteredData = filtered;
    if (filtered.length === 0) {
        document.getElementById('empty-message').style.display = 'block';
        document.getElementById('pagination-controls').style.display = 'none';
        tbody.innerHTML = '';
    } else {
        document.getElementById('empty-message').style.display = 'none';
        renderListPage();
    }
}

// â˜… [ìˆ˜ì •] ë°˜ë‚©ëŒ€ê¸° ë±ƒì§€ ìƒ‰ìƒ ì—°ë™
function renderListPage(){
    var tbody=document.getElementById('list-body');tbody.innerHTML='';
    var totalPages=Math.ceil(totalFilteredData.length/pageSize);
    if(currentPage>totalPages)currentPage=totalPages;if(currentPage<1)currentPage=1;
    var start=(currentPage-1)*pageSize;var end=Math.min(start+pageSize,totalFilteredData.length);
    var pageData=totalFilteredData.slice(start,end);
    pageData.forEach(function(d){
        var badge='status-wait';
        if(d.status==='ì§„í–‰ì¤‘')badge='status-ing';
        if(d.status==='ê°€ë§ê³ ê°')badge='status-prospect';
        if(d.status==='ê³„ì•½')badge='status-done';
        if(d.status==='ì¢…ë£Œ')badge='status-end';
        if(d.status==='ë°˜ë‚©ëŒ€ê¸°')badge='status-pending'; // ì‹ ê·œ ìŠ¤íƒ€ì¼
        if((d.source||"").includes('ì‰ì–´'))badge='status-share';
        
        var alertIcon='';if(currentUser.role!=='admin'&&d.hasAdminAlert)alertIcon=' <i class="fa-solid fa-comment-dots admin-alert-icon" title="ê´€ë¦¬ì ì½”ë©˜íŠ¸ í™•ì¸!"></i>';var ddayBadge=getDdayText(d.meetDate);var phoneDisplay=d.phone?'<span class="phone-link" onclick="event.stopPropagation(); copyPhone(\''+d.phone+'\')" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">'+d.phone+'</span>':'<span style="color:#ccc">-</span>';var callBadge=getCallStatusBadge(d.callStatus);var companyDisplay=d.isVirtualShare?'['+d.originalMember+'ì‰ì–´] '+d.company:d.company;var amountDisplay=d.isVirtualShare?' <span style="font-size:11px; color:#c2410c;">('+((d.amount||0).toLocaleString())+'ì›)</span>':'';var clickAction=d.isVirtualShare?'openModal(\''+d.originalId+'\')':'openModal(\''+d.id+'\')';var row='<td>'+(d.contractDate||d.date)+'</td>';if(currentUser.role==='admin')row+='<td>'+d.member+'</td>';row+='<td style="font-weight:bold">'+companyDisplay+amountDisplay+alertIcon+'</td>';row+='<td>'+callBadge+'</td>';row+='<td style="color:'+(d.meetDate?'#2563eb':'#cbd5e1')+'">'+(d.meetDate||'-')+ddayBadge+'</td>';row+='<td>'+phoneDisplay+'</td>';row+='<td>'+(d.region||'-')+'</td>';row+='<td>'+d.source+'</td>';row+='<td><span class="badge '+badge+'">'+d.status+'</span></td>';tbody.innerHTML+='<tr onclick="'+clickAction+'">'+row+'</tr>'
    });
    var pgCtrl=document.getElementById('pagination-controls');
    if(totalPages>1){pgCtrl.style.display='block';document.getElementById('page-info').innerText=currentPage+' / '+totalPages+' í˜ì´ì§€ (ì´ '+totalFilteredData.length+'ê±´)';document.getElementById('btn-prev-page').disabled=(currentPage<=1);document.getElementById('btn-next-page').disabled=(currentPage>=totalPages)}else{pgCtrl.style.display='none'}
}

function renderAnalysisData(){renderYoYSummaryTable();try{renderYoYDetail()}catch(e){console.error('YoY Detail error:',e)}try{renderMonthlyKPI()}catch(e){console.error('KPI error:',e)}if(currentUser.role!=='admin'){try{renderMemberPerformance()}catch(e){console.error('MemberPerf error:',e)}}}

function goToMemberYearlyContracts(memberName) {
    navTo('list');
    setTimeout(function() {
        var yearEl = document.getElementById('filter-year');
        var monthEl = document.getElementById('filter-month');
        var statusEl = document.getElementById('filter-status');
        var sourceEl = document.getElementById('filter-source');
        var memberEl = document.getElementById('filter-member');
        
        if (yearEl) yearEl.value = new Date().getFullYear();
        if (monthEl) monthEl.value = 'all';
        if (statusEl) statusEl.value = 'ê³„ì•½';
        
        if (memberName === 'SM') {
            if (sourceEl) sourceEl.value = 'íŒ€DB';
            if (memberEl) memberEl.value = 'all';
        } else if (memberName === 'ì¶”ì¥í˜¸') {
            if (sourceEl) sourceEl.value = 'ì¶”ì¥í˜¸DB';
            if (memberEl) memberEl.value = 'all';
        } else {
            if (sourceEl) sourceEl.value = 'all';
            if (memberEl) memberEl.value = memberName;
        }
        
        currentPage = 1;
        renderList();
        showToast(memberName + 'ì˜ ì˜¬í•´ ê³„ì•½ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.');
    }, 100);
}

function renderYoYSummaryTable(){
    var tbody=document.querySelector('#yoy-summary-table tbody');tbody.innerHTML='';
    var thisY=new Date().getFullYear();
    var list=members.filter(function(m){return m.role!=='admin'}).map(function(m){
        var myDB=dbList.filter(function(d){return d.member===m.name&&d.status==='ê³„ì•½'});
        var l=myDB.filter(function(d){var cd=getContractDate(d);return parseDBDate(cd).year===thisY-1}).reduce(function(a,c){return a+(parseInt(String(c.amount).replace(/,/g,''))||0)},0);
        var t=myDB.filter(function(d){var cd=getContractDate(d);return parseDBDate(cd).year===thisY}).reduce(function(a,c){return a+(parseInt(String(c.amount).replace(/,/g,''))||0)},0);
        l+=getShareRevenue(m.name,thisY-1,null);t+=getShareRevenue(m.name,thisY,null);
        return{name:m.name,last:l,this:t,isSpecial:false}
    });
    var smL=getSpecialPartnerRevenue('SM',thisY-1,null);var smT=getSpecialPartnerRevenue('SM',thisY,null);
    if(smL>0||smT>0)list.push({name:'ğŸ—£ï¸ SM',last:smL,this:smT,isSpecial:true});
    var cjL=getSpecialPartnerRevenue('ì¶”ì¥í˜¸',thisY-1,null);var cjT=getSpecialPartnerRevenue('ì¶”ì¥í˜¸',thisY,null);
    if(cjL>0||cjT>0)list.push({name:'ğŸ¯ ì¶”ì¥í˜¸',last:cjL,this:cjT,isSpecial:true});
    list.sort(function(a,b){if(a.isSpecial!==b.isSpecial)return a.isSpecial?1:-1;return b.this-a.this});
    
    var normalRank=0;
    list.forEach(function(d){
        var bgStyle=d.isSpecial?' style="background:#fffbeb;"':'';
        if(!d.isSpecial)normalRank++;
        var rank=d.isSpecial?'-':normalRank;
        var crownHtml='';
        if(!d.isSpecial&&normalRank===1)crownHtml='<span style="font-size:22px; filter:drop-shadow(0 2px 4px rgba(234,179,8,0.5));">ğŸ‘‘</span> ';
        else if(!d.isSpecial&&normalRank===2)crownHtml='<span style="font-size:18px; filter:grayscale(0.3) brightness(1.3);">ğŸ‘‘</span> ';
        else if(!d.isSpecial&&normalRank===3)crownHtml='<span style="font-size:16px; filter:sepia(1) saturate(3) hue-rotate(350deg);">ğŸ‘‘</span> ';
        var nameStyle=!d.isSpecial&&normalRank<=3?' style="font-weight:800; font-size:15px;"':'';
        var rowBg='';
        if(!d.isSpecial&&normalRank===1)rowBg=' style="background:linear-gradient(90deg,#fef9c3,#fef3c7,white);"';
        else if(!d.isSpecial&&normalRank===2)rowBg=' style="background:linear-gradient(90deg,#f1f5f9,#e2e8f0,white);"';
        else if(!d.isSpecial&&normalRank===3)rowBg=' style="background:linear-gradient(90deg,#fff7ed,#fed7aa,white);"';
        if(d.isSpecial)rowBg=bgStyle;
        
        var cleanName = d.name.replace(/[^\w\sê°€-í£]/gi, '').trim(); 
        var nameHtml = '<span style="cursor:pointer; text-decoration:underline;" onclick="goToMemberYearlyContracts(\'' + cleanName + '\')" title="' + cleanName + ' ê³„ì•½ ë‚´ì—­ ë³´ê¸°">' + crownHtml + d.name + '</span>';
        
        tbody.innerHTML+='<tr'+rowBg+'><td>'+rank+'</td><td'+nameStyle+'>'+nameHtml+'</td><td>'+d.last.toLocaleString()+'</td><td style="font-weight:bold; color:#2563eb;">'+d.this.toLocaleString()+'</td><td>'+(d.this-d.last).toLocaleString()+'</td><td>'+(d.last>0?Math.round((d.this-d.last)/d.last*100):0)+'%</td></tr>'
    })
}

function renderYoYDetail(){
    var thisY=new Date().getFullYear();var lastY=thisY-1;
    var thisData=Array(12).fill(0);var lastData=Array(12).fill(0);
    if(currentUser.role==='admin'){
        dbList.forEach(function(d){if(d.status!=='ê³„ì•½')return;var contractDate=getContractDate(d);var parsed=parseDBDate(contractDate);var amt=parseInt(String(d.totalAmount||d.amount).toString().replace(/,/g,''))||0;if(d.shareList&&Array.isArray(d.shareList)){d.shareList.forEach(function(s){if(isExternalPartner(s.partner)&&s.amount>0)amt-=s.amount})}if(parsed.year===thisY)thisData[parsed.month-1]+=amt;if(parsed.year===lastY)lastData[parsed.month-1]+=amt})
    }else{
        var targetDB=dbList.filter(function(d){return d.member===currentUser.name});
        targetDB.forEach(function(d){if(d.status!=='ê³„ì•½')return;var contractDate=getContractDate(d);var parsed=parseDBDate(contractDate);var amt=parseInt(String(d.amount).replace(/,/g,''))||0;if(parsed.year===thisY)thisData[parsed.month-1]+=amt;if(parsed.year===lastY)lastData[parsed.month-1]+=amt});
        getVirtualShareEntries(currentUser.name).forEach(function(se){var parsed=parseDBDate(se.contractDate);if(parsed.year===thisY)thisData[parsed.month-1]+=se.amount;if(parsed.year===lastY)lastData[parsed.month-1]+=se.amount})
    }
    var thisTotal=thisData.reduce(function(a,b){return a+b},0);var lastTotal=lastData.reduce(function(a,b){return a+b},0);
    document.getElementById('val-last-total').innerText=lastTotal.toLocaleString();document.getElementById('val-this-total').innerText=thisTotal.toLocaleString();document.getElementById('val-growth').innerText=(thisTotal-lastTotal).toLocaleString();
    var html='<tr><td>'+lastY+'ë…„</td>';lastData.forEach(function(v){html+='<td>'+v.toLocaleString()+'</td>'});html+='<td style="font-weight:bold">'+lastTotal.toLocaleString()+'</td></tr>';
    html+='<tr style="background:#eff6ff"><td>'+thisY+'ë…„</td>';thisData.forEach(function(v){html+='<td>'+v.toLocaleString()+'</td>'});html+='<td style="font-weight:bold; color:blue">'+thisTotal.toLocaleString()+'</td></tr>';
    document.getElementById('yoy-detail-body').innerHTML=html;
    renderRevenueChart(lastData,thisData,lastY,thisY)
}

function renderRevenueChart(lastData,thisData,lastY,thisY){
    try{
    var canvas=document.getElementById('revenue-chart');if(!canvas)return;
    if(revenueChartInstance){revenueChartInstance.destroy()}
    if(typeof Chart==='undefined'){console.warn('Chart.js not loaded');return}
    var ctx=canvas.getContext('2d');
    revenueChartInstance=new Chart(ctx,{
        type:'bar',
        data:{
            labels:['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'],
            datasets:[
                {label:lastY+'ë…„',data:lastData,backgroundColor:'rgba(148,163,184,0.5)',borderColor:'#94a3b8',borderWidth:1,borderRadius:4},
                {label:thisY+'ë…„',data:thisData,backgroundColor:'rgba(59,130,246,0.7)',borderColor:'#2563eb',borderWidth:1,borderRadius:4}
            ]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:12,weight:'bold'}}},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': '+ctx.parsed.y.toLocaleString()+'ì›'}}}},scales:{y:{beginAtZero:true,ticks:{callback:function(v){return(v/10000).toLocaleString()+'ë§Œ'}}},x:{grid:{display:false}}}}
    })}catch(e){console.error('Chart render error:',e)}
}
function renderMonthlyKPI() {
    var ty = new Date().getFullYear();
    var d = (currentUser.role === 'admin') ? dbList : dbList.filter(function(x){return x.member === currentUser.name;});
    d = d.filter(function(x) { var contractDate = getContractDate(x); return parseDBDate(contractDate).year === ty && x.status === 'ê³„ì•½'; });
    if(currentUser.role !== 'admin') {
        var virtualShares = getVirtualShareEntries(currentUser.name).filter(function(ve) {
            return parseDBDate(ve.contractDate).year === ty;
        });
        virtualShares.forEach(function(ve) { d.push({source: 'ì‰ì–´ë°›ìŒ', totalAmount: ve.amount, amount: ve.amount, contractDate: ve.contractDate, status: 'ê³„ì•½'}); });
    }
    var sources = ['íšŒì‚¬DB', 'ê°œì¸DB', 'íŒ€DB', 'ì¶”ì¥í˜¸DB', 'ê¸°íƒ€DB', 'ì‰ì–´ë°›ìŒ'];
    var data = {};
    sources.forEach(function(s) { data[s] = Array(12).fill().map(function(){ return { cnt: 0, amt: 0 }; }); });
    d.forEach(function(x) {
        var contractDate = getContractDate(x);
        var parsed = parseDBDate(contractDate);
        var src = x.source || "";
        if(src.includes('ì‰ì–´')) src = 'ì‰ì–´ë°›ìŒ';
        else if(sources.indexOf(src)===-1) src = 'ê¸°íƒ€DB';
        if(data[src]) {
            data[src][parsed.month-1].cnt++;
            data[src][parsed.month-1].amt += (parseInt(String(x.totalAmount || x.amount).toString().replace(/,/g,'')) || 0);
        }
    });
    var tb = document.getElementById('month-kpi-table').querySelector('tbody');
    tb.innerHTML = '';
    sources.forEach(function(src) {
        var rowHtml = '<td style="font-weight:bold">' + src + '</td>';
        var totalCnt = 0, totalAmt = 0;
        for(var i=0; i<12; i++) { var c = data[src][i].cnt, a = data[src][i].amt; totalCnt += c; totalAmt += a; rowHtml += '<td>' + (c > 0 ? '<b>' + c + '</b><br><span style="font-size:10px; color:#2563eb">' + a.toLocaleString() + '</span>' : '<span style="color:#eee">-</span>') + '</td>'; }
        rowHtml += '<td style="background:#f1f5f9; font-weight:bold;">' + totalCnt + 'ê±´<br><span style="color:#2563eb">' + totalAmt.toLocaleString() + '</span></td>';
        tb.innerHTML += '<tr>' + rowHtml + '</tr>';
    });
}

function renderMemberPerformance() {
    var tbody = document.getElementById('member-perf-body'); if(!tbody) return; tbody.innerHTML = '';
    var now = new Date(); var thisYear = now.getFullYear(); var thisMonth = now.getMonth() + 1;
    var myDB = dbList.filter(function(d){return d.member === currentUser.name;});
    var monthlyDB = myDB.filter(function(d) { var p = parseDBDate(d.date); return p.year === thisYear && p.month === thisMonth; });
    var monthlyMeet = monthlyDB.filter(function(d){return d.meetDate;}).length;
    var monthlyProspect = monthlyDB.filter(function(d){return d.status === 'ê°€ë§ê³ ê°';}).length;
    var monthlyContract = myDB.filter(function(d) { if(d.status !== 'ê³„ì•½') return false; var cd = getContractDate(d); var p = parseDBDate(cd); return p.year === thisYear && p.month === thisMonth; });
    var monthlyContractCnt = monthlyContract.length;
    var monthlyRev = monthlyContract.reduce(function(a,c){return a + (parseInt(String(c.amount).replace(/,/g,''))||0);}, 0);
    monthlyRev += getShareRevenue(currentUser.name, thisYear, thisMonth);
    monthlyContractCnt += getShareContractCount(currentUser.name, thisYear, thisMonth);
    var monthlyRate = monthlyDB.length > 0 ? Math.round((monthlyContractCnt / monthlyDB.length) * 100) : 0;
    var yearlyDB = myDB.filter(function(d) { var p = parseDBDate(d.date); return p.year === thisYear; });
    var yearlyMeet = yearlyDB.filter(function(d){return d.meetDate;}).length;
    var yearlyProspect = yearlyDB.filter(function(d){return d.status === 'ê°€ë§ê³ ê°';}).length;
    var yearlyContract = myDB.filter(function(d) { if(d.status !== 'ê³„ì•½') return false; var cd = getContractDate(d); var p = parseDBDate(cd); return p.year === thisYear; });
    var yearlyContractCnt = yearlyContract.length;
    var yearlyRev = yearlyContract.reduce(function(a,c){return a + (parseInt(String(c.amount).replace(/,/g,''))||0);}, 0);
    yearlyRev += getShareRevenue(currentUser.name, thisYear, null);
    yearlyContractCnt += getShareContractCount(currentUser.name, thisYear, null);
    var yearlyRate = yearlyDB.length > 0 ? Math.round((yearlyContractCnt / yearlyDB.length) * 100) : 0;
    tbody.innerHTML = '<tr><td class="row-label">ğŸ“… ë‹¹ì›” (' + thisMonth + 'ì›”)</td><td>' + monthlyDB.length + '</td><td>' + monthlyMeet + '</td><td style="color:#7c3aed; font-weight:bold;">' + monthlyProspect + '</td><td style="color:#16a34a; font-weight:bold;">' + monthlyContractCnt + '</td><td>' + monthlyRate + '%</td><td style="color:#2563eb; font-weight:bold;">' + monthlyRev.toLocaleString() + '</td></tr>';
    tbody.innerHTML += '<tr style="background:#eff6ff;"><td class="row-label">ğŸ“† 1ë…„ ëˆ„ì  (' + thisYear + 'ë…„)</td><td>' + yearlyDB.length + '</td><td>' + yearlyMeet + '</td><td style="color:#7c3aed; font-weight:bold;">' + yearlyProspect + '</td><td style="color:#16a34a; font-weight:bold;">' + yearlyContractCnt + '</td><td>' + yearlyRate + '%</td><td style="color:#2563eb; font-weight:bold;">' + yearlyRev.toLocaleString() + '</td></tr>';
}

// â˜… [ìˆ˜ì •] ì›”ë³„ íˆìŠ¤í† ë¦¬ì— ì¬ë°°ì • íƒ­ ë¡œì§ ìœµí•©
function renderHistory() {
    var y = document.getElementById('hist-year').value, m = document.getElementById('hist-month').value;
    var tbody = document.getElementById('history-body'), thead = document.getElementById('history-head');
    tbody.innerHTML = '';
    
    // íƒ­ë³„ í…Œì´ë¸” í—¤ë” ì„¸íŒ…
    if(historyTab === 'admin-prospect' || historyTab === 'prospect') {
        thead.innerHTML = '<tr><th>ì ‘ìˆ˜ì¼</th><th>ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>DBì¶œì²˜</th><th>í˜„ì¬ìƒíƒœ</th></tr>';
    } else if(historyTab === 'contract') {
        thead.innerHTML = '<tr><th>ê³„ì•½ì¼</th><th>ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>DBì¶œì²˜</th><th>ìƒí’ˆ</th><th>ë§¤ì¶œ</th></tr>';
    } else if(historyTab === 'reassign') {
        thead.innerHTML = '<tr><th>ì ‘ìˆ˜ì¼</th><th>ê¸°ì¡´íŒ€ì¥</th><th>ì—…ì²´ëª…</th><th>DBì¶œì²˜</th><th>í˜„ì¬ìƒíƒœ</th><th>ë°°ì •ê²°ê³¼</th></tr>';
    }

    // ë°ì´í„° í•„í„°ë§
    var list = dbList.filter(function(d) { 
        var targetDate = d.date; 
        if((historyTab === 'contract') && d.contractDate) targetDate = d.contractDate; 
        var parsed = parseDBDate(targetDate); 
        
        if(y !== 'all' && parsed.year != y) return false; 
        if(m !== 'all' && parsed.month != m) return false; 
        if(currentUser.role !== 'admin' && d.member !== currentUser.name) return false; 
        
        if(historyTab === 'admin-prospect' || historyTab === 'prospect') return d.status === 'ê°€ë§ê³ ê°'; 
        else if(historyTab === 'contract') return d.status === 'ê³„ì•½'; 
        else if(historyTab === 'reassign') {
            // ë°˜ë‚©ëŒ€ê¸° ìƒíƒœì´ê±°ë‚˜, ì¢…ë£Œì‚¬ìœ ì— 'ì¬ë°°ì •' ê¸€ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê±´ë§Œ ì¶”ì¶œ
            return (d.status === 'ë°˜ë‚©ëŒ€ê¸°' || (d.endReason && d.endReason.includes('ì¬ë°°ì •')));
        }
        return false;
    });

    if(historyTab === 'contract') {
        if(currentUser.role === 'admin') { members.forEach(function(mem) { if(mem.role === 'admin') return; getVirtualShareEntries(mem.name).forEach(function(ve) { var parsed = parseDBDate(ve.contractDate); if(y !== 'all' && parsed.year != y) return; if(m !== 'all' && parsed.month != m) return; list.push(ve); }); }); }
        else { getVirtualShareEntries(currentUser.name).forEach(function(ve) { var parsed = parseDBDate(ve.contractDate); if(y !== 'all' && parsed.year != y) return; if(m !== 'all' && parsed.month != m) return; list.push(ve); }); }
    }

    if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ê¸°ë¡ ì—†ìŒ</td></tr>'; return; }
    
    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    list.forEach(function(d) { 
        var row = ''; 
        var companyDisplay = d.isVirtualShare ? '[' + d.originalMember + 'ì‰ì–´] ' + d.company : d.company; 
        var clickId = d.isVirtualShare ? d.originalId : d.id; 
        
        if(historyTab === 'admin-prospect' || historyTab === 'prospect') { 
            row = '<td>' + d.date + '</td><td>' + d.member + '</td><td style="font-weight:bold">' + companyDisplay + '</td><td style="color:blue">' + d.source + '</td><td><span class="badge status-prospect">' + d.status + '</span></td>'; 
        } else if(historyTab === 'contract') { 
            row = '<td>' + (d.contractDate || d.date) + '</td><td>' + d.member + '</td><td style="font-weight:bold">' + companyDisplay + '</td><td style="color:blue">' + d.source + '</td><td>' + (d.product||'-') + '</td><td style="color:blue">' + (d.amount||0).toLocaleString() + '</td>'; 
        } else if(historyTab === 'reassign') {
            // ì¬ë°°ì • í˜„í™© íƒ­ ë Œë”ë§ ë¡œì§
            var statBadge = d.status === 'ë°˜ë‚©ëŒ€ê¸°' ? '<span class="badge status-pending">ë°˜ë‚©ëŒ€ê¸°</span>' : '<span class="badge status-end">ì¢…ë£Œ(ì¬ë°°ì •ë¨)</span>';
            var resultStr = '<span style="color:#94a3b8">- ëŒ€ê¸°ì¤‘ -</span>';
            
            if (d.endReason) {
                if (d.endReason.includes('íŒ€ì›ìš”ì²­')) {
                    var target = d.endReason.split('->')[1] || '';
                    resultStr = '<span style="color:#8b5cf6; font-weight:bold;">[íŒ€ì›ìš”ì²­]</span> ' + target.replace(')','') + ' ë°°ì •ì™„ë£Œ';
                } else if (d.endReason.includes('SMì·¨í•©')) {
                    var target = d.endReason.split('->')[1] || '';
                    resultStr = '<span style="color:#ef4444; font-weight:bold;">[ê´€ë¦¬ì ê°•ì œ]</span> ' + target.replace(')','') + ' ë°°ì •ì™„ë£Œ';
                }
            }
            
            row = '<td>' + d.date + '</td><td>' + d.member + '</td><td style="font-weight:bold">' + companyDisplay + '</td><td style="color:blue">' + d.source + '</td><td>' + statBadge + '</td><td>' + resultStr + '</td>';
        }
        
        tbody.innerHTML += '<tr onclick="openModal(\'' + clickId + '\')">' + row + '</tr>'; 
    });
}

function renderAdminDashboard() {
    var now = new Date();
    var selectedMonth = document.getElementById('admin-stat-month').value;
    var targetYear = now.getFullYear();
    var isAllMonths = (selectedMonth === 'all');

    var monthlyDBByDate = dbList.filter(function(d) {
        var parsed = parseDBDate(d.date);
        if(parsed.year === 0) return isAllMonths; 
        if(parsed.year !== targetYear) return false;
        if(!isAllMonths && parsed.month !== parseInt(selectedMonth)) return false;
        return true;
    });
    var totalDB = monthlyDBByDate.length;

    var contracts = dbList.filter(function(d) {
        if(d.status !== 'ê³„ì•½') return false;
        var contractDate = getContractDate(d);
        var parsed = parseDBDate(contractDate);
        if(parsed.year !== targetYear) return false;
        if(!isAllMonths && parsed.month !== parseInt(selectedMonth)) return false;
        return true;
    });

    var totalRevenue = getTeamRevenue(contracts);
    var convRate = totalDB > 0 ? ((contracts.length / totalDB) * 100).toFixed(1) : 0;

    document.getElementById('ad-total-rev').innerText = totalRevenue.toLocaleString() + "ì›";
    document.getElementById('ad-total-cont').innerText = contracts.length + "ê±´";
    document.getElementById('ad-total-db').innerText = totalDB + "ê°œ";
    document.getElementById('ad-conv-rate').innerText = convRate + "%";

    var stats = {};
    var targetMonth = isAllMonths ? null : parseInt(selectedMonth);
    members.filter(function(m){return m.role !== 'admin';}).forEach(function(m) {
        var ownRev = contracts.filter(function(d){return d.member === m.name;}).reduce(function(a,c){return a + (parseInt(String(c.amount).replace(/,/g,''))||0);}, 0);
        var shareRev = getShareRevenue(m.name, targetYear, targetMonth);
        stats[m.name] = ownRev + shareRev;
    });

    var sorted = Object.entries(stats).sort(function(a,b){return b[1] - a[1];});
    var r500 = sorted.filter(function(x){return x[1] >= 5000000;});
    var r300 = sorted.filter(function(x){return x[1] >= 3000000 && x[1] < 5000000;});
    var r60 = sorted.filter(function(x){return x[1] >= 600000 && x[1] < 3000000;});
    function fillList(id, arr) { var el = document.getElementById(id); el.innerHTML = ''; if(arr.length === 0) el.innerHTML = '<li style="padding:10px; color:#999; text-align:center;">ë‹¬ì„±ì ì—†ìŒ</li>'; arr.forEach(function(x) { el.innerHTML += '<li class="rank-item"><span>' + x[0] + '</span> <span class="rank-val">' + x[1].toLocaleString() + '</span></li>'; }); }
    fillList('rank-500', r500); fillList('rank-300', r300); fillList('rank-60', r60);

    var tbody = document.getElementById('team-status-body');
    tbody.innerHTML = '';

    var teamStats = members.filter(function(m){return m.role !== 'admin';}).map(function(m) {
        var myDataByDate = monthlyDBByDate.filter(function(d){return d.member === m.name;});
        var dbCount = myDataByDate.length;
        var meetCount = myDataByDate.filter(function(d){return d.meetDate;}).length;
        var prospectCount = myDataByDate.filter(function(d){return d.status === 'ê°€ë§ê³ ê°';}).length;
        var myContracts = contracts.filter(function(d){return d.member === m.name;});
        var contCount = myContracts.length;
        var rev = myContracts.reduce(function(a,c){return a + (parseInt(String(c.amount).replace(/,/g,''))||0);}, 0);
        var shareRev = getShareRevenue(m.name, targetYear, targetMonth);
        var shareCnt = getShareContractCount(m.name, targetYear, targetMonth);
        rev += shareRev;
        contCount += shareCnt;
        var rate = dbCount > 0 ? Math.round((contCount/dbCount)*100) : 0;
        return { name: m.name, db: dbCount, meet: meetCount, prospect: prospectCount, cont: contCount, rev: rev, rate: rate, isSpecial: false };
    });

    ['SM', 'ì¶”ì¥í˜¸'].forEach(function(sp) {
        var spRev = getSpecialPartnerRevenue(sp, targetYear, targetMonth);
        if(spRev > 0 || true) { 
            var icon = sp === 'SM' ? 'ğŸ—£ï¸' : 'ğŸ¯';
            teamStats.push({ name: icon + ' ' + sp, db: '-', meet: '-', prospect: '-', cont: '-', rev: spRev, rate: '-', isSpecial: true });
        }
    });

    teamStats.sort(function(a,b) {
        if(a.isSpecial !== b.isSpecial) return a.isSpecial ? 1 : -1;
        return b.rev - a.rev;
    });

    var maxRev = 1;
    teamStats.forEach(function(s){ if(!s.isSpecial && s.rev > maxRev) maxRev = s.rev; });
    var normalRank = 0;

    teamStats.forEach(function(s) {
        var barWidth = s.isSpecial ? Math.max(5, (s.rev / maxRev) * 100) : Math.max(5, (s.rev / maxRev) * 100);
        if(s.isSpecial) {
            tbody.innerHTML += '<tr style="background:#fffbeb; border-top:2px solid #fcd34d;"><td style="font-weight:bold;">-</td><td style="font-weight:bold;">' + s.name + '</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td><div style="font-weight:bold; color:#c2410c;">' + s.rev.toLocaleString() + '</div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:' + barWidth + '%; background:#f59e0b;"></div></div></td><td>-</td></tr>';
        } else {
            normalRank++;
            tbody.innerHTML += '<tr><td style="font-weight:bold;">' + normalRank + '</td><td style="cursor:pointer; color:#2563eb; text-decoration:underline;" onclick="goToMemberDB(\'' + s.name + '\')" title="'+s.name+' DB ë³´ê¸°">' + s.name + '</td><td>' + s.db + '</td><td>' + s.meet + '</td><td style="color:var(--prospect); font-weight:bold;">' + s.prospect + '</td><td style="color:#10b981; font-weight:bold;">' + s.cont + '</td><td>' + s.rate + '%</td><td><div style="font-weight:bold; color:var(--primary);">' + s.rev.toLocaleString() + '</div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:' + barWidth + '%"></div></div></td><td>' + (s.rev >= 5000000 ? 'ğŸ”¥' : '-') + '</td></tr>';
        }
    });
}

function openModal(id) {
    document.getElementById('modal').style.display='flex'; currentId=id||null; isAdminLogAdded=false; isModalDirty = false;
    var consult=document.getElementById('input-consulting'); var phoneIssue=document.getElementById('input-phone-issue');
    
    var reqArea = document.getElementById('reassign-req-area');
    var adminPanel = document.getElementById('admin-reassign-panel');
    var targetSel = document.getElementById('admin-reassign-target');
    reqArea.style.display = 'none';
    adminPanel.style.display = 'none';

    if(currentId) {
        var d=dbList.find(function(x){return x.id==id;}); if(!d) { showToast('í•´ë‹¹ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); document.getElementById('modal').style.display='none'; return; }
        if(currentUser.role!=='admin'&&d.hasAdminAlert) { d.hasAdminAlert=false; renderList(); }
        
        // â˜… ìˆ˜ì •: ê¶Œí•œ/ìƒíƒœë³„ íŒ¨ë„ í‘œì‹œ (ì¢…ë£Œê±´ë„ ì—´ë¦¬ë„ë¡ ì œí•œ í•´ì œ)
        if(currentUser.role === 'admin') {
            adminPanel.style.display = 'block';
            targetSel.innerHTML = '<option value="">ì¬ë°°ì •í•  íŒ€ì› ì„ íƒ</option>';
            members.forEach(function(m) {
                if(m.role !== 'admin' && m.name !== d.member) {
                    targetSel.innerHTML += '<option value="' + m.name + '">' + m.name + ' íŒ€ì¥</option>';
                }
            });
        } else if(d.member === currentUser.name && d.status !== 'ê³„ì•½') {
            // íŒ€ì›ì˜ ê²½ìš°ì—ë„ 'ê³„ì•½'ë§Œ ì•„ë‹ˆë©´(ì¢…ë£Œê±´ í¬í•¨) ìš”ì²­ ë²„íŠ¼ í‘œì‹œ
            reqArea.style.display = 'block';
        }

        document.getElementById('edit-id').value=d.id; document.getElementById('display-member').innerText=d.member;
        document.getElementById('input-date').value=d.date; document.getElementById('input-source').value=d.source;
        document.getElementById('input-grade-prov').value=d.gradeProv||'A'; document.getElementById('input-company').value=d.company;
        document.getElementById('input-ceo').value=d.ceo||''; document.getElementById('input-phone').value=d.phone||'';
        document.getElementById('input-industry').value=d.industry||''; document.getElementById('input-revenue').value=d.revenue||'ë¯¸í™•ì¸';
        document.getElementById('input-call-status').value=d.callStatus||''; document.getElementById('input-credit').value=d.credit||'';
        document.getElementById('input-annual-rev').value=d.annualRev?d.annualRev.toLocaleString():'';
        document.getElementById('input-tax').value=d.tax||'ì™„ë‚©'; document.getElementById('input-region').value=d.region||'';
        document.getElementById('input-meet-date').value=d.meetDate||''; document.getElementById('input-status').value=d.status;
        document.getElementById('input-wait-reason').value=d.waitReason||''; document.getElementById('input-ing-detail').value=d.ingDetail||'';
        document.getElementById('input-prospect-detail').value=d.prospectDetail||''; document.getElementById('input-end-reason').value=d.endReason||'';
        document.getElementById('input-contract-date').value=d.contractDate||''; document.getElementById('input-product').value=d.product||'';
        document.getElementById('input-amount').value=d.totalAmount?d.totalAmount.toLocaleString():'';
        consult.value=d.consulting||''; phoneIssue.value=d.phoneIssue||'';
        
        updateShareFields();
        if(d.shareList && Array.isArray(d.shareList)) { 
            d.shareList.forEach(function(s, i) { 
                if(i<3) { 
                    document.getElementById('share-partner-' + (i+1)).value = s.partner; 
                    document.getElementById('share-percent-' + (i+1)).value = s.percent; 
                } 
            }); 
        }
        calculateShare();
        tempLogs=d.logs||[]; tempRoadmap=d.roadmap||[];
    } else {
        document.getElementById('edit-id').value=''; document.getElementById('display-member').innerText=currentUser.name;
        document.getElementById('input-date').valueAsDate=new Date(); document.getElementById('input-source').value='íšŒì‚¬DB';
        document.getElementById('input-grade-prov').value='A'; document.getElementById('input-company').value='';
        document.getElementById('input-ceo').value=''; document.getElementById('input-phone').value='';
        document.getElementById('input-industry').value=''; document.getElementById('input-revenue').value='ë¯¸í™•ì¸';
        document.getElementById('input-call-status').value=''; document.getElementById('input-credit').value='';
        document.getElementById('input-annual-rev').value=''; document.getElementById('input-tax').value='ì™„ë‚©';
        document.getElementById('input-region').value=''; document.getElementById('input-meet-date').value='';
        document.getElementById('input-status').value='ëŒ€ê¸°'; document.getElementById('input-wait-reason').value='';
        document.getElementById('input-ing-detail').value=''; document.getElementById('input-prospect-detail').value='';
        document.getElementById('input-end-reason').value=''; document.getElementById('input-contract-date').value='';
        document.getElementById('input-product').value=''; document.getElementById('input-amount').value='';
        consult.value=''; phoneIssue.value='';
        [1,2,3].forEach(function(i){ document.getElementById('share-partner-' + i).value=''; document.getElementById('share-percent-' + i).value=''; document.getElementById('share-val-' + i).innerText='0'; });
        updateShareFields(); calculateShare(); tempLogs=[]; tempRoadmap=[];
    }
    
    toggleGradeField(); 
    toggleStatusFields(true); 
    renderLogs();
    
    if(currentId) { var dd=dbList.find(function(x){return x.id==currentId}); updateModalSummaryCard(dd); } 
    else { updateModalSummaryCard(null); }
    setTimeout(function() { isModalDirty = false; }, 100);
}

function closeModal() { 
    if(isModalDirty) { 
        if(!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤.\nì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
            document.getElementById('modal').style.display='none'; 
            isModalDirty = false; 
            return;
        } else { 
            saveData(true); 
            return; 
        } 
    } 
    document.getElementById('modal').style.display='none'; 
}

function logout() { localStorage.removeItem('last_login_id'); localStorage.removeItem('last_login_pw'); location.reload(); }
function addLog() { var t=document.getElementById('hist-input').value; if(t) { tempLogs.unshift({time:new Date().toLocaleString(), text:t, writer:currentUser.name}); renderLogs(); document.getElementById('hist-input').value=''; if(currentUser.role==='admin') isAdminLogAdded=true; isModalDirty = true; } }
function renderLogs() { document.getElementById('log-list').innerHTML=tempLogs.map(function(l){return '<div style="font-size:12px;border-bottom:1px solid #eee;padding:5px;">[' + l.time + '] <b>' + l.writer + '</b>: ' + l.text + '</div>';}).join(''); }

function saveData(shouldCloseModal) {
    if(!GAS_URL) return alert('URL ì˜¤ë¥˜');
    var companyVal = document.getElementById('input-company').value.trim();
    
    if(!companyVal) {
        alert('ì—…ì²´ëª… í•„ìˆ˜ ê¸°ì…\n(ì—†ì„ ì‹œ ëŒ€í‘œìëª… ê¸°ì…)');
        document.getElementById('input-company').focus();
        return; 
    }
    
    var id = document.getElementById('edit-id').value || Date.now();
    var total = parseInt(document.getElementById('input-amount').value.replace(/,/g,'')) || 0;
    var shareList = [], ded = 0;
    
    for(var i=1; i<=3; i++) {
        var partnerSel = document.getElementById('share-partner-' + i);
        var pctInput = document.getElementById('share-percent-' + i);
        var p = partnerSel.value || (partnerSel.options[partnerSel.selectedIndex] ? partnerSel.options[partnerSel.selectedIndex].value : '');
        var pct = parseInt(pctInput.value) || 0;
        if(p && pct > 0) { var amt = Math.floor(total * (pct / 100)); shareList.push({partner: p, percent: pct, amount: amt, step: i}); ded += amt; }
    }
    
    var ex = dbList.find(function(x){return x.id==id;}) || {};
    var newMeetDate = document.getElementById('input-meet-date').value;
    var newStatus = document.getElementById('input-status').value;
    var autoLog = '';
    
    if ((ex.meetDate || '') !== newMeetDate) {
        autoLog += "ë¯¸íŒ…ì¼ì •[" + (newMeetDate ? newMeetDate : 'ì·¨ì†Œë¨') + "] ";
    }
    if (ex.id && (ex.status || 'ëŒ€ê¸°') !== newStatus) {
        autoLog += "ì§„í–‰ìƒíƒœ[" + newStatus + "] ";
    }
    if (autoLog !== '') {
        tempLogs.unshift({time: new Date().toLocaleString(), text: "ğŸ¤– (ì‹œìŠ¤í…œ ìë™ê¸°ë¡) " + autoLog + "ë³€ê²½ë¨", writer: currentUser.name});
    }

    var consult = document.getElementById('input-consulting');
    var obj = { id:id, member:document.getElementById('display-member').innerText, date:document.getElementById('input-date').value, source:document.getElementById('input-source').value, gradeProv:document.getElementById('input-grade-prov').value, company:companyVal, ceo:document.getElementById('input-ceo').value, phone:document.getElementById('input-phone').value, industry:document.getElementById('input-industry').value, revenue:document.getElementById('input-revenue').value, callStatus:document.getElementById('input-call-status').value, credit:document.getElementById('input-credit').value, annualRev:parseInt(document.getElementById('input-annual-rev').value.replace(/,/g,''))||0, tax:document.getElementById('input-tax').value, region:document.getElementById('input-region').value, meetDate:newMeetDate, status:newStatus, waitReason:document.getElementById('input-wait-reason').value, ingDetail:document.getElementById('input-ing-detail').value, prospectDetail:document.getElementById('input-prospect-detail').value, endReason:document.getElementById('input-end-reason').value, contractDate:document.getElementById('input-contract-date').value, product:document.getElementById('input-product').value, totalAmount:total, amount:total-ded, shareList:shareList, consulting:consult.value, phoneIssue:document.getElementById('input-phone-issue').value, logs:tempLogs, roadmap:tempRoadmap, hasAdminAlert:(currentUser.role==='admin'&&isAdminLogAdded)?true:(ex.hasAdminAlert||false) };
    
    showLoading();
    fetch(GAS_URL, { method:'POST', body:JSON.stringify({action:'save', data:obj}) }).then(function(r){return r.json();}).then(function(d) { 
        hideLoading(); 
        showToast('ì €ì¥ ì™„ë£Œ'); 
        isModalDirty = false; 
        document.getElementById('edit-id').value = id; 
        
        if (shouldCloseModal === true) {
            document.getElementById('modal').style.display='none';
        }
        
        fetchDB(function() { 
            if(currentUser.role==='admin'&&document.getElementById('view-dashboard').style.display==='block') renderAdminDashboard(); 
            else renderList(); 
            checkMeetingAlerts(); 
            setupHistoryTabs(); // NEW ë±ƒì§€ ê°±ì‹ ìš©
        }); 
    }).catch(function(e) { hideLoading(); showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); });
}

function deleteData() { if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; var id=document.getElementById('edit-id').value; showLoading(); fetch(GAS_URL, { method:'POST', body:JSON.stringify({action:'delete', id:id}) }).then(function(r){return r.json();}).then(function(d){ hideLoading(); showToast('ì‚­ì œ ì™„ë£Œ'); document.getElementById('modal').style.display='none'; fetchDB(function(){renderList();}); }).catch(function(e){ hideLoading(); showToast('ì‹¤íŒ¨', 'error'); }); }
function printRoadmap() { var printArea = document.getElementById('roadmap-print-area'); var printWindow = window.open('', '_blank', 'width=1200,height=800'); var styleContent = '* { box-sizing: border-box; margin: 0; padding: 0; } body { font-family: -apple-system, sans-serif; margin: 30px; background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .rm-title-edit { font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 40px; color: #1e293b; } .rm-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; } .rm-header { background: #1e3a8a !important; color: white !important; padding: 12px 0; border: 1px solid #94a3b8; font-weight: bold; text-align: center; } .rm-subheader { background: #3b82f6 !important; color: white !important; padding: 6px 0; border: 1px solid #94a3b8; font-size: 11px; text-align: center; } .rm-cell { border: 1px solid #cbd5e1; height: 55px; position: relative; background: white; } .rm-cat-col { width: 120px; text-align: center; font-weight: 800; border: 1px solid #94a3b8; color: white !important; padding: 5px; } .rm-bar-container { position: absolute; top: 10px; bottom: 10px; border-radius: 15px; display:flex; align-items: center; color: white; font-size: 12px; font-weight: bold; } @media print { * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }'; printWindow.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ì»¨ì„¤íŒ… ë¡œë“œë§µ</title><style>' + styleContent + '</style></head><body>' + printArea.innerHTML + '</body></html>'); printWindow.document.close(); setTimeout(function() { printWindow.focus(); printWindow.print(); }, 500); }
function openRoadmapPopup() { document.getElementById('roadmap-modal').style.display = 'flex'; resetRoadmapInput(); var comp = document.getElementById('input-company').value.trim(); document.getElementById('print-company-name').innerText = comp ? comp + " Project Schedule" : "Project Schedule"; var mem = document.getElementById('display-member').innerText || "ë‹´ë‹¹ì"; document.getElementById('print-member-name').innerText = 'ì˜¤ë„ˆìŠ¤ê²½ì˜ì—°êµ¬ì†Œ - ' + mem + ' íŒ€ì¥'; renderRoadmapView(); }
function closeRoadmapPopup() { document.getElementById('roadmap-modal').style.display = 'none'; }
function saveRoadmap() { showToast('ë¡œë“œë§µì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); closeRoadmapPopup(); }
function initRoadmapInputs() { var startSel = document.getElementById('rm-start'); var endSel = document.getElementById('rm-end'); var presetDiv = document.getElementById('rm-presets'); presetDiv.innerHTML = ''; roadmapItems.forEach(function(item) { presetDiv.innerHTML += '<button class="btn-preset" onclick="setPresetName(\'' + item + '\')">' + item + '</button>'; }); startSel.innerHTML = ''; endSel.innerHTML = ''; var baseYear = new Date().getFullYear(); for(var y=0; y<5; y++) { for(var m=1; m<=12; m++) { var val = (y*12) + m; var label = (baseYear+y) + 'ë…„ ' + m + 'ì›”'; startSel.innerHTML += '<option value="' + val + '">' + label + '</option>'; endSel.innerHTML += '<option value="' + val + '">' + label + '</option>'; } } }
function setPresetName(name) { document.getElementById('rm-name').value = name; document.getElementById('rm-name').focus(); document.querySelectorAll('.btn-preset').forEach(function(btn){btn.classList.remove('active');}); event.target.classList.add('active'); }
function resetRoadmapInput() { initRoadmapInputs(); document.getElementById('rm-name').value = ''; document.getElementById('rm-start').value = 1; document.getElementById('rm-end').value = 1; document.getElementById('rm-desc').value = ''; document.getElementById('rm-align').value = 'center'; editIndex = -1; document.getElementById('btn-add-rm').innerHTML = '<i class="fa-solid fa-plus"></i> ì¶”ê°€'; document.getElementById('btn-cancel-rm').style.display = 'none'; document.getElementById('rm-input-box').classList.remove('edit-mode'); renderRoadmapView(); }
function addManualRoadmap() { var name = document.getElementById('rm-name').value; var start = parseInt(document.getElementById('rm-start').value); var end = parseInt(document.getElementById('rm-end').value); var desc = document.getElementById('rm-desc').value; var align = document.getElementById('rm-align').value; if(!name) return showToast("í•­ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", 'error'); if(end < start) return showToast("ì¢…ë£Œ ì‹œì  ì˜¤ë¥˜", 'error'); var duration = end - start + 1; var newItem = { name: name, start: start, duration: duration, desc: desc, align: align }; if(editIndex > -1) tempRoadmap[editIndex] = newItem; else tempRoadmap.push(newItem); resetRoadmapInput(); }
function loadRoadmapItemForEdit(idx) { if(isDragging) return; if(!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; var item = tempRoadmap[idx]; document.getElementById('rm-name').value = item.name; document.getElementById('rm-start').value = item.start; document.getElementById('rm-end').value = item.start + item.duration - 1; document.getElementById('rm-desc').value = item.desc || ''; document.getElementById('rm-align').value = item.align || 'center'; editIndex = idx; document.getElementById('btn-add-rm').innerHTML = '<i class="fa-solid fa-check"></i> ìˆ˜ì •'; document.getElementById('btn-cancel-rm').style.display = 'block'; document.getElementById('rm-input-box').classList.add('edit-mode'); }
function removeRoadmapItem(idx) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { tempRoadmap.splice(idx, 1); if(editIndex===idx) resetRoadmapInput(); else if(editIndex>idx) editIndex--; renderRoadmapView(); } }
function handleDragStart(e, idx) { isDragging = true; dragSrcIndex = idx; dragSrcEl = e.target; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
function handleDragOver(e) { if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; var t=e.target.closest('.rm-item-chip'); if(t&&t!==dragSrcEl) { document.querySelectorAll('.rm-item-chip').forEach(function(el){el.classList.remove('drag-over');}); t.classList.add('drag-over'); } return false; }
function handleDragLeave(e) { var t=e.target.closest('.rm-item-chip'); if(t) t.classList.remove('drag-over'); }
function handleDrop(e, dropIndex) { if(e.stopPropagation) e.stopPropagation(); if(dragSrcIndex!==dropIndex) { var item=tempRoadmap[dragSrcIndex]; tempRoadmap.splice(dragSrcIndex,1); tempRoadmap.splice(dropIndex,0,item); resetRoadmapInput(); renderRoadmapView(); } return false; }
function handleDragEnd(e) { document.querySelectorAll('.rm-item-chip').forEach(function(el){el.classList.remove('dragging'); el.classList.remove('drag-over');}); setTimeout(function() { isDragging = false; }, 100); }
function renderRoadmapView() { var tbody = document.getElementById('rm-body'); var listDiv = document.getElementById('rm-list'); var h1 = document.getElementById('rm-header-row-1'); var h2 = document.getElementById('rm-header-row-2'); tbody.innerHTML=''; listDiv.innerHTML=''; var maxMonth=12; tempRoadmap.forEach(function(i){if(i.start+i.duration-1>maxMonth) maxMonth=i.start+i.duration-1;}); var years=Math.ceil(maxMonth/12); var baseYear=new Date().getFullYear(); var hh1='<th class="rm-header rm-diagonal" style="width:120px;" rowspan="2"><span class="rm-diagonal-text rm-text-bottom-left">í•­ëª©</span><span class="rm-diagonal-text rm-text-top-right">ì¼ì •</span></th>'; var hh2=''; for(var y=0; y<years; y++) { hh1+='<th class="rm-header" colspan="12">' + (baseYear+y) + '</th>'; for(var m=1; m<=12; m++) hh2+='<th class="rm-subheader">' + m + '</th>'; } h1.innerHTML=hh1; h2.innerHTML=hh2; if(tempRoadmap.length===0) listDiv.innerHTML='<div style="text-align:center;color:#94a3b8;font-size:12px;">í•­ëª© ì—†ìŒ</div>'; else tempRoadmap.forEach(function(item,idx){ var chip=document.createElement('div'); chip.className='rm-item-chip'; chip.draggable=true; chip.innerHTML='<i class="fa-solid fa-grip-vertical" style="color:#94a3b8;margin-right:5px;"></i><span style="font-weight:bold;color:#334155;">' + item.name + '</span><i class="fa-solid fa-xmark" style="color:#ef4444;margin-left:8px;cursor:pointer;"></i>'; chip.addEventListener('dragstart',function(e){handleDragStart(e,idx);}); chip.addEventListener('dragover',handleDragOver); chip.addEventListener('dragleave',handleDragLeave); chip.addEventListener('drop',function(e){handleDrop(e,idx);}); chip.addEventListener('dragend',handleDragEnd); chip.onclick=function(){loadRoadmapItemForEdit(idx);}; chip.querySelector('.fa-xmark').onclick=function(e){e.stopPropagation(); removeRoadmapItem(idx);}; listDiv.appendChild(chip); }); if(tempRoadmap.length===0) { tbody.innerHTML='<tr><td colspan="' + (1+(years*12)) + '" style="text-align:center;padding:20px;color:#cbd5e1;">ë¹„ì–´ìˆìŒ</td></tr>'; return; } tempRoadmap.forEach(function(item,idx){ var tr='<tr>'; var cHex=colorPalette[Math.min(idx,5)]; var tCol=(Math.min(idx,5)>=5)?'#1e293b':'white'; tr+='<td class="rm-cat-col" onclick="loadRoadmapItemForEdit(' + idx + ')" style="background:' + cHex + ';color:' + tCol + ';cursor:pointer;">' + item.name + '</td>'; var cols=years*12; for(var i=1; i<=cols; i++) { if(i===item.start) { var desc=item.desc?item.desc.replace(/\/\//g,'<br>'):''; var align=item.align||'center'; var cont=''; if(align==='out') { cont='<div class="rm-bar-container" style="width:100%;background:' + cHex + ';"></div><div class="rm-bar-outer-text">' + desc + '</div>'; } else { cont='<div class="rm-bar-container rm-align-' + align + '" style="width:100%;background:' + cHex + ';color:' + tCol + ';">' + desc + '</div>'; } tr+='<td class="rm-cell" colspan="' + item.duration + '" onclick="loadRoadmapItemForEdit(' + idx + ')">' + cont + '</td>'; i+=(item.duration-1); } else { tr+='<td class="rm-cell"></td>'; } } tr+='</tr>'; tbody.innerHTML+=tr; }); }    
